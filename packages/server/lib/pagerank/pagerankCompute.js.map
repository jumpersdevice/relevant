{"version":3,"sources":["../../src/pagerank/pagerankCompute.js"],"names":["computePageRank","params","debug","communityId","community","Error","heapUsed","process","memoryUsage","mb","Math","round","console","log","now","Date","admins","CommunityMember","find","role","usersWithDefaultWeight","defaultWeight","$gt","comObj","Community","findOne","_id","votes","getVotes","personalization","tranformedAdmins","map","a","userId","embeddedUser","customAdminWeight","relevance","nodes","postNodes","Graph","usersWithDefault","u","getTime","scores","timeLimit","setFullYear","getFullYear","REP_CUTOFF","Invest","createdAt","ownPost","$ne","investor","$exists","populate","path","select","match"],"mappings":"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","sourcesContent":["import Invest from 'server/api/invest/invest.model';\nimport CommunityMember from 'server/api/community/community.member.model';\nimport Community from 'server/api/community/community.model';\nimport { REP_CUTOFF } from 'server/config/globalConstants';\nimport pagerank from './pagerank';\nimport Graph from './graph';\nimport { handleResults } from './handleResults';\n\n/* eslint no-console: 0 */\n\nexport default async function computePageRank(params) {\n  const { debug, communityId, community } = params;\n\n  if (!community) throw new Error('missing community name');\n\n  let { heapUsed } = process.memoryUsage();\n  let mb = Math.round((100 * heapUsed) / 1048576) / 100;\n  debug && console.log('Init PR is using ' + mb + 'MB of Heap.');\n\n  const now = new Date();\n\n  const admins = await CommunityMember.find(\n    { role: 'admin', communityId },\n    'embeddedUser defaultWeight customAdminWeight pagerank pagerankRaw pagerankRawNeg'\n  );\n\n  const usersWithDefaultWeight = await CommunityMember.find(\n    { role: 'user', communityId, defaultWeight: { $gt: 0 } },\n    'embeddedUser customAdminWeight defaultWeight pagerank pagerankRaw pagerankRawNeg'\n  );\n\n  const comObj = await Community.findOne(\n    { _id: communityId },\n    'danglingConsumer negConsumer'\n  );\n\n  const votes = await getVotes(communityId);\n\n  const personalization = {};\n\n  const tranformedAdmins = admins.map(a => {\n    const userId = a.embeddedUser._id;\n    personalization[userId] = a.customAdminWeight || 1;\n    return { ...a.embeddedUser, relevance: a };\n  });\n\n  const { nodes, postNodes } = new Graph({\n    votes,\n    admins: tranformedAdmins,\n    community: comObj,\n    usersWithDefault: usersWithDefaultWeight.map(u => ({\n      ...u.embeddedUser,\n      relevance: u\n    }))\n  });\n\n  if (debug) {\n    heapUsed = process.memoryUsage().heapUsed;\n    mb = Math.round((100 * heapUsed) / 1048576) / 100;\n    console.log('Before PR - using ' + mb + 'MB of Heap.');\n    console.log('user query time ', (new Date().getTime() - now) / 1000 + 's');\n  }\n\n  const scores = pagerank(nodes, {\n    personalization,\n    debug\n  });\n\n  if (debug) {\n    heapUsed = process.memoryUsage().heapUsed;\n    mb = Math.round((100 * heapUsed) / 1048576) / 100;\n    debug && console.log('After PR is using ' + mb + 'MB of Heap.');\n  }\n  await handleResults({ scores, nodes, communityId, debug, postNodes });\n}\n\nasync function getVotes(communityId) {\n  // only look at votes up to a REP_CUTOFF years ago\n  const timeLimit = new Date().setFullYear(new Date().getFullYear() - REP_CUTOFF);\n\n  return Invest.find({\n    communityId,\n    createdAt: { $gt: timeLimit },\n    ownPost: { $ne: true },\n    investor: { $exists: true }\n  })\n    .populate({\n      path: 'investor',\n      select: 'handle',\n      populate: {\n        path: 'relevance',\n        match: { communityId },\n        select: 'pagerank pagerankRaw pagerankRawNeg'\n      }\n    })\n    .populate({\n      path: 'author',\n      select: 'handle',\n      populate: {\n        path: 'relevance',\n        match: { communityId },\n        select: 'pagerank pagerankRaw pagerankRawNeg'\n      }\n    })\n    .populate({\n      path: 'post',\n      select: 'title',\n      populate: {\n        path: 'data',\n        select: 'pagerank pagerankRaw pagerankRawNeg body needsRankUpdate'\n      }\n    });\n}\n"],"file":"pagerankCompute.js"}