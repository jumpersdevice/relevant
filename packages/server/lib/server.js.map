{"version":3,"sources":["../src/server.js"],"names":["bodyParser","require","mongoose","cookieParser","session","favicon","MongoStore","cookiesMiddleware","path","expressStaticGzip","app","Express","Promise","global","validateTokenLenient","verify","limiter","windowMs","max","console","log","process","env","NODE_ENV","EventEmitter","prototype","_maxListeners","isDevelopment","relevantEnv","RELEVANT_ENV","webpack","webpackDevMiddleware","webpackHotMiddleware","webpackConfig","compiler","use","publicPath","output","writeToDisk","filePath","test","urlencoded","extended","json","join","__dirname","db","secret","SESSION_SECRET","resave","saveUninitialized","cookie","maxAge","store","mongooseConnection","connection","autoRemove","autoRemoveInterval","touchAfter","clear_interval","passport","initialize","requireHTTPS","req","res","next","headers","redirect","get","url","NO_SSL","resolve","replace","index","port","PORT","WEB_CONCURRENCY","server","ApolloServer","schema","playground","context","user","applyMiddleware","socketServer","default","listen","error","info","now","Date","time","getTime","pingTimeout","SubscriptionServer","create","onOperation","message","params","token","payload","err","execute","subscribe","keepAlive","init","exports"],"mappings":"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","sourcesContent":["/* eslint-disable no-console, no-use-before-define */\nimport 'dotenv/config';\nimport 'sqreen';\nimport Express from 'express';\nimport morgan from 'morgan';\nimport passport from 'passport';\nimport { ApolloServer } from 'apollo-server-express';\nimport schema from 'server/graphql/schema';\nimport rateLimit from 'express-rate-limit';\n\nimport { SubscriptionServer } from 'subscriptions-transport-ws';\nimport { execute, subscribe } from 'graphql';\n\nconst bodyParser = require('body-parser');\nconst mongoose = require('mongoose');\nconst cookieParser = require('cookie-parser');\nconst session = require('express-session');\nconst favicon = require('serve-favicon');\nconst MongoStore = require('connect-mongo')(session);\nconst cookiesMiddleware = require('universal-cookie-express');\nconst path = require('path');\nconst expressStaticGzip = require('express-static-gzip');\n\nconst app = new Express();\nmongoose.Promise = global.Promise;\n\nconst { validateTokenLenient, verify } = require('server/auth/auth.service');\n\nconst limiter = rateLimit({\n  windowMs: 1 * 60 * 1000, // 1 minute\n  max: 1000 // limit each IP to 1000 requests per windowMs\n});\n\nconsole.log('NODE_ENV', process.env.NODE_ENV);\n\nrequire('events').EventEmitter.prototype._maxListeners = 100;\n\n// -------------Dev server watch and hot reload---------------\nconst isDevelopment =\n  process.env.NODE_ENV !== 'production' &&\n  process.env.NODE_ENV !== 'test' &&\n  process.env.NODE_ENV !== 'native';\n\nconst relevantEnv = process.env.RELEVANT_ENV;\n\nif (isDevelopment) {\n  console.log('in development environment');\n  const webpack = require('webpack');\n  const webpackDevMiddleware = require('webpack-dev-middleware');\n  const webpackHotMiddleware = require('webpack-hot-middleware');\n  const webpackConfig = require('@r3l/app/webpack.config');\n  // Use this middleware to set up hot module reloading via webpack.\n  const compiler = webpack(webpackConfig);\n  app.use(\n    webpackDevMiddleware(compiler, {\n      // noInfo: true,\n      publicPath: webpackConfig.output.publicPath,\n      writeToDisk: filePath => /loadable-stats-dev\\.json$/.test(filePath)\n    })\n  );\n  app.use(webpackHotMiddleware(compiler));\n}\n\napp.use(limiter);\napp.use(bodyParser.urlencoded({ extended: false }));\napp.use(bodyParser.json());\napp.use(cookieParser());\napp.use(favicon(path.join(__dirname, '../favicon.ico')));\n\n// Connect to db\nconst { db } = require('./config/db.connect');\n\n// Persist sessions with MongoStore\n// We need to enable sessions for passport twitter because its an oauth 1.0 strategy\napp.use(\n  session({\n    secret: process.env.SESSION_SECRET,\n    resave: false,\n    saveUninitialized: false,\n    cookie: { maxAge: 14 * 24 * 60 * 60 * 1000 },\n    store: new MongoStore({\n      mongooseConnection: mongoose.connection,\n      autoRemove: 'interval',\n      autoRemoveInterval: 10, // In minutes. Default\n      touchAfter: 24 * 3600, // time period in seconds\n      clear_interval: 3600\n    })\n  })\n);\n\napp.use(passport.initialize());\napp.use(passport.session());\n\nfunction requireHTTPS(req, res, next) {\n  if (\n    req.headers['x-forwarded-proto'] !== 'https' &&\n    process.env.NODE_ENV === 'production'\n  ) {\n    return res.redirect('https://' + req.get('host') + req.url);\n  }\n  return next();\n}\n\nif (process.env.NO_SSL !== 'true') {\n  app.use(requireHTTPS);\n}\n\n// public folder\nconsole.log(\n  'public path',\n  require.resolve('@r3l/app/public/service-worker').replace('/service-worker.js', '')\n);\napp.use(\n  '/',\n  expressStaticGzip(\n    require.resolve('@r3l/app/public/service-worker').replace('/service-worker.js', ''),\n    { index: false }\n  )\n);\napp.use(cookiesMiddleware());\napp.use(morgan('short'));\n\nconst port = process.env.PORT || 3000;\n\nconsole.log('WEB CONCURRENCY ', process.env.WEB_CONCURRENCY);\n\nlet server = new ApolloServer({\n  schema,\n  playground: process.env.NODE_ENV !== 'production',\n  context: ({ req, connection }) =>\n    connection ? connection.context : { user: req.user || {} }\n});\n\napp.use('/graphql', validateTokenLenient);\nserver.applyMiddleware({ app });\n\nconst socketServer = require('./socket').default;\n\nserver = app.listen({ port }, error => {\n  if (error) {\n    console.error(error);\n  } else {\n    console.info(\n      `==> ðŸŒŽ  Listening on port ${port}. Open up http://localhost:${port}/ in your browser.`\n    );\n    const now = new Date();\n    require('./routes')(app);\n    const time = new Date().getTime() - now.getTime();\n    console.log('done loading routes', time / 1000, 's');\n  }\n});\nsocketServer(server, { pingTimeout: 30000 });\n\nSubscriptionServer.create(\n  {\n    onOperation: async (message, params) => {\n      const { token } = message.payload;\n      let user;\n      try {\n        user = await verify(token);\n      } catch (err) {\n        // console.log(err);\n      }\n      return {\n        ...params,\n        context: {\n          ...params.context,\n          user\n        }\n      };\n    },\n    execute,\n    subscribe,\n    schema,\n    keepAlive: 10000\n  },\n  {\n    server,\n    path: '/graphql'\n  }\n);\n\nsocketServer(server, { pingTimeout: 30000 });\n\n// in production this is a worker\nif (relevantEnv === 'staging' || isDevelopment || process.env.NODE_ENV === 'native') {\n  require('./queue');\n}\n\nrequire('./utils/tokenAudit');\nrequire('./utils/ethereum').init();\n// require('./utils/dbMigrate-v1.1.1');\n\nexports.app = app;\nexports.server = server;\nexports.db = db;\n"],"file":"server.js"}