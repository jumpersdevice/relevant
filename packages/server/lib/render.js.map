{"version":3,"sources":["../src/render.js"],"names":["NODE_ENV","process","env","sheet","ServerStyleSheet","statsFileName","statsFile","extractor","ChunkExtractor","entrypoints","initStore","configureStore","createInitialState","handleRender","req","res","store","community","getState","auth","url","redirect","user","dispatch","fullUrl","protocol","get","originalUrl","handleRouteData","app","rnWebStyles","renderApp","html","renderFullPage","initialState","send","err","console","log","cachedCommunity","userAgent","headers","useragent","parse","width","isMobile","Dimensions","set","window","confirmed","params","navigation","navState","screenSize","cssStyleTags","styledComponentsTags","getStyleTags","meta","fetchMeta","scriptTags","getScriptTags","description","title","image","type","JSON","stringify","client","extract","defaultMeta","feed","postId","commentId","postMeta","getPostMeta","communityMeta","getCommunityMeta","Object","keys","forEach","key","posts","post","comment","userImage","embeddedUser","userComment","name","body","linkData","metaPost","links","communityState","communities","branch","routes","promises","map","route","match","fetchData","component","Function","Promise","resolve","all","context","nonce","Date","getTime","App","AppRegistry","registerComponent","instance","getStyleElement","getApplication"],"mappings":"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","sourcesContent":["import React from 'react';\nimport { renderToString, renderToStaticMarkup } from 'react-dom/server';\nimport { StaticRouter } from 'react-router';\nimport { matchRoutes, renderRoutes } from 'react-router-config';\nimport { compose } from 'redux';\nimport { Provider } from 'react-redux';\nimport { setUser, setCommunity } from 'app/modules/auth/auth.actions';\nimport routes from 'app/modules/_app/web/routes';\nimport configureStore from 'app/core/web/configureStore';\nimport { ServerStyleSheet, StyleSheetManager } from 'styled-components';\nimport { AppRegistry, Dimensions } from 'react-native-web';\nimport useragent from 'express-useragent';\nimport { getScreenSize } from 'app/utils/nav';\nimport { client } from 'server/apollo.client.server';\nimport { ApolloProvider } from '@apollo/react-common';\nimport { initialState as navState } from 'app/modules/navigation/navigation.reducer';\n\nimport { ChunkExtractor, ChunkExtractorManager } from '@loadable/server';\n\nconst { NODE_ENV } = process.env;\nconst sheet = new ServerStyleSheet();\n\nconst statsFileName =\n  NODE_ENV !== 'development' ? 'loadable-stats' : 'loadable-stats-dev';\nconst statsFile = `@r3l/app/public/dist/${statsFileName}.json`;\n\n// This is the stats file generated by webpack loadable plugin\n// We create an extractor from the statsFile\nlet extractor =\n  NODE_ENV !== 'development'\n    ? new ChunkExtractor({ statsFile, entrypoints: 'app' })\n    : null;\n\nexport const initStore = compose(configureStore, createInitialState);\n\nexport default async function handleRender(req, res) {\n  const store = initStore(req);\n  const { community } = store.getState().auth;\n  if (community && req.url === '/') return res.redirect(`/${community}/new`);\n\n  // and populate user store with req.user\n  if (req.user) store.dispatch(setUser(req.user));\n  if (community) store.dispatch(setCommunity(community));\n\n  const fullUrl = req.protocol + '://' + req.get('host') + req.originalUrl;\n\n  try {\n    await handleRouteData({ req, store });\n    const { app, rnWebStyles } = renderApp({ url: req.url, store });\n\n    const html = renderFullPage({\n      app,\n      fullUrl,\n      rnWebStyles,\n      initialState: store.getState(),\n      req\n    });\n\n    // global.gc();\n    // const { heapUsed } = process.memoryUsage();\n    // const mb = Math.round((100 * heapUsed) / 1048576) / 100;\n    // console.log('Program is using', mb, 'MB of Heap.');\n\n    return res.send(html);\n  } catch (err) {\n    console.log('RENDER ERROR', err); // eslint-disable-line\n    return res.send(renderFullPage({ initialState: store.getState(), fullUrl, req }));\n  }\n}\n\nexport function createInitialState(req) {\n  const cachedCommunity = req.user ? req.user.community : null;\n\n  const userAgent = req.headers['user-agent']\n    ? useragent.parse(req.headers['user-agent'])\n    : {};\n  const width = userAgent.isMobile ? 320 : 1000;\n  Dimensions.set({ window: { width } });\n\n  return {\n    auth: {\n      user: req.user,\n      confirmed: req.confirmed || (req.user && req.user.confirmed),\n      // TODO - get this from req.user\n      community: req.params.community || cachedCommunity\n    },\n    navigation: {\n      ...navState,\n      width,\n      screenSize: getScreenSize(width)\n    }\n  };\n}\n\nexport function renderFullPage({ app, rnWebStyles, initialState, fullUrl, req }) {\n  let cssStyleTags = '';\n  let styledComponentsTags = '';\n\n  // load extracted styles in head when in production\n  if (NODE_ENV === 'development') {\n    extractor = new ChunkExtractor({ statsFile, entrypoints: 'app' });\n  } else {\n    styledComponentsTags = sheet.getStyleTags();\n    cssStyleTags = extractor.getStyleTags();\n  }\n  const meta = fetchMeta({ initialState, req });\n\n  const scriptTags = extractor.getScriptTags();\n\n  return `<!doctype html>\n    <html>\n      <head>\n        <meta name=\"viewport\" content=\"width=device-width, initial-scale=1, maximum-scale=1\">\n\n        <title>Relevant: The Only Social Network Built On Trust</title>\n        <link rel=\"icon\" href=\"https://relevant.community/favicon.ico?v=2\" />\n        <meta name=\"description\" content=\"${meta.description}\" />\n        <meta property=\"og:description\" content=\"${meta.description}\" />\n        <meta property=\"og:title\" content=\"${meta.title}\" />\n        <meta property=\"og:url\" content=\"${meta.url}\" />\n        <meta property=\"og:image\" content=\"${meta.image}\" />\n\n        <meta name=\"twitter:card\" content=\"${meta.type}\" />\n        <meta name=\"twitter:site\" content=\"@relevantfeed\" />\n        <meta name=\"twitter:title\" content=\"${meta.title}\" />\n        <meta name=\"twitter:description\" content=\"${meta.description}\" />\n        ${meta.image ? `<meta name=\"twitter:image\" content=\"${meta.image}\" />` : ''}\n\n        <meta name=\"apple-itunes-app\" content=\"app-id=1173025051 app-argument=${fullUrl}\">\n\n        <meta name=\"google-play-app\" content=\"app-id=com.relevantnative\">\n        <link rel=\"apple-touch-icon\" href=\"/img/RoundedIcon.png\">\n        <link rel=\"android-touch-icon\" href=\"/img/RoundedIcon.png\">\n\n        ${rnWebStyles}\n        ${cssStyleTags}\n        ${styledComponentsTags}\n\n        <script type=\"text/javascript\">!function(e,t,n){function a(){var e=t.getElementsByTagName(\"script\")[0],n=t.createElement(\"script\");n.type=\"text/javascript\",n.async=!0,n.src=\"https://beacon-v2.helpscout.net\",e.parentNode.insertBefore(n,e)}if(e.Beacon=n=function(t,n,a){e.Beacon.readyQueue.push({method:t,options:n,data:a})},n.readyQueue=[],\"complete\"===t.readyState)return a();e.attachEvent?e.attachEvent(\"onload\",a):e.addEventListener(\"load\",a,!1)}(window,document,window.Beacon||function(){});</script>\n        <script type=\"text/javascript\">window.Beacon('init', '40ed799c-8c6c-4226-9215-5adfd59e35eb')</script>\n\n      </head>\n      <body>\n        <div id=\"app\">${app}</div>\n        <script>\n          window.__INITIAL_STATE__ = ${JSON.stringify(initialState)}\n        </script>\n        <script>\n          window.__APOLLO_STATE__ = ${JSON.stringify(client.extract())};\n        </script>\n        ${scriptTags}\n      </body>\n    </html>\n  `;\n}\n\nexport function fetchMeta({ initialState, req }) {\n  const defaultMeta = {\n    title: 'Relevant: The only social network built on trust.',\n    description: 'Find your community and join the discussion.',\n    image: 'https://relevant.community/img/fbImage.png',\n    url: 'https://relevant.community' + req.originalUrl,\n    type: 'summary_large_image'\n  };\n\n  const { feed, postId, commentId } = req.params;\n  const postMeta = getPostMeta({ postId, commentId, initialState });\n  const communityMeta = getCommunityMeta({ initialState });\n\n  Object.keys(postMeta).forEach(key => {\n    if (!postMeta[key]) delete postMeta[key];\n  });\n\n  if (postId) return { ...defaultMeta, ...communityMeta, ...postMeta };\n  if (feed) return { ...defaultMeta, ...communityMeta };\n  return defaultMeta;\n}\n\nfunction getPostMeta({ initialState, postId, commentId }) {\n  const { posts } = initialState;\n  if (!postId && !commentId) return {};\n  const post = posts.posts[postId];\n  const comment = posts.posts[commentId];\n  const userImage = comment ? comment.embeddedUser.image : null;\n  const userComment = comment ? `@${comment.embeddedUser.name}: ${comment.body}` : null;\n  if (!post) return {};\n  const linkData = post.metaPost ? posts.links[post.metaPost] : post;\n  const { title } = linkData;\n  const image = userImage || linkData.image || 'https://relevant.community/img/r-big.png';\n  const description = userComment || post.body || linkData.description;\n  const type = image && !userImage ? 'summary_large_image' : 'summary';\n  return { title, image, description, type };\n}\n\nfunction getCommunityMeta({ initialState }) {\n  const { auth, community: communityState } = initialState;\n  const community = communityState.communities[auth.community];\n  if (!community) return {};\n  const { description } = community;\n  const image = community.image || 'https://relevant.community/img/r-big.png';\n  const title = community.name;\n  const type = 'summary';\n  return { image, title, description, type };\n}\n\nexport async function handleRouteData({ req, store }) {\n  const branch = matchRoutes(routes, req.url);\n  const promises = branch.map(async ({ route, match }) => {\n    const { params } = match;\n    const { fetchData } = route.component;\n    // TODO can you get away without sending params and send whole store?\n    return fetchData instanceof Function\n      ? fetchData(store.dispatch, params)\n      : Promise.resolve(null);\n  });\n  return Promise.all(promises);\n}\n\nexport function renderApp({ url, store }) {\n  const context = {};\n  const nonce = new Date().getTime();\n\n  const App = () => (\n    <ApolloProvider client={client}>\n      <Provider store={store}>\n        <StaticRouter location={url} context={context}>\n          {renderRoutes(routes)}\n        </StaticRouter>\n      </Provider>\n    </ApolloProvider>\n  );\n\n  AppRegistry.registerComponent('App', () => App);\n\n  const app = renderToString(\n    <StyleSheetManager sheet={sheet.instance}>\n      <ChunkExtractorManager extractor={extractor}>{App()}</ChunkExtractorManager>\n    </StyleSheetManager>\n  );\n\n  const { getStyleElement } = AppRegistry.getApplication('App');\n  const rnWebStyles = renderToStaticMarkup(getStyleElement({ nonce }));\n\n  return { app, rnWebStyles };\n}\n"],"file":"render.js"}