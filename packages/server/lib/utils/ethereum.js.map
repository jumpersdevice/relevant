{"version":3,"sources":["../../src/utils/ethereum.js"],"names":["decimals","instance","rpcUrl","provider","network","key","tokenAddress","web3","initialized","wallet","pendingTx","GAS_SPEED","process","env","on","err","console","log","Error","isInitialized","getWeb3","getInstance","init","_provider","_address","NODE_ENV","OWNER_KEY","ethers","getDefaultProvider","INFURA_NETWORK","RelevantToken","networks","NETWORK_NUMBER","address","TEST_KEY","TEST_RPC","providers","JsonRpcProvider","getNetwork","chainId","Wallet","Contract","abi","connect","getBalance","balance","balanceOf","val","div","toString","parseFloat","getParam","param","opt","value","noConvert","string","getGasPrice","gasSpeed","speed","gasPrice","price","JSON","parse","sendTx","method","args","cancelPendingTx","nonce","getTransactionCount","pending","optNonce","options","gasLimit","tx","result","wait","status","gasUsed","toBN","num","utils","parseUnits","mintRewardTokens","lastMint","roundsSincleLast","toNumber","allocateRewards","_amount","allocateAirdrops","getNonce","_account","nonceOf","sign","amount","hash","solidityKeccak256","sig","signMessage","arrayify"],"mappings":"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","sourcesContent":["import request from 'request-promise-any';\nimport { ethers } from 'ethers';\nimport { INFURA_NETWORK, NETWORK_NUMBER } from 'app/core/config';\nimport { sendAdminAlert } from 'server/utils/mail';\nimport RelevantToken from '@r3l/common/lib/contracts/RelevantToken.json';\n\nlet decimals;\nlet instance;\nlet rpcUrl;\nlet provider;\nlet network;\nlet key;\nlet tokenAddress;\nlet web3;\nlet initialized = false;\nlet wallet;\n\nconst pendingTx = {};\nconst GAS_SPEED = process.env.GAS_SPEED || 'average';\n\nprocess.on('beforeExit', async () => {\n  const err = `Un-executed Pending Transactions: ${pendingTx}`;\n  // eslint-disable-next-line\n  console.log(err);\n  await sendAdminAlert(new Error(err));\n});\n\nexport const isInitialized = () => initialized;\nexport const getWeb3 = () => web3;\n\n// SECURITY - this should never by exposed via any APIs!\nexport const getInstance = () => instance;\n\nexport async function init(_provider, _address) {\n  try {\n    // SECURITY - this env var should never by exposed via any APIs!\n    if (process.env.NODE_ENV === 'production') {\n      key = process.env.OWNER_KEY;\n      if (!key) return false;\n\n      provider = ethers.getDefaultProvider(INFURA_NETWORK);\n      tokenAddress = RelevantToken.networks[NETWORK_NUMBER]\n        ? RelevantToken.networks[NETWORK_NUMBER].address\n        : null;\n    } else {\n      key = process.env.TEST_KEY;\n      if (!key) return false;\n\n      rpcUrl = process.env.TEST_RPC;\n      provider = _provider || new ethers.providers.JsonRpcProvider(rpcUrl);\n      network = await provider.getNetwork();\n      tokenAddress = _address || RelevantToken.networks[network.chainId].address;\n    }\n\n    wallet = new ethers.Wallet(key, provider);\n    instance = new ethers.Contract(tokenAddress, RelevantToken.abi, provider);\n\n    // SECURITY - this should never by exposed via any APIs!\n    instance = instance.connect(wallet);\n\n    decimals = await instance.decimals();\n    initialized = true;\n\n    return true;\n  } catch (err) {\n    console.log(err); // eslint-disable-line\n    return false;\n  }\n}\n\nexport async function getBalance(address) {\n  if (!instance) return 0;\n  const balance = await instance.balanceOf(address);\n  const val = balance.div((10 ** decimals).toString());\n  return parseFloat(val.toString());\n}\n\nexport async function getParam(param, opt) {\n  if (!initialized) await init();\n\n  let value = await instance[param]();\n  if (!opt || !opt.noConvert) value = value.div((10 ** decimals).toString());\n  if (!opt || !opt.string) value = parseFloat(value.toString());\n  return value;\n}\n\nexport async function getGasPrice(gasSpeed) {\n  const speed = gasSpeed || GAS_SPEED;\n  const gasPrice = await request('https://ethgasstation.info/json/ethgasAPI.json');\n  const price = JSON.parse(gasPrice);\n  console.log(price); // eslint-disable-line\n  console.log('gas price', price[speed]); // eslint-disable-line\n  return price[speed];\n}\n\n// SECURITY - this function should never by exposed via any APIs!\nexport async function sendTx({ method, args, cancelPendingTx }) {\n  const nonce = await wallet.getTransactionCount();\n  const pending = await wallet.getTransactionCount('pending');\n  console.log('current nonce', nonce, 'pending nonce:', pending); // eslint-disable-line\n  const speed = pending > nonce && cancelPendingTx ? 'fast' : null;\n  const gasPrice = await getGasPrice(speed);\n  const optNonce = cancelPendingTx ? { nonce } : {};\n\n  const options = {\n    gasPrice: gasPrice * 1e8,\n    gasLimit: 6e6,\n    ...optNonce\n  };\n\n  const tx = await instance[method](...args, options);\n  pendingTx[method] = tx;\n  const result = await tx.wait();\n  delete pendingTx[method];\n  console.log('status:', result.status); // eslint-disable-line\n  console.log(`gas used by ${method}: ${result.gasUsed}`); // eslint-disable-line\n  return result;\n}\n\nexport function toBN(num) {\n  return ethers.utils.parseUnits((num / 10 ** decimals).toString(), decimals);\n}\n\nexport async function mintRewardTokens(cancelPendingTx) {\n  if (!instance) await init();\n  const lastMint = await instance.roundsSincleLast();\n  if (lastMint.toNumber() === 0) return null;\n  return sendTx({ method: 'releaseTokens', args: [], cancelPendingTx });\n}\n\nexport async function allocateRewards(_amount, cancelPendingTx) {\n  return sendTx({ method: 'allocateRewards', args: [toBN(_amount)], cancelPendingTx });\n}\n\nexport async function allocateAirdrops(_amount) {\n  return sendTx({ method: 'allocateAirdrops', args: [toBN(_amount)] });\n}\n\nexport async function getNonce(_account) {\n  const nonce = await instance.nonceOf(_account);\n  return nonce.toNumber();\n}\n\nexport async function sign(_account, _amount) {\n  const nonce = await getNonce(_account);\n  const amount = ethers.utils.parseUnits(_amount.toString(), decimals).toString();\n  const hash = ethers.utils.solidityKeccak256(\n    ['uint256', 'address', 'uint256'],\n    [amount, _account, nonce]\n  );\n  const sig = await wallet.signMessage(ethers.utils.arrayify(hash));\n  return { sig, amount };\n}\n"],"file":"ethereum.js"}