{"version":3,"sources":["../../../src/api/community/community.controller.js"],"names":["RESERVED","findOne","req","res","next","user","slug","params","community","Community","inactive","$ne","Error","private","member","CommunityMember","communityId","_id","status","json","err","index","query","onlyPublic","role","onlyVisible","hidden","communties","find","$or","populate","path","match","superAdmin","privateCommunities","memberships","filter","m","map","c","toObject","members","blocked","blockedBy","limit","parseInt","skip","users","$nin","sort","pagerank","memberSearch","search","name","RegExp","$and","reputation","then","membership","join","userId","leave","send","showAdmins","admins","create","body","toLowerCase","indexOf","newCommunity","image","topics","description","channels","betEnabled","superAdmins","save","superAdminsAndCreator","Set","handle","newSuperAdmins","updateAdmins","newAdmins","updateMemeberCount","update","updatedCommunity","communityMember","equals","isSuperAdmin","canEdit","set","customParams","defaultPost","updateReputationScores","memberCount","PostData","updateMany","needsRankUpdate","debug","type","User","$in","admin","updateFields","dontUpdateCount","newAdminMembers","Promise","all","remove","id","canDelete","findOneAndUpdate","new","deletedCommunity"],"mappings":"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","sourcesContent":["import computePageRank from 'server/pagerank/pagerankCompute';\nimport PostData from 'server/api/post/postData.model';\nimport Community from './community.model';\nimport CommunityMember from './community.member.model';\nimport User from '../user/user.model';\n\nconst RESERVED = [\n  'user',\n  'admin',\n  'info',\n  'api',\n  'img',\n  'fonts',\n  'files',\n  'home',\n  'undefined'\n];\n\nexport async function findOne(req, res, next) {\n  try {\n    const { user } = req;\n    const { slug } = req.params;\n    const community = await Community.findOne({ slug, inactive: { $ne: true } });\n    if (!community) throw new Error(`Community ${slug} doesn't exist`);\n\n    if (community.private) {\n      if (!user) throw new Error('This community is private');\n      const member = await CommunityMember.findOne({\n        communityId: community._id,\n        user: user._id\n      });\n      if (!member) throw new Error('This community is private');\n    }\n\n    res.status(200).json(community);\n  } catch (err) {\n    next(err);\n  }\n}\n\n// uses middleware for server-sider rendering\nexport async function index(req) {\n  const { user } = req;\n  const { community } = req.query;\n  const onlyPublic = user && user.role === 'admin' ? {} : { private: { $ne: true } };\n  const onlyVisible = user && user.role === 'admin' ? {} : { hidden: { $ne: true } };\n\n  const communties = await Community.find({\n    inactive: { $ne: true },\n    ...onlyPublic,\n    $or: [onlyVisible, { slug: community }]\n  })\n    .populate({\n      path: 'admins',\n      match: { role: 'admin' }\n    })\n    .populate({\n      path: 'superAdmins',\n      match: { superAdmin: true }\n    });\n\n  // find private communities where user is a member\n  let privateCommunities = [];\n  if (user) {\n    const memberships = await CommunityMember.find({ user: user._id }).populate({\n      path: 'communityId',\n      match: { inactive: { $ne: true } }\n    });\n    privateCommunities = memberships\n      .filter(m => m.communityId)\n      .filter(\n        m =>\n          m.communityId.private === true ||\n          (m.communityId.hidden === true && m.communityId.slug !== community)\n      )\n      .map(m => m.communityId);\n  }\n  return [...communties, ...privateCommunities].map(c => c.toObject());\n}\n\nexport async function members(req, res, next) {\n  try {\n    const { user } = req;\n    let blocked = [];\n    if (user) {\n      blocked = [...user.blocked, ...user.blockedBy];\n    }\n    const limit = req.query.limit ? parseInt(req.query.limit, 10) : 20;\n    const skip = req.query.skip ? parseInt(req.query.skip, 10) : 0;\n    const community = req.params.slug;\n\n    const users = await CommunityMember.find({\n      community,\n      'user.embeddedUser._id': {\n        $nin: blocked\n      }\n    })\n      .sort({ role: 1, pagerank: -1 })\n      .limit(limit)\n      .skip(skip);\n    res.status(200).json(users || []);\n  } catch (err) {\n    next(err);\n  }\n}\n\nexport async function memberSearch(req, res, next) {\n  try {\n    let blocked = [];\n    const { user } = req;\n    if (user) {\n      blocked = [...user.blocked, ...user.blockedBy];\n    }\n\n    const { search, limit } = req.query;\n    const name = new RegExp(search, 'i');\n    const query = {\n      $and: [\n        { $or: [{ 'embeddedUser.name': name }, { 'embeddedUser.handle': name }] },\n        { 'embeddedUser._id': { $nin: blocked } }\n      ]\n    };\n    const community = req.params.slug;\n    CommunityMember.find({ community, ...query })\n      .sort({ role: 1, reputation: -1 })\n      .limit(parseInt(limit, 10))\n      .then(users => {\n        res.status(200).json(users || []);\n      });\n  } catch (err) {\n    next(err);\n  }\n}\n\nexport async function membership(req, res, next) {\n  try {\n    const user = req.user._id;\n    const m = await CommunityMember.find({ user }).sort('role reputation');\n    res.status(200).json(m);\n  } catch (err) {\n    next(err);\n  }\n}\n\nexport async function join(req, res, next) {\n  try {\n    const userId = req.user._id;\n    const { slug } = req.params;\n    const community = await Community.findOne({ slug });\n    const member = await community.join(userId);\n    res.status(200).json(member);\n  } catch (err) {\n    next(err);\n  }\n}\n\nexport async function leave(req, res, next) {\n  try {\n    const userId = req.user._id;\n    const { slug } = req.params;\n    const community = await Community.findOne({ slug });\n    await community.leave(userId);\n    res.status(200).send();\n  } catch (err) {\n    next(err);\n  }\n}\n\nexport async function showAdmins(req, res, next) {\n  try {\n    const { slug } = req.params;\n    const admins = await CommunityMember.find({ slug, role: 'admin' });\n    res.status(200).json(admins);\n  } catch (err) {\n    next(err);\n  }\n}\n\nexport async function create(req, res, next) {\n  try {\n    const { user } = req;\n    if (!user) throw new Error('You need to be logged in');\n\n    const c = req.body;\n    const slug = c.slug.toLowerCase();\n    if (RESERVED.indexOf(slug) > -1) throw new Error(`The slug ${slug} cannot be used`);\n\n    const newCommunity = {\n      slug,\n      image: c.image,\n      name: c.name,\n      topics: c.topics,\n      description: c.description,\n      channels: c.channels,\n      private: c.private,\n      hidden: c.hidden,\n      betEnabled: c.betEnabled\n    };\n\n    const { admins = [], superAdmins = [] } = req.body;\n\n    let community = new Community(newCommunity);\n    community = await community.save();\n\n    const superAdminsAndCreator = [...new Set([...superAdmins, user.handle])];\n\n    // order matters here - superAdmins should go first\n    const newSuperAdmins = await updateAdmins(\n      superAdminsAndCreator,\n      'superAdmin',\n      community\n    );\n    const newAdmins = await updateAdmins(admins, 'admin', community);\n    community = await community.updateMemeberCount();\n    community.admins = newAdmins;\n    community.superAdmins = newSuperAdmins;\n\n    res.status(200).json(community);\n  } catch (err) {\n    next(err);\n  }\n}\n\nexport async function update(req, res, next) {\n  try {\n    // for now only admins create communities\n    const updatedCommunity = req.body;\n    const { admins, superAdmins } = updatedCommunity;\n    const { user, communityMember } = req;\n    if (!communityMember.communityId.equals(updatedCommunity._id))\n      throw new Error('Community id mismatch');\n\n    if (!updatedCommunity) throw new Error('There was an error processing your request');\n\n    const isSuperAdmin = communityMember && communityMember.superAdmin;\n    const canEdit = user.role === 'admin' || isSuperAdmin;\n\n    if (!canEdit) throw new Error(\"You don't have permission to edit a community\");\n\n    let community = await Community.findOne({ _id: updatedCommunity._id });\n\n    community.set({\n      image: updatedCommunity.image,\n      name: updatedCommunity.name,\n      topics: updatedCommunity.topics,\n      description: updatedCommunity.description,\n      channels: updatedCommunity.channels,\n      private: updatedCommunity.private,\n      hidden: updatedCommunity.hidden,\n      betEnabled: updatedCommunity.betEnabled,\n      customParams: updatedCommunity.customParams,\n      defaultPost: updatedCommunity.defaultPost\n    });\n\n    community = await community.save();\n\n    community = await community.updateMemeberCount();\n\n    // order matters here - superAdmins should go first\n    const newSuperAdmins = await updateAdmins(superAdmins, 'superAdmin', community);\n    const newAdmins = await updateAdmins(admins, 'admin', community);\n    community = await community.updateMemeberCount();\n    community.admins = newAdmins;\n    community.superAdmins = newSuperAdmins;\n\n    res.status(200).json(community);\n\n    // TODO: only do this when admins change\n    await updateReputationScores(community);\n  } catch (err) {\n    next(err);\n  }\n}\n\nasync function updateReputationScores(community) {\n  // Only do this for small communities;\n  if (community.memberCount > 100) return;\n  await PostData.updateMany({ communityId: community._id }, { needsRankUpdate: true });\n  await computePageRank({\n    communityId: community._id,\n    community: community.slug,\n    debug: false\n  });\n}\n\n/**\n * upserts admins\n * @param  {[_id]} admins array of user ids\n * @param  {string} type type of admin ('admin', 'superAdmin')\n * @param  {commuinty}\n * @return {[CommunityMembers]} array of community member objects\n */\nasync function updateAdmins(admins, type, community) {\n  const newAdmins = (await User.find({ handle: { $in: admins } }, '_id')).map(m => m._id);\n\n  const query = {\n    admin: { role: 'admin' },\n    superAdmin: { superAdmin: true }\n  };\n  const updateFields = {\n    admin: { role: 'user' },\n    superAdmin: { superAdmin: false }\n  };\n  await CommunityMember.updateMany(\n    { user: { $nin: newAdmins }, communityId: community._id, ...query[type] },\n    updateFields[type]\n  );\n\n  const dontUpdateCount = true;\n\n  // TODO - should create an invitation\n  const newAdminMembers = newAdmins.map(async _id =>\n    community.join(_id, type, dontUpdateCount)\n  );\n  return Promise.all(newAdminMembers);\n}\n\nexport async function remove(req, res, next) {\n  try {\n    const { user } = req;\n    const { id } = req.params;\n\n    // check that user is an admin\n    const member = await CommunityMember.findOne({\n      communityId: id,\n      user: user._id,\n      role: 'admin'\n    });\n\n    const canDelete = (member && member.superAdmin) || user.role === 'admin';\n    if (!canDelete) throw new Error('you need to be a community admin to do this');\n\n    // await Community.findOne({ slug }).remove().exec();\n    const community = await Community.findOneAndUpdate(\n      { _id: id },\n      { inactive: true },\n      { new: true }\n    );\n    await CommunityMember.update(\n      { communityId: community._id },\n      { deletedCommunity: true }\n    );\n\n    res.status(200).json('removed');\n  } catch (err) {\n    next(err);\n  }\n}\n"],"file":"community.controller.js"}