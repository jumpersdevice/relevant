{"version":3,"sources":["../../../src/api/post/post.controller.js"],"names":["promisify","require","requestAsync","request","defaults","maxRedirects","jar","findRelatedPosts","metaId","post","MetaPost","findOne","_id","populate","tagsArr","tags","filter","t","category","map","join","keywords","search","title","replace","posts","find","$text","$search","$ne","score","$meta","sort","limit","err","Error","exports","flagged","req","res","next","community","skip","query","Post","path","match","repost","$exists","$or","hidden","select","parseInt","status","json","topPosts","now","Date","setDate","getDate","PostData","createdAt","$gt","isInFeed","d","toObject","data","sendPostNotification","body","users","User","alert","user","finished","payload","fromUser","toUser","action","noteType","console","log","Notification","createNotification","forUser","byUser","type","Promise","all","success","sendFlagEmail","flaggedUrl","process","env","API_SERVER","from","to","subject","html","flag","userId","postId","findOneAndUpdate","$addToSet","flaggedBy","flaggedTime","new","metaPost","userPosts","cObj","Community","slug","communityId","blocked","blockedBy","author","handle","params","id","sortQuery","u","equals","myVote","investor","preview","urlParts","url","parse","previewUrl","decodeURIComponent","result","previewDataAsync","noReadability","getHeader","uri","fbHeader","relevantHeader","noFb","queryUrl","_url","response","gzip","headers","rejectUnauthorized","timeout","pool","maxSockets","agent","href","processed","proxyHelpers","generatePreview","redirect","resolve","substring","lastIndexOf","domain","extractDomain","readable","article","getReadable","send","content","index","$nin","related","update","communityMember","tag","trim","mentions","newMentions","newTags","newPost","linkObject","prevMentions","prevTags","m","indexOf","link","description","image","articleAuthor","shortText","categories","upsertLinkParent","oldLinkParent","linkParent","pruneFeed","parentPost","length","originalTags","Set","save","pTags","Tag","updateOne","parents","$inc","count","upsert","exec","sendOutMentions","name","embeddedUser","processSubscriptions","subscribers","Subscriptiton","following","promises","subscription","follower","updateFeed","amount","remove","Math","max","feed","Feed","lastFeedNotification","unread","read","$gte","n","updateMany","multi","number","newFeedPost","socketEvent","emit","error","create","banned","channel","postUrl","inputUrl","hasChildComment","payoutTime","getTime","PAYOUT_TIME","NODE_ENV","push","forEach","postObject","relevance","postDate","postString","JSON","stringify","newLinkPost","insertIntoFeed","addPostData","addUserInfo","incrementUnread","updatePostCount","role","newPostEvent","notMe"],"mappings":"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","sourcesContent":["import url from 'url';\nimport request from 'request';\nimport get from 'lodash/get';\nimport socketEvent from 'server/socket/socketEvent';\nimport Community from 'server/api/community/community.model';\nimport { sendEmail } from 'server/utils/mail';\nimport { sendNotification } from 'server/notifications';\nimport { checkCommunityAuth } from 'server/api/community/community.auth';\nimport * as proxyHelpers from './html';\nimport MetaPost from './link.model';\nimport Post from './post.model';\nimport User from '../user/user.model';\nimport Subscriptiton from '../subscription/subscription.model';\nimport Feed from '../feed/feed.model';\nimport Tag from '../tag/tag.model';\nimport Notification from '../notification/notification.model';\nimport PostData from './postData.model';\nimport { PAYOUT_TIME } from '../../config/globalConstants';\n\nconst { promisify } = require('util');\n\nconst requestAsync = promisify(request);\nrequest.defaults({ maxRedirects: 22, jar: true });\n\nasync function findRelatedPosts(metaId) {\n  try {\n    const post = await MetaPost.findOne({ _id: metaId }).populate('tags');\n    const tagsArr = post.tags.filter(t => !t.category).map(t => t._id);\n    const tags = tagsArr.join(' ');\n    const keywords = post.keywords.join(' ');\n    const search = `${tags} ${keywords} ${post.title}`.replace(/\"|'/g, '');\n\n    const posts = await MetaPost.find(\n      { $text: { $search: search }, _id: { $ne: metaId } },\n      { score: { $meta: 'textScore' } }\n    )\n      .sort({ score: { $meta: 'textScore' } })\n      .limit(5);\n    return posts;\n  } catch (err) {\n    throw new Error(err);\n  }\n}\n\nexports.flagged = async (req, res, next) => {\n  try {\n    const { community, limit, skip } = req.query;\n\n    const posts = await Post.find({ flagged: true })\n      .populate([\n        {\n          path: 'metaPost'\n        },\n        {\n          path: 'parentPost',\n          populate: 'metaPost'\n        },\n        {\n          path: 'post',\n          populate: [\n            {\n              path: 'commentary',\n              match: {\n                repost: { $exists: false },\n                $or: [{ hidden: { $ne: true } }]\n              }\n            },\n            {\n              path: 'embeddedUser.relevance',\n              match: { community },\n              select: 'pagerank'\n            }\n          ]\n        }\n      ])\n      .skip(parseInt(skip, 10))\n      .limit(parseInt(limit, 10))\n      .sort('-createdAt');\n\n    res.status(200).json(posts);\n  } catch (err) {\n    next(err);\n  }\n};\n\nexports.topPosts = async (req, res, next) => {\n  try {\n    let posts;\n    const now = new Date();\n    now.setDate(now.getDate() - 7);\n    posts = await PostData.find({ createdAt: { $gt: now }, isInFeed: true })\n      .populate({\n        path: 'post',\n        populate: [{ path: 'metaPost' }]\n      })\n      .sort('-pagerank')\n      .limit(20);\n\n    // TODO do this on frontend?\n    posts = posts.filter(d => d.post);\n    posts = posts.map(d => ({\n      ...d.post.toObject(),\n      data: { ...d.toObject(), post: get(d, 'post._id') }\n    }));\n    res.status(200).json(posts);\n  } catch (err) {\n    next(err);\n  }\n};\n\nexports.sendPostNotification = async (req, res, next) => {\n  // todo: add tweet option\n  try {\n    const post = req.body;\n    const users = await User.find({});\n\n    const alert = `In case you missed this top-ranked post from @${post.user}: ${post.title}`;\n\n    // TODO - optimize this or put in queue so we don't create a bottle neck;\n    const finished = users.map(async user => {\n      try {\n        const payload = {\n          fromUser: null,\n          toUser: user,\n          post,\n          action: alert,\n          noteType: 'general'\n        };\n        await sendNotification(user, alert, payload);\n      } catch (err) {\n        // eslint-disable-next-line\n        console.log('sending notifications error ', err);\n      }\n      return Notification.createNotification({\n        post: post._id,\n        forUser: user._id,\n        byUser: post.user,\n        type: 'topPost'\n      });\n    });\n    await Promise.all(finished);\n    res.status(200).json({ success: true });\n  } catch (err) {\n    next(err);\n  }\n};\n\nasync function sendFlagEmail() {\n  const flaggedUrl = `${process.env.API_SERVER}/admin/flagged`;\n  const data = {\n    from: 'Relevant <info@relevant.community>',\n    to: 'info@relevant.community',\n    subject: 'Inapproprate Content',\n    html: `Someone has flagged a post for inappropriate content\n      <br />\n      <br />\n      You can manage flagged content here:&nbsp;\n      <a href=\"${flaggedUrl}\" target=\"_blank\">${flaggedUrl}</a>\n      <br />\n      <br />`\n  };\n  return sendEmail(data);\n}\n\nexports.flag = async (req, res, next) => {\n  try {\n    const userId = req.user._id;\n    const { postId } = req.body;\n    const post = await Post.findOneAndUpdate(\n      { _id: postId },\n      { flagged: true, $addToSet: { flaggedBy: userId }, flaggedTime: Date.now() },\n      { new: true }\n    );\n    await MetaPost.findOneAndUpdate(\n      { _id: post.metaPost },\n      { flagged: true, $addToSet: { flaggedBy: userId }, flaggedTime: Date.now() },\n      { new: true }\n    );\n    await sendFlagEmail();\n    res.status(200).json(post);\n  } catch (err) {\n    next(err);\n  }\n};\n\nexports.userPosts = async (req, res, next) => {\n  try {\n    const { community } = req.query;\n\n    const cObj = await Community.findOne({ slug: community }, '_id');\n    if (!cObj) return res.status(200).json({});\n    const communityId = cObj._id;\n\n    const { user } = req;\n    const blocked = user ? [...user.blocked, ...user.blockedBy] : [];\n\n    const limit = parseInt(req.query.limit, 10);\n    const skip = parseInt(req.query.skip, 10);\n\n    const author = await User.findOne({ handle: req.params.id }, '_id');\n    if (!author) throw new Error('Missing user');\n\n    const sortQuery = { _id: -1 };\n    const query = { user: author._id, communityId };\n\n    if (blocked.find(u => author._id.equals(u))) {\n      return res.status(200).json({});\n    }\n\n    const myVote = user\n      ? [\n          {\n            path: 'myVote',\n            match: { investor: user._id, communityId }\n          }\n        ]\n      : [];\n\n    const posts = await Post.find(query)\n      .populate({\n        path: 'repost.post',\n        populate: [\n          {\n            path: 'embeddedUser.relevance',\n            select: 'pagerank',\n            match: { communityId }\n          },\n          {\n            path: 'metaPost'\n          },\n          {\n            path: 'data',\n            match: { communityId }\n          }\n        ]\n      })\n      .populate({\n        path: 'parentPost',\n        populate: [\n          {\n            path: 'data',\n            match: { communityId }\n          },\n          { path: 'metaPost' },\n          ...myVote\n        ]\n      })\n      .populate({\n        path: 'parentComment',\n        populate: [\n          {\n            path: 'data',\n            match: { communityId }\n          },\n          { path: 'metaPost' },\n          ...myVote\n        ]\n      })\n      .populate({ path: 'metaPost ' })\n      .populate({\n        path: 'embeddedUser.relevance',\n        select: 'pagerank',\n        match: { communityId }\n      })\n      .populate([\n        {\n          path: 'data',\n          match: { communityId }\n        },\n        ...myVote\n      ])\n      .limit(limit)\n      .skip(skip)\n      .sort(sortQuery);\n\n    return res.status(200).json(posts);\n  } catch (err) {\n    return next(err);\n  }\n};\n\nexports.preview = async (req, res, next) => {\n  try {\n    const urlParts = url.parse(req.url, false);\n    const { query } = urlParts;\n    const previewUrl = decodeURIComponent(query.replace('url=', ''));\n    const result = await exports.previewDataAsync(previewUrl);\n    res.status(200).json(result);\n  } catch (err) {\n    next(err);\n  }\n};\n\nexports.previewDataAsync = async (previewUrl, noReadability) => {\n  if (!previewUrl.match(/http:\\/\\//i) && !previewUrl.match(/https:\\/\\//i)) {\n    previewUrl = 'http://' + previewUrl;\n  }\n\n  function getHeader(uri) {\n    const fbHeader = {\n      'User-Agent':\n        'facebookexternalhit/1.1 (+http://www.facebook.com/externalhit_uatext.php) Facebot'\n    };\n    const relevantHeader = {\n      'User-Agent':\n        'This is a user request for article matadata for Relevant Community (https://relevant.community | info@relevant.community)'\n    };\n    const noFb =\n      uri.match('apple.news') ||\n      uri.match('bloomberg.com') ||\n      uri.match('washingtonpost.com');\n\n    if (noFb) return relevantHeader;\n    return fbHeader;\n  }\n\n  // recursive fuction TODO - max recursive calls check?\n  async function queryUrl(_url) {\n    const response = await requestAsync({\n      url: _url,\n      maxRedirects: 22,\n      jar: true,\n      gzip: true,\n      headers: getHeader(_url),\n      rejectUnauthorized: false,\n      timeout: 20000,\n      pool: { maxSockets: 1000 },\n      agent: false\n    });\n\n    let uri = response.request.uri.href;\n    const processed = await proxyHelpers.generatePreview(\n      response.body,\n      uri,\n      _url,\n      noReadability\n    );\n\n    if (processed.redirect && processed.uri) {\n      console.log('redirect ', processed.uri); // eslint-disable-line\n      uri = processed.uri;\n      return queryUrl(uri);\n    }\n    return Promise.resolve(processed.result);\n  }\n\n  // Its a PDF\n  if (previewUrl.match('.pdf')) {\n    return {\n      url: previewUrl,\n      title: previewUrl.substring(previewUrl.lastIndexOf('/') + 1),\n      domain: proxyHelpers.extractDomain(previewUrl)\n    };\n  }\n\n  return queryUrl(previewUrl);\n};\n\nexports.readable = async (req, res, next) => {\n  try {\n    const { uri } = req.query;\n    const article = await proxyHelpers.getReadable(uri);\n    // let short = proxyHelpers.trimToLength(article.article, 140);\n    res.send(article.content);\n  } catch (err) {\n    next(err);\n  }\n};\n\nexports.index = async req => {\n  const { community } = req.query;\n\n  if (!community) throw new Error('missing the community query parameter');\n  const { id: postId } = req.params;\n  const { user } = req;\n\n  const cObj = await Community.findOne({ slug: community }, '_id');\n  const communityId = cObj._id;\n\n  let blocked = [];\n  // TODO server rendering doesn't run the blocked middleware!\n  if (user) blocked = [...(user.blocked || []), ...(user.blockedBy || [])];\n\n  const myVote = user\n    ? [\n        {\n          path: 'myVote',\n          match: { investor: user._id, communityId }\n        }\n      ]\n    : [];\n\n  const post = await Post.findOne({\n    _id: postId,\n    user: { $nin: blocked }\n  }).populate([\n    ...myVote,\n    {\n      path: 'embeddedUser.relevance',\n      select: 'pagerank',\n      match: { communityId }\n    },\n    { path: 'metaPost' },\n    {\n      path: 'data',\n      match: { communityId }\n    }\n  ]);\n\n  return post;\n};\n\n// NOT USED RN\nexports.related = async req => {\n  const { id } = req.params;\n  return findRelatedPosts(id);\n};\n\nexports.update = async (req, res, next) => {\n  try {\n    const { communityId } = req.communityMember;\n    let tags = req.body.tags.filter(tag => tag);\n\n    // DEPRECATED old mobile\n    tags = tags.map(tag => tag.replace('_category_tag', '').trim());\n\n    const mentions = req.body.mentions || [];\n    let newMentions;\n    let newTags;\n    const { category } = req.body;\n    let newPost;\n    let linkObject;\n\n    newPost = await Post.findOne({ _id: req.body._id }).populate('parentPost');\n\n    if (!communityId.equals(newPost.communityId)) {\n      throw new Error(\"Community doesn't match\");\n    }\n\n    const prevMentions = [...newPost.mentions];\n    const prevTags = [...newPost.mentions];\n\n    newMentions = mentions.filter(m => prevMentions.indexOf(m) < 0);\n    newTags = tags.filter(t => prevTags.indexOf(t) < 0);\n\n    newPost.tags = tags;\n    newPost.mentions = mentions;\n    newPost.body = req.body.body;\n\n    if (newPost.url !== req.body.url) {\n      linkObject = {\n        url: req.body.link,\n        title: req.body.title || null,\n        description: req.body.description || null,\n        image: req.body.image || null,\n        articleAuthor: req.body.articleAuthor,\n        shortText: req.body.shortText,\n        categories: [category],\n        domain: req.body.domain,\n        tags\n      };\n\n      // upsert new parent post\n      newPost = await newPost.upsertLinkParent(linkObject);\n\n      const oldLinkParent = await Post.findOne({ _id: newPost.linkParent });\n      await oldLinkParent.pruneFeed({ communityId });\n    }\n\n    if (newPost.parentPost && tags && tags.length) {\n      const { parentPost } = newPost;\n      const originalTags = parentPost.tags || [];\n      parentPost.tags = [...new Set([...originalTags, ...tags])];\n      await newPost.parentPost.save();\n    }\n\n    await newPost.save();\n    res.status(200).json(newPost);\n\n    // some post processing\n    newTags = newTags || [];\n    newMentions = newMentions || [];\n\n    // TODO redo tag processing stuff\n    const pTags = newTags.map(tag =>\n      Tag.updateOne(\n        { _id: tag },\n        {\n          $addToSet: { parents: category },\n          $inc: { count: 1 } // eslint-disable-line\n        },\n        { upsert: true }\n      ).exec()\n    );\n\n    await Post.sendOutMentions(newMentions, newPost, {\n      _id: newPost.user,\n      name: newPost.embeddedUser.name\n    });\n\n    return await Promise.all([...pTags]);\n  } catch (err) {\n    return next(err);\n  }\n};\n\nasync function processSubscriptions(newPost, communityId) {\n  try {\n    const author = newPost.embeddedUser;\n    const subscribers = await Subscriptiton.find({\n      following: newPost.user,\n      communityId\n      // category: newPostObj.category\n    }).populate('follower', '_id handle name deviceTokens badge lastFeedNotification');\n\n    const cObj = await Community.findOne({ _id: communityId }, 'name');\n\n    const promises = subscribers.map(async subscription => {\n      if (!subscription.follower) return null;\n      try {\n        let updateFeed;\n        /**\n         * In case subscription has expired, but user hasn't seen the articles\n         * remove oldest unread in feed and push new one\n         */\n        // console.log(subscription);\n        // // NO SUBSCRIPTIONS RN\n        // if (subscription.amount < 1) {\n        // check unread here\n        // updateFeed = await Feed.processExpired(subscription.follower._id);\n        // }\n        if (!updateFeed && subscription.amount < 1) {\n          return subscription.remove();\n        }\n\n        subscription.amount -= 1;\n        subscription.amount = Math.max(subscription.amount, 0);\n\n        subscription = await subscription.save();\n\n        const feed = new Feed({\n          userId: subscription.follower,\n          from: newPost.user,\n          post: newPost._id,\n          tags: newPost.tags,\n          createdAt: new Date()\n        });\n\n        await feed.save();\n\n        const now = new Date();\n\n        const { follower } = subscription;\n\n        // TODO put it on a queue, only certain hours of the day\n        if (now - 12 * 60 * 60 * 1000 > new Date(follower.lastFeedNotification)) {\n          // if (true) {\n          const unread = await Feed.find({\n            userId: follower._id,\n            read: false,\n            createdAt: { $gte: now - 24 * 60 * 60 * 1000 }\n          });\n          const n = unread.length;\n          await Feed.updateMany(\n            { userId: follower._id, read: false },\n            { read: true },\n            { multi: true }\n          );\n          const alert = `There is a new post from ${author.name} in the ${cObj.name} community`;\n\n          const payload = {\n            fromUser: author,\n            toUser: subscription.follower,\n            post: newPost,\n            action: alert,\n            noteType: 'newPost',\n            number: n,\n            community: cObj.name\n          };\n\n          // console.log('New post in feed alert', alert);\n          sendNotification(follower, alert, payload);\n          follower.lastFeedNotification = now;\n          follower.save();\n        }\n\n        const newFeedPost = {\n          _id: subscription.follower._id,\n          type: 'INC_FEED_COUNT'\n        };\n        socketEvent.emit('socketEvent', newFeedPost);\n        return null;\n      } catch (err) {\n        // eslint-disable-next-line\n        console.error('error updating subscription ', err);\n        return null;\n      }\n    });\n    await Promise.all(promises);\n  } catch (err) {\n    // eslint-disable-next-line\n    console.error('error processing subscriptions', err);\n  }\n}\n\n/**\n * Creates a new post\n */\nexports.create = async (req, res, next) => {\n  try {\n    const { user, communityMember } = req;\n    const { community, communityId } = communityMember;\n\n    if (community === 'foam')\n      await checkCommunityAuth({ user, communityId, communityMember });\n\n    if (user.banned) {\n      throw new Error(\n        'You are temporarily blocked from making new posts, if you think this is an error, please reach out to info@relevant.community'\n      );\n    }\n\n    const { channel, body, postUrl: inputUrl } = req.body;\n    // TODO rate limiting?\n    // current rate limiting is 5s via invest\n    const hasChildComment = body && body.length;\n    const mentions = req.body.mentions || [];\n    let tags = [];\n    const keywords = req.body.keywords || [];\n    const category = req.body.category ? req.body.category._id : null;\n\n    const postUrl = req.body.url || req.body.link;\n    const now = new Date();\n\n    let payoutTime = new Date(now.getTime() + PAYOUT_TIME);\n    if (process.env.NODE_ENV === 'test' && req.body.payoutTime) {\n      payoutTime = req.body.payoutTime;\n    }\n\n    // TODO clean up tag stuff\n    if (category) tags.push(category);\n    // Deprecate this (old category tag stuff from mobile)\n    req.body.tags.forEach(tag => {\n      if (tag) {\n        tags.push(tag.replace('_category_tag', '').trim());\n      }\n    });\n    tags = [...new Set(tags)];\n\n    const linkObject = {\n      // this is stored in metaPost\n      url: postUrl,\n      title: req.body.title ? req.body.title : '',\n      description: req.body.description ? req.body.description : null,\n      image: req.body.image ? req.body.image : null,\n      articleAuthor: req.body.articleAuthor,\n      shortText: req.body.shortText,\n      keywords,\n      domain: req.body.domain,\n      categories: [category],\n      tags\n    };\n\n    const postObject = {\n      url: postUrl,\n      inputUrl,\n      image: req.body.image ? req.body.image : null,\n      title: req.body.title ? req.body.title : '',\n      body: hasChildComment ? body : null,\n      tags,\n      community,\n      communityId,\n      category,\n      relevance: 0,\n      user: user._id,\n      mentions: req.body.mentions,\n      postDate: now,\n      payoutTime,\n      description: channel && hasChildComment ? body : null,\n      channel: (!postUrl && channel) || false\n    };\n\n    // TODO Work on better length limits\n    const postString = JSON.stringify(postObject);\n    if (postString.length > 100000) {\n      return res.status(500).json('post is too long');\n    }\n\n    const author = await User.findOne({ _id: user._id });\n\n    let linkParent;\n    if (postUrl) {\n      linkParent = await Post.newLinkPost({ linkObject, postObject });\n      await linkParent.insertIntoFeed(communityId, community);\n      // await Invest.createVote({\n      //   post: linkParent,\n      //   user: author,\n      //   amount: 1,\n      //   relevanceToAdd: 0,\n      //   community,\n      //   communityId\n      // });\n    }\n\n    if (!hasChildComment) return res.status(200).json(linkParent);\n\n    let newPost = new Post(postObject);\n    newPost = await newPost.save();\n\n    if (linkParent) {\n      newPost.linkParent = linkParent;\n      newPost.parentPost = linkParent;\n      newPost.metaPost = linkParent.metaPost;\n    }\n\n    newPost = await newPost.addPostData();\n    newPost.data.parentPost = linkParent;\n\n    newPost = await newPost.addUserInfo(author);\n    newPost = await newPost.save();\n\n    if (linkParent) await linkParent.save();\n\n    // TODO should you invest in own comment?\n    // await Invest.createVote({\n    //   post: newPost,\n    //   user: author,\n    //   amount: 1,\n    //   relevanceToAdd: 0,\n    //   community,\n    //   communityId\n    // });\n\n    if (!postUrl && !channel) await newPost.insertIntoFeed(communityId, community);\n    await newPost.incrementUnread({ communityId, community });\n\n    await author.updatePostCount();\n    res.status(200).json(newPost || linkParent);\n\n    processSubscriptions(newPost, communityId);\n    return Post.sendOutMentions(mentions, newPost, author);\n  } catch (err) {\n    return next(err);\n  }\n};\n\nexports.remove = async (req, res, next) => {\n  try {\n    const userId = req.user._id;\n    const { id } = req.params;\n    let query = { _id: id, user: userId };\n\n    if (req.user.role === 'admin') {\n      query = { _id: id };\n    }\n\n    const post = await Post.findOne(query);\n    if (!post) throw new Error('No post found', query);\n\n    await post.remove();\n\n    const newPostEvent = {\n      type: 'REMOVE_POST',\n      notMe: true,\n      payload: post\n    };\n    socketEvent.emit('socketEvent', newPostEvent);\n\n    await req.user.updatePostCount();\n    res.status(200).json('removed');\n  } catch (err) {\n    next(err);\n  }\n};\n"],"file":"post.controller.js"}