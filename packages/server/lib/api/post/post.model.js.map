{"version":3,"sources":["../../../src/api/post/post.model.js"],"names":["mongoose","require","socketEvent","default","Schema","sendNotification","TENTH_LIFE","PostSchema","body","String","title","description","channel","type","Boolean","community","communityId","Types","ObjectId","ref","tags","category","repost","post","comment","commentBody","user","index","embeddedUser","_id","handle","name","image","flagged","flaggedBy","select","flaggedTime","Date","mentions","metaPost","url","unique","inputUrl","link","links","text","href","position","Number","linkParent","parentPost","parentComment","postDate","latestComment","commentCount","rank","relevance","pagerank","upVotes","downVotes","paidOut","payoutTime","twitter","hidden","twitterUser","twitterId","twitterScore","twitterUrl","seenInFeedNumber","version","timestamps","toJSON","virtuals","toObject","virtual","localField","foreignField","justOne","communitId","pre","save","next","countQuery","model","countDocuments","err","console","log","methods","addPostData","postObject","eligibleForReward","now","data","relevanceNeg","updateClient","postNote","payload","emit","addUserInfo","id","updateLatestComment","findOne","$ne","sort","updateRank","updateTime","getTime","Math","log10","round","topComment","max","statics","newLinkPost","linkObject","populate","path","match","parentObj","combinedTags","Set","upsertMetaPost","upsertLinkParent","parent","insertIntoFeed","Error","findOneAndUpdate","isInFeed","new","newPostEvent","metaId","MetaPost","meta","set","getPostData","addTags","sendOutMentions","mUser","textParent","promises","map","mention","blocked","blockedBy","find","u","filter","m","query","group","role","createMentionNotification","Notification","users","forEach","action","alert","fromUser","toUser","noteType","Promise","all","dbNotificationObj","forUser","byUser","amount","personal","read","newDbNotification","note","newNotifObj","pruneFeed","shares","children","remove","communityChildren","deleteOne","exec","updateParentPostOnRemovingChild","shouldUpdateTime","shouldUpdateRank","postRemove","deleteMany","feed","commentNote","incrementUnread","updateMany","$inc","unread","pubsub","publish","UPDATE_UNREAD","toString","module","exports"],"mappings":"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","sourcesContent":["import { pubsub } from 'server/graphql/pubsub';\nimport { UPDATE_UNREAD } from 'server/api/community/member.schema';\n\nconst mongoose = require('mongoose');\nconst socketEvent = require('server/socket/socketEvent').default;\n\nconst { Schema } = mongoose;\nconst { sendNotification } = require('server/notifications');\n\nconst TENTH_LIFE = 3 * 24 * 60 * 60 * 1000;\n\nconst PostSchema = new Schema(\n  {\n    body: String,\n    title: String,\n    description: String,\n    channel: { type: Boolean, default: false },\n    community: String,\n    communityId: { type: Schema.Types.ObjectId, ref: 'Community' },\n    tags: [{ type: String, ref: 'Tag' }],\n    category: { type: String, ref: 'Tag' },\n    repost: {\n      post: { type: Schema.Types.ObjectId, ref: 'Post' },\n      comment: { type: Schema.Types.ObjectId, ref: 'Post' },\n      commentBody: String\n    },\n    user: { type: Schema.Types.ObjectId, ref: 'User', index: true },\n    embeddedUser: {\n      _id: String,\n      handle: String,\n      name: String,\n      image: String\n    },\n\n    flagged: { type: Boolean, default: false },\n    flaggedBy: [{ type: String, ref: 'User', select: false }],\n    flaggedTime: Date,\n    mentions: [{ type: String, ref: 'User' }],\n\n    // store link info here\n    metaPost: { type: Schema.Types.ObjectId, ref: 'MetaPost' },\n    url: { type: String, unique: false },\n    inputUrl: { type: String, unique: false },\n    image: { type: String },\n\n    // TEMP Deprecate remove after migrate 0.20\n    link: { type: String, unique: false },\n\n    // Should be array of links used instead of metaPost\n    // TODO: Implement this\n    links: [\n      {\n        text: String,\n        href: String,\n        position: Number,\n        metaPost: { type: Schema.Types.ObjectId, ref: 'MetaPost' }\n      }\n    ],\n\n    // aboutLink: { type: Schema.Types.ObjectId, ref: 'Post' },\n    linkParent: { type: Schema.Types.ObjectId, ref: 'Post' },\n    // top-level comments have parent\n    parentPost: { type: Schema.Types.ObjectId, ref: 'Post' },\n    // replies have parent comment\n    parentComment: { type: Schema.Types.ObjectId, ref: 'Post' },\n\n    postDate: { type: Date, index: true },\n    latestComment: { type: Date, index: true },\n    commentCount: { type: Number, default: 0 },\n\n    // todo should be diff table - diff communities will have diff payouts\n\n    rank: { type: Number, default: 0 },\n    relevance: { type: Number, default: 0 },\n    pagerank: { type: Number, default: 0 },\n    upVotes: { type: Number, default: 0 },\n    downVotes: { type: Number, default: 0 },\n\n    paidOut: { type: Boolean, default: false },\n    payoutTime: { type: Date },\n\n    // TODO twitter stuff should go into data model\n    twitter: { type: Boolean, default: false },\n    // Use this to hide twitter posts\n    // TODO this should also go into a data model\n    // and data should be used to query community feed\n    hidden: { type: Boolean, default: false },\n    twitterUser: Number,\n    twitterId: Number,\n    twitterScore: { type: Number, default: 0 },\n    // feedRelevance: Number,\n    twitterUrl: String,\n    seenInFeedNumber: { type: Number, default: 0 },\n\n    // link, comment, repost, post\n    type: { type: String, default: 'post' },\n\n    version: { type: String, default: 'metaRework' }\n  },\n  {\n    timestamps: true,\n    toJSON: { virtuals: true },\n    toObject: { virtuals: true }\n  }\n);\n\nPostSchema.virtual('myVote', {\n  ref: 'Invest',\n  localField: '_id',\n  foreignField: 'post',\n  justOne: true\n});\n\nPostSchema.virtual('reposted', {\n  ref: 'Post',\n  localField: '_id',\n  foreignField: 'repost.post'\n});\n\nPostSchema.virtual('commentary', {\n  ref: 'Post',\n  localField: '_id',\n  foreignField: 'parentPost'\n});\n\nPostSchema.virtual('embeddedUser.relevance', {\n  ref: 'CommunityMember',\n  localField: 'user',\n  foreignField: 'user',\n  justOne: true\n});\n\nPostSchema.virtual('data', {\n  ref: 'PostData',\n  localField: '_id',\n  foreignField: 'post',\n  justOne: true\n});\n\nPostSchema.virtual('children', {\n  ref: 'Post',\n  localField: '_id',\n  foreignField: 'parentPost',\n  justOne: false\n});\n\nPostSchema.index({ twitter: 1 });\nPostSchema.index({ parentPost: 1, hidden: 1 });\nPostSchema.index({ parentPost: 1, pagerank: 1, hidden: 1 });\n\nPostSchema.index({ twitter: 1, twitterId: 1 });\n\nPostSchema.index({ rank: 1 });\nPostSchema.index({ postDate: -1 });\nPostSchema.index({ postDate: -1, community: 1 });\n\nPostSchema.index({ postDate: -1, communitId: 1, parentPost: 1 });\nPostSchema.index({ _id: 1, community: 1, user: 1 });\n\nPostSchema.index({ _id: 1, user: 1 });\nPostSchema.index({ _id: -1, communityId: 1, user: 1 });\n\nPostSchema.index({ communityId: 1, user: 1 });\nPostSchema.index({ postDate: -1, tags: 1 });\nPostSchema.index({ rank: 1, tags: 1 });\nPostSchema.index({ paidOut: 1, payoutTime: 1 });\n\nPostSchema.pre('save', async function save(next) {\n  try {\n    const countQuery = { parentPost: this._id, hidden: false };\n    this.commentCount = await this.model('Post').countDocuments(countQuery);\n    return next();\n  } catch (err) {\n    console.log('error updating post count', err); // eslint-disable-line\n    return next();\n  }\n});\n\nPostSchema.methods.addPostData = async function addPostData(postObject) {\n  const eligibleForReward = !this.parentPost && !this.twitter;\n  const now = new Date();\n  const data = new (this.model('PostData'))({\n    eligibleForReward,\n    hidden: this.hidden,\n    type: this.type,\n    parentPost: this.parentPost,\n    postDate: now, // if we are creating post data object date is new!\n    payoutTime: postObject ? postObject.payoutTime : this.payoutTime,\n    // payoutTime: this.payoutTime,\n    // postDate: this.postDate || this.createdAt,\n    post: this._id,\n    community: postObject ? postObject.community : this.community,\n    communityId: postObject ? postObject.communityId : this.communityId,\n    relevance: this.relevance,\n    rank: this.rank,\n    relevanceNeg: this.relevanceNeg,\n    latestComment: this.latestComment || this.postDate,\n    tags: this.tags\n  });\n\n  await data.save();\n  this.data = data;\n  return this;\n};\n\nPostSchema.methods.updateClient = function updateClient(user) {\n  if (this.user && this.user._id) this.user = this.user._id;\n  const post = this.toObject();\n  // Prevent over-writing post object\n  // TODO - normalize on client instead\n  if (post.parentPost && post.parentPost._id) {\n    post.parentPost = post.parentPost._id;\n  }\n  const postNote = {\n    _id: user ? user._id : null,\n    type: 'UPDATE_POST',\n    payload: post\n  };\n  socketEvent.emit('socketEvent', postNote);\n};\n\nPostSchema.methods.addUserInfo = async function addUserInfo(user) {\n  this.embeddedUser = {\n    id: user._id,\n    _id: user._id,\n    handle: user.handle,\n    name: user.name,\n    image: user.image\n  };\n\n  return this;\n};\n\nasync function updateLatestComment({ post, communityId }) {\n  if (post.parentPost) return post;\n\n  const latestComment = await post\n    .model('Post')\n    .findOne(\n      { parentPost: post._id, communityId, hidden: { $ne: true }, type: 'post' },\n      'postDate'\n    )\n    .sort({ postDate: -1 });\n\n  if (!latestComment) return post;\n\n  post.data.latestComment = latestComment.postDate;\n  post.latestComment = latestComment.postDate;\n\n  return post;\n}\n\n// TODO work on this\nPostSchema.methods.updateRank = async function updateRank({ communityId, updateTime }) {\n  let post = this;\n  try {\n    if (!post.data) {\n      post.data = await post.model('PostData').findOne({ post: post._id, communityId });\n    }\n    const { pagerank } = post.data;\n\n    if (updateTime && !post.parentPost) {\n      post = await updateLatestComment({ post, communityId });\n    }\n\n    // Don't use latestComment to compute post rank!\n    if (!post.data.postDate) post.data.postDate = post.postDate;\n    const { postDate } = post.data;\n\n    let rank =\n      pagerank < 0 ? 0 : postDate.getTime() / TENTH_LIFE + Math.log10(pagerank + 1);\n    rank = Math.round(rank * 1000) / 1000;\n\n    // But if a comment ranks highly - update post rank\n    const topComment = await post\n      .model('PostData')\n      .findOne({ parentPost: post._id, communityId }, 'rank pagerank')\n      .sort({ rank: -1 });\n\n    if (topComment) rank = Math.max(rank, topComment.rank);\n\n    post.data.rank = rank;\n\n    // TODO - deprecate this once we don't use this in the feed\n    // post.rank = rank;\n    // if (post.communityId && post.communityId.toString() === communityId.toString()) {\n    //   post.pagerank = post.data.pagerank;\n    //   // console.log('updating post pagerank', post.pagerank);\n    // }\n\n    await post.data.save();\n    await post.save();\n    return post;\n  } catch (err) {\n    console.log(err); // eslint-disable-line\n    return post;\n  }\n};\n\nPostSchema.statics.newLinkPost = async function newLinkPost({ linkObject, postObject }) {\n  const {\n    tags,\n    postDate,\n    payoutTime,\n    hidden,\n    image,\n    title,\n    url,\n    communityId\n  } = postObject;\n\n  let post = await this.model('Post')\n    .findOne({ url, type: 'link' })\n    .populate({ path: 'data', match: { communityId } });\n\n  if (!post) {\n    const parentObj = {\n      image,\n      title,\n      description: linkObject.description,\n      url,\n      tags,\n      postDate,\n      payoutTime,\n      hidden,\n      type: 'link',\n      latestComment: postDate\n    };\n    post = await new (this.model('Post'))(parentObj);\n  }\n\n  const eligibleForReward = !post.parentPost && !post.twitter;\n\n  if (!post.data) {\n    post = await post.addPostData(postObject);\n  } else if (!post.data.eligibleForReward && eligibleForReward) {\n    post.data.eligibleForReward = eligibleForReward;\n    post.data.postDate = postDate;\n    post.data.payoutTime = payoutTime;\n  }\n\n  const combinedTags = [...new Set([...(post.tags || []), ...(tags || [])])];\n  post.tags = combinedTags;\n  post.data.tags = combinedTags;\n  linkObject.tags = combinedTags;\n\n  // TODO figure out what to do with payoutTime should old post reset?\n  // for now we don't update payout time\n  if (!hidden && post.latestComment < postDate) {\n    post.latestComment = postDate;\n    post.data.latestComment = postDate;\n  }\n\n  if (!hidden) await post.updateRank({ communityId });\n\n  post = await post.upsertMetaPost(post.metaPost, linkObject);\n  post.data = await post.data.save();\n  post = await post.save();\n\n  return post;\n};\n\nPostSchema.methods.upsertLinkParent = async function upsertLinkParent(linkObject) {\n  const post = this;\n\n  const parent = await this.model('Post').newLinkPost({ postObject: post, linkObject });\n  parent.commentCount++;\n\n  post.linkParent = parent;\n  post.parentPost = parent;\n  if (post.data) post.data.parentPost = parent;\n  post.metaPost = parent.metaPost;\n\n  return post;\n};\n\nPostSchema.methods.insertIntoFeed = async function insertIntoFeed(\n  communityId,\n  community\n) {\n  try {\n    const post = this;\n    if (post.parentPost) throw new Error(\"Child comments don't go in the feed\");\n\n    post.data = await this.model('PostData').findOneAndUpdate(\n      { post: post._id, communityId },\n      { isInFeed: true },\n      { new: true }\n    );\n\n    // this.model('CommunityFeed').addToFeed(post, post.data.community);\n\n    const newPostEvent = {\n      type: 'SET_NEW_POSTS_STATUS',\n      payload: { communityId, community }\n    };\n    socketEvent.emit('socketEvent', newPostEvent);\n    return post;\n  } catch (err) {\n    return console.log('insertIntoFeed error', err); // eslint-disable-line\n  }\n};\n\nPostSchema.methods.upsertMetaPost = async function upsertMetaPost(metaId, linkObject) {\n  try {\n    const MetaPost = this.model('MetaPost');\n    let meta;\n    if (metaId) {\n      const _id = metaId._id || metaId;\n      if (_id) meta = await MetaPost.findOne({ _id });\n    }\n    const url = linkObject ? linkObject.url : this.url || this.link;\n    if (url && !meta) meta = await MetaPost.findOne({ url });\n\n    if (!meta) meta = new MetaPost(linkObject);\n    else meta.set(linkObject);\n    meta = await meta.save();\n\n    this.metaPost = meta;\n    return this.save();\n  } catch (err) {\n    console.log('upsertMetaPost error', err); // eslint-disable-line\n    return this;\n  }\n};\n\n// PostSchema.statics.sendOutInvestInfo = async function sendOutInvestInfo(postIds, userId) {\n//   try {\n//     const investments = await this.model('Invest').find({\n//       investor: userId,\n//       post: { $in: postIds }\n//     });\n//     const updatePosts = {\n//       _id: userId,\n//       type: 'UPDATE_POST_INVESTMENTS',\n//       payload: investments\n//     };\n//     socketEvent.emit('socketEvent', updatePosts);\n//   } catch (err) {\n//     console.log('sendOutInvestInfo error', err); // eslint-disable-line\n//   }\n// };\n\nasync function getPostData({ post, communityId }) {\n  if (!post.data) {\n    post.data = await this.model('PostData').findOne({ post: post._id, communityId });\n  }\n  return post;\n}\n\nPostSchema.methods.addTags = async function addTags({ tags, communityId }) {\n  try {\n    let post = this;\n    post = await getPostData({ post, communityId });\n\n    const combinedTags = [...new Set([...(post.tags || []), ...(tags || [])])];\n    post.tags = combinedTags;\n    post.data.tags = combinedTags;\n    await post.data.save();\n    // linkObject.tags = combinedTags;\n    return post.save();\n  } catch (err) {\n    return console.log('error adding tags', err); // eslint-disable-line\n  }\n};\n\nPostSchema.statics.sendOutMentions = async function sendOutMentions(\n  mentions,\n  post,\n  mUser,\n  comment\n) {\n  try {\n    let textParent = comment || post;\n    const promises = mentions.map(async mention => {\n      const type = comment ? 'comment' : 'post';\n\n      mUser = await this.model('User').findOne(\n        { _id: mUser._id || mUser },\n        'blockedBy blocked name role'\n      );\n\n      const blocked =\n        mUser.blockedBy.find(u => u === mention) ||\n        mUser.blocked.find(u => u === mention);\n\n      if (blocked) textParent.mentions = textParent.mentions.filter(m => m !== blocked);\n\n      let query = { handle: mention };\n\n      let group;\n      if (mention === 'everyone') {\n        if (mUser.role !== 'admin') return null;\n        query = {}; // TODO should this this as community\n        group = ['everyone'];\n        createMentionNotification({\n          post,\n          user: { _id: null },\n          mUser,\n          type,\n          Notification: this.model('Notification'),\n          group,\n          mention\n        });\n      }\n\n      const users = await this.model('User').find(\n        query,\n        'deviceTokens email name notificationSettings'\n      );\n\n      users.forEach(async user => {\n        const action = ' mentioned you in a ' + type;\n        let alert = (mUser.name || mUser) + action;\n        if (mention === 'everyone' && post.body) alert = post.body;\n        // TODO batch notifications & emails\n\n        const payload = {\n          fromUser: mUser,\n          toUser: user,\n          post,\n          action,\n          noteType: 'mention'\n        };\n\n        sendNotification(user, alert, payload);\n\n        if (mention === 'everyone') return;\n\n        createMentionNotification({\n          post,\n          user,\n          mUser,\n          type,\n          Notification: this.model('Notification'),\n          group,\n          mention\n        });\n      });\n      return null;\n    });\n\n    await Promise.all(promises);\n    textParent = await textParent.save();\n    textParent.updateClient();\n    return textParent;\n  } catch (err) {\n    return console.log('sendOutMentions error', err); // eslint-disable-line\n  }\n};\n\nasync function createMentionNotification({\n  post,\n  user,\n  mUser,\n  type,\n  Notification,\n  group,\n  mention\n}) {\n  const dbNotificationObj = {\n    post: post._id,\n    forUser: user._id,\n    group,\n    byUser: mUser._id || mUser,\n    amount: null,\n    type: type + 'Mention',\n    personal: true,\n    read: false\n  };\n\n  const newDbNotification = new Notification(dbNotificationObj);\n  const note = await newDbNotification.save();\n\n  const newNotifObj = {\n    _id: group ? null : mention,\n    type: 'ADD_ACTIVITY',\n    payload: note\n  };\n\n  socketEvent.emit('socketEvent', newNotifObj);\n}\n\n// pruneFeed (only for link posts)\nPostSchema.methods.pruneFeed = async function pruneFeed({ communityId }) {\n  const post = this;\n\n  if (!post.data) {\n    post.data = await this.model('PostData').findOne({ post: post._id, communityId });\n  }\n  const { shares } = post.data;\n\n  if (post.type !== 'link') throw new Error('Should not prune anything but links');\n  if (!communityId) throw new Error('missing community');\n\n  // Thread has no children - remove everything\n  const children = await this.model('Post').countDocuments({ parentPost: post._id });\n\n  // there is no way to remove post link\n  // maybe we shouldn't 'invest in links automatically'?\n  if (!children && !shares) {\n    await post.remove();\n    return null;\n  }\n\n  const communityChildren = await this.model('Post').countDocuments({\n    communityId,\n    parentPost: post._id\n  });\n\n  if (communityChildren || shares) return post;\n\n  await this.model('PostData')\n    .deleteOne({ post: post._id, communityId })\n    .exec();\n\n  return post;\n};\n\nasync function updateParentPostOnRemovingChild(post) {\n  const { communityId } = post;\n\n  if (!communityId) {\n    throw new Error('error missing post community id!', post.toObject());\n  }\n  let parent = await post\n    .model('Post')\n    .findOne({ _id: post.linkParent })\n    .populate({ path: 'data', match: { communityId } });\n\n  if (parent) parent = await parent.pruneFeed({ communityId });\n\n  if (!parent) return null;\n  if (post.hidden) return parent;\n\n  // parent.data = await post.model('PostData').findOne({ post: parent._id, communityId });\n  if (!post.data) {\n    post.data = await post.model('PostData').findOne({ post: post._id, communityId });\n  }\n\n  if (!post.data || !parent.data) throw new Error('missing post data');\n\n  // TODO maybe always update the time?\n  const shouldUpdateTime = post.postDate === parent.data.latestComment;\n  const shouldUpdateRank = post.data.rank >= parent.data.rank;\n\n  if (shouldUpdateRank || shouldUpdateTime) {\n    parent = await parent.updateRank({ communityId, shouldUpdateTime });\n  }\n  return parent;\n}\n\n// TODO we should replace post with a dummy post if post has\n// comments or replies so we can preserver\nPostSchema.post('remove', async function postRemove(post, next) {\n  if (post.linkParent && post.type !== 'comment') {\n    await updateParentPostOnRemovingChild(post);\n  }\n\n  // await this.model('CommunityFeed').removeFromAllFeeds(doc);\n  const note = this.model('Notification')\n    .deleteMany({ post: post._id })\n    .exec();\n  const feed = this.model('Feed')\n    .deleteMany({ post: post._id })\n    .exec();\n  const data = this.model('PostData')\n    .deleteMany({ post: post._id })\n    .exec();\n\n  let metaPost;\n  // if (post.type === 'link' && !post.parentParent) {\n  //   metaPost = await this.model('MetaPost')\n  //   .deleteMany({ post: post._id })\n  //   .exec();\n  // }\n\n  let commentNote;\n  // remove notifications\n  if (post.type === 'comment' || post.type === 'repost') {\n    commentNote = this.model('Notification')\n      .deleteMany({ comment: post._id })\n      .exec();\n  }\n\n  await Promise.all([note, feed, data, metaPost, commentNote]);\n  return next();\n});\n\nPostSchema.methods.incrementUnread = async function incrementUnread({\n  communityId,\n  community\n}) {\n  await this.model('CommunityMember').updateMany(\n    { communityId },\n    { $inc: { unread: 1 } }\n  );\n  pubsub.publish(UPDATE_UNREAD, { community, communityId: communityId.toString() });\n};\n\nmodule.exports = mongoose.model('Post', PostSchema);\n"],"file":"post.model.js"}