{"version":3,"sources":["../../../src/api/post/html.js"],"names":["fbHeader","relevantHeader","URL_REGEX","RegExp","HTML_REGEX","exports","extractDomain","url","domain","indexOf","split","noPrefix","replace","stripHTML","text","getReadable","uri","article","body","jar","headers","match","doc","jsdom","features","FetchExternalResources","ProcessExternalResources","Readability","parse","Error","err","console","log","trimToLength","length","Array","prototype","slice","call","getElementsByTagName","forEach","item","remove","totalLength","el","elChildNode","childNodes","child","nodeType","textContent","l","generatePreview","reqUrl","noReadability","$","cheerio","load","redirect","redirectUrl","attribs","content","canonical","href","test","articleUrl","data","title","description","image","news_keywords","keywords","author","miltiElement","meta","$title","keys","Object","eq","s","key","property","name","itemprop","find","m","trim","tags","originalUrl","cannonicalUrl","k1","map","k","k2","k3","filter","Set","pathname","protocol","host","amp","ampKeywords","ampAuthor","JSON","metaAuthor","a","isArray","toLowerCase","short","excerpt","innerHTML","byline","by","Number","isNaN","Date","getTime","substring","lastIndexOf","obj","shortText","articleAuthor","result"],"mappings":"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","sourcesContent":["import request from 'request-promise-any';\nimport jsdom from 'jsdom';\nimport { Readability } from 'readability/index';\nimport cheerio from 'cheerio';\nimport { parse as parseUrl } from 'url';\n\n/* eslint no-console: 0 */\n\nconst fbHeader = {\n  'User-Agent':\n    'facebookexternalhit/1.1 (+http://www.facebook.com/externalhit_uatext.php)'\n};\n\nconst relevantHeader = {\n  'User-Agent':\n    'This is a user request for article matadata for Relevant Community (https://relevant.community | info@relevant.community)'\n};\n\nconst URL_REGEX = new RegExp(\n  /(http(s)?:\\/\\/.)?(www\\.)?[-a-zA-Z0-9@:%_+~#=]{2,256}\\.[a-z]{2,10}\\b([-a-zA-Z0-9@:%_+~#?&//=]*)/\n);\nconst HTML_REGEX = new RegExp(/<[^>]*>/, 'gm');\n\nexports.extractDomain = url => {\n  let domain;\n  if (url.indexOf('://') > -1) {\n    domain = url.split('/')[2];\n  } else {\n    domain = url.split('/')[0];\n  }\n  domain = domain.split(':')[0];\n\n  let noPrefix = domain;\n\n  if (domain.indexOf('www.') > -1) {\n    noPrefix = domain.replace('www.', '');\n  }\n  return noPrefix;\n};\n\nfunction stripHTML(text) {\n  return (text || '').replace(HTML_REGEX, '');\n}\n\nexports.getReadable = async uri => {\n  let article;\n  try {\n    const body = await request({\n      url: uri,\n      jar: true,\n      headers:\n        uri.match('bloomberg.com') || uri.match('washingtonpost.com')\n          ? relevantHeader\n          : fbHeader\n    });\n\n    // let doc = new JSDOMParser().parse(body);\n\n    const doc = jsdom.jsdom(body, {\n      features: {\n        FetchExternalResources: false,\n        ProcessExternalResources: false\n      }\n    });\n    article = new Readability(uri, doc).parse();\n    if (!article) throw new Error(\"Couldn't parse doc\");\n    // console.log(article.byline);\n  } catch (err) {\n    console.log('ERROR getting readable version', uri);\n    throw err;\n  }\n  return article;\n};\n\nexports.trimToLength = (doc, length) => {\n  Array.prototype.slice\n    .call(doc.getElementsByTagName('figure'))\n    .forEach(item => item.remove());\n\n  let totalLength = 0;\n  Array.prototype.slice.call(doc.getElementsByTagName('*')).forEach(el => {\n    if (totalLength > length) return el.remove();\n    const elChildNode = el.childNodes;\n    elChildNode.forEach(child => {\n      if (child.nodeType === 3) {\n        const text = child.textContent;\n        const l = text.split(/\\s+/).length;\n        if (l > 4) totalLength += l;\n      }\n    });\n    return null;\n  });\n  return doc;\n};\n\nexports.generatePreview = async (body, uri, reqUrl, noReadability) => {\n  // console.log('Generate Preview ', uri);\n\n  body = body.replace('<!--', '').replace('-->', '');\n  let $ = cheerio.load(body);\n\n  const redirect = $(\"meta[http-equiv='refresh']\")[0];\n  let redirectUrl;\n\n  if (redirect && redirect.attribs && redirect.attribs.content) {\n    redirectUrl = redirect.attribs.content.split('URL=')[1];\n    if (redirectUrl) redirectUrl = redirectUrl.replace(/'/g, '');\n    if (\n      redirectUrl &&\n      uri.match('twitter.com') &&\n      redirectUrl.match('mobile.twitter.com')\n    ) {\n      redirectUrl = uri;\n    }\n  }\n\n  if (\n    redirectUrl &&\n    redirectUrl.match('http') &&\n    exports.extractDomain(redirectUrl) !== '' &&\n    exports.extractDomain(redirectUrl) !== exports.extractDomain(uri) &&\n    reqUrl !== redirectUrl\n  ) {\n    return {\n      redirect: true,\n      uri: redirectUrl\n    };\n  }\n\n  let canonical = $(\"link[rel='canonical']\")[0];\n  if (canonical && canonical.attribs) canonical = canonical.attribs;\n  else canonical = null;\n\n  if (canonical && canonical.href) {\n    if (!URL_REGEX.test(canonical.href)) {\n      canonical.href = exports.extractDomain(uri) + canonical.href;\n    }\n  }\n\n  if (\n    canonical &&\n    canonical.href &&\n    canonical.href.match('http') &&\n    exports.extractDomain(canonical.href) !== exports.extractDomain(uri) &&\n    reqUrl !== canonical.href\n  ) {\n    return {\n      redirect: true,\n      uri: canonical.href\n    };\n  }\n\n  if (uri.match('apple.news')) {\n    try {\n      const articleUrl = body\n        .match(/redirectToUrl\\(\"(.*)\"/)[0]\n        .replace(/redirectToUrl\\(|\"/g, '');\n      if (articleUrl) {\n        return {\n          redirect: true,\n          uri: articleUrl\n        };\n      }\n    } catch (err) {\n      console.log(err);\n    }\n  }\n\n  let data = {\n    title: null,\n    description: null,\n    image: null,\n    'og:type': null,\n    'og:title': null,\n    'og:description': null,\n    'og:image': null,\n    'og:image:url': null,\n    'og:url': null,\n    'al:web:url': null,\n    'twitter:title': null,\n    'twitter:image': null,\n    'twitter:image:src': null,\n    'twitter:description': null,\n    'twitter:site': null,\n    'twitter:creator': null,\n    news_keywords: null,\n    keywords: null,\n    'article:tag': null,\n    author: null,\n    'article:author': null\n  };\n\n  // ads milti element concotenation\n  const miltiElement = [\n    'news_keywords',\n    'keywords',\n    'article:tag',\n    'author',\n    'article:author'\n  ];\n  const meta = $('meta');\n  const $title = $('title');\n  const keys = Object.keys(meta);\n\n  data.title = $title.eq(0).text();\n\n  Object.keys(data).forEach(s => {\n    keys.forEach(key => {\n      if (\n        meta[key].attribs &&\n        (meta[key].attribs.property === s ||\n          meta[key].attribs.name === s ||\n          meta[key].attribs.itemprop === s)\n      ) {\n        if (!data[s]) data[s] = meta[key].attribs.content;\n        else if (miltiElement.find(m => m === s)) {\n          data[s] += ', ' + meta[key].attribs.content;\n        }\n      }\n    });\n  });\n\n  let description = null;\n  let title = null;\n  let image = null;\n\n  title = data['og:title'] || data['twitter:title'] || data.title;\n  description = stripHTML(\n    data.description || data['og:description'] || data['twitter:description']\n  ).trim();\n  image =\n    data['og:image'] ||\n    data['og:image:url'] ||\n    data['twitter:image'] ||\n    data['twitter:image:src'] ||\n    data.image;\n\n  // why prioritise og tags? flipboard?\n  let url;\n  if (uri.match('flip.it')) {\n    url = data['al:web:url'] || data['og:url'] || uri;\n  }\n  url = uri || data['al:web:url'] || data['og:url'];\n  const tags = data.news_keywords || data.keywords;\n  const domain = exports.extractDomain(url);\n\n  const originalUrl = parseUrl(uri);\n  const cannonicalUrl = parseUrl(url);\n\n  const k1 = data.keywords ? data.keywords.split(',').map(k => k.trim()) : [];\n  const k2 = data.news_keywords ? data.news_keywords.split(',').map(k => k.trim()) : [];\n  const k3 = data['article:tag']\n    ? data['article:tag']\n        .split(',')\n        .map(k => k.replace('--primarykeyword-', '').trim())\n        .filter(k => !k.match('--'))\n    : [];\n\n  let keywords = [...new Set([...k1, ...k2, ...k3])];\n\n  // general fix for mismatch\n  if (originalUrl.pathname !== cannonicalUrl.pathname) {\n    url = originalUrl.protocol + '//' + originalUrl.host + originalUrl.pathname;\n  }\n\n  let amp = $('[type=\"application/ld+json\"]')\n    .eq(0)\n    .text();\n  let ampKeywords;\n  let ampAuthor;\n  if (amp) {\n    try {\n      amp = amp\n        .replace('//<![CDATA[', '')\n        .replace('// <![CDATA[', '')\n        .replace('//]]>', '')\n        .replace('// ]]>', '')\n        .trim();\n      amp = JSON.parse(amp);\n      if (!amp) throw new Error('no amp');\n      ampAuthor = amp.author ? amp.author.name : null;\n      ampKeywords = amp.keywords && amp.keywords.length ? amp.keywords : null;\n      if (typeof ampAuthor === 'string') ampAuthor = [ampAuthor];\n    } catch (err) {\n      // console.log(amp);\n      // console.log(err);\n    }\n  }\n  // console.log('amp: ', amp ? JSON.parse(amp) : null);\n\n  // console.log('url ', url);\n  // console.log('article:author ', data['article:author']);\n  // console.log('author ', data['author']);\n  // console.log('amp author ', ampAuthor);\n  // console.log('regular keywords ', keywords);\n  // console.log('amp keywords', ampKeywords);\n\n  data.author = data.author || '';\n\n  data['article:author'] = data['article:author'] || '';\n\n  const metaAuthor = data.author\n    .split(/,|\\sand\\s/)\n    .map(a => a.trim())\n    .filter(a => a !== '');\n\n  ampAuthor = ampAuthor || [];\n\n  let author = [...ampAuthor, ...metaAuthor];\n  author = [...new Set(author)].filter(a => !a.match('http'));\n\n  if (ampKeywords && ampKeywords.length && !keywords.length) {\n    if (Array.isArray(ampKeywords)) {\n      ampKeywords = ampKeywords.filter(k => !k.match('@')).map(k => k.toLowerCase());\n    }\n  }\n\n  keywords = keywords.map(k => k.toLowerCase());\n  keywords = [...new Set([...(keywords || []), ...(ampKeywords || [])])];\n\n  keywords = keywords\n    .map(k => k.replace(/tag:|publication:|elevated:false|lockedpostsource:0/, ''))\n    .filter(k => k.trim() !== '');\n\n  let doc = jsdom.jsdom(body, {\n    features: {\n      FetchExternalResources: false,\n      ProcessExternalResources: false\n    }\n  });\n\n  let article;\n\n  if (!noReadability) {\n    try {\n      article = new Readability(url, doc).parse();\n    } catch (err) {\n      console.log('Readability ERR ', err);\n    }\n  }\n\n  let short;\n  if (article && article.article) {\n    try {\n      short = article.excerpt || exports.trimToLength(article.article, 140).innerHTML;\n    } catch (err) {\n      console.log(err);\n    }\n    if (!author.length && article.byline) {\n      const by = article.byline\n        .split(/\\n|,|â€¢/)\n        .map(a => a.replace(/by|by:\\s/i, '').trim())\n        .filter(\n          a =>\n            a !== '' &&\n            !a.match(/^by$/i) &&\n            a.length > 2 &&\n            !a.match('UTC') &&\n            Number.isNaN(new Date(a).getTime()) &&\n            !a.match('http')\n          // && !a.match(/2017|2016|2015|2018/)\n        );\n      author = by[0] ? [by[0]] : [];\n    }\n  }\n\n  if (image && image.indexOf('http://') !== 0 && image.indexOf('https://') !== 0) {\n    image = 'http://' + domain + image;\n  }\n\n  if (!title && url.match('.pdf')) {\n    title = url.substring(url.lastIndexOf('/') + 1);\n  }\n\n  const obj = {\n    image,\n    description,\n    title,\n    url,\n    domain,\n    tags,\n    shortText: short,\n    articleAuthor: author || null,\n    keywords\n  };\n\n  if (!image || !title) {\n    // console.log('url parse incomplete');\n    // console.log(data);\n    // console.log(uri);\n    // console.log($('head').html());\n  }\n\n  $ = null;\n  body = null;\n  article = null;\n  data = null;\n  doc = null;\n\n  return {\n    redirect: false,\n    result: obj\n  };\n};\n"],"file":"html.js"}