{"version":3,"sources":["../../../src/api/user/user.controller.js"],"names":["sigUtil","require","sendConfirmation","user","newUser","text","confirmUrl","process","env","API_SERVER","handle","confirmCode","data","from","to","email","subject","html","sendResetEmail","queryString","resetUrl","resetPasswordToken","exports","forgot","req","res","next","urlParts","url","parse","search","string","body","test","query","$regex","$options","User","findOne","errorText","Error","rand","crypto","randomBytes","token","toString","resetPasswordExpires","Date","now","save","status","json","username","err","confirm","middleware","params","code","confirmed","addReward","type","sendConfirmationCode","webOnboard","step","path","findOneAndUpdate","$set","projection","new","then","catch","onboarding","resetPassword","password","success","changePassword","userId","_id","oldPass","String","oldPassword","newPass","newPassword","findById","authenticate","sendStatus","blocked","blockedBy","limit","name","RegExp","$and","$or","$nin","find","sort","parseInt","users","index","rank","checkUser","omitSelf","formatted","omit","$ne","userExists","testData","skip","community","pagerank","$gt","rel","CommunityMember","populate","select","list","map","r","toObject","u","relevance","create","invitecode","BANNED_USER_HANDLES","includes","usingWeb3","ethLogin","additionalFields","getEthFields","userObj","phone","image","provider","role","Invite","processInvite","initialCoins","hashedPassword","salt","signature","msg","profile","ethAddress","show","id","me","memberships","match","getSubscriptions","topTags","addr","tokenBalance","ethUtils","getBalance","updateClient","destroy","equals","deleteOne","updateComunity","succcess","updateHandle","used","usedEmail","updateMany","embeddedUser","multi","update","authUser","JSON","stringify","reqUser","updateImage","updateName","bio","deviceTokens","Post","block","userPromise","$addToSet","blockPromise","sub1","Subscription","deleteMany","following","follower","exec","sub2","feed1","Feed","feed2","results","Promise","all","unblock","$pull","updateUserTokenBalance","length","userBalance","updateUserNotifications","notificationSettings","subscription","newSettings","digest","findIndex","desktopSubscriptions","s","endpoint","keys","auth","p256dh","sig","acc","recovered","recoverTypedSignatureLegacy","toLowerCase","exists","cashOut","customAmount","address","nonce","getNonce","earning","userCashoutLog","Earnings","cashOutAttempt","cashedOut","reduce","a","e","cashOutAmt","maxClaim","CASHOUT_MAX","canClaim","Math","min","balance","airdropTokens","amount","Number","allocatedRewards","getParam","console","log","bnAmount","sign","earningId","authCallback","redirect"],"mappings":"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","sourcesContent":["import crypto from 'crypto-promise';\nimport uuid from 'uuid/v4';\n// import sigUtil from 'eth-sig-util';\nimport merge from 'lodash/merge';\nimport url from 'url';\n// eslint-disable-next-line import/named\nimport { signToken } from 'server/auth/auth.service';\nimport Invite from 'server/api/invites/invite.model';\nimport { sendEmail, addUserToEmailList, removeFromEmailList } from 'server/utils/mail';\nimport { BANNED_USER_HANDLES, CASHOUT_MAX } from 'server/config/globalConstants';\n// import { idUtils } from '3box';\nimport { verifyEthSignature } from 'server/auth/web3/passport';\nimport Earnings from 'server/api/earnings/earnings.model';\nimport User from './user.model';\nimport Post from '../post/post.model';\nimport CommunityMember from '../community/community.member.model';\nimport Subscription from '../subscription/subscription.model';\nimport Feed from '../feed/feed.model';\nimport * as ethUtils from '../../utils/ethereum';\nimport { logCashOut } from '../../utils/cashOut';\n\nconst sigUtil = require('eth-sig-util');\n\nasync function sendConfirmation(user, newUser) {\n  let text = '';\n  if (newUser) text = ', welcome to Relevant';\n  const confirmUrl = `${process.env.API_SERVER}/user/confirm/${user.handle}/${user.confirmCode}`;\n  const data = {\n    from: 'Relevant <info@relevant.community>',\n    to: user.email,\n    subject: 'Relevant Email Confirmation',\n    html: `\n        Hi @${user.handle}${text}!\n      <br />\n      <br />\n        Please click on the link below to confirm your email address:\n      <br />\n      <br />\n      <a href=\"${confirmUrl}\" target=\"_blank\">Confirm Email</a>\n      <br />\n      <br />\n      `\n  };\n  await sendEmail(data);\n\n  return { email: user.email };\n}\n\nasync function sendResetEmail(user, queryString) {\n  const resetUrl = `${process.env.API_SERVER}/user/resetPassword/${user.resetPasswordToken}${queryString}`;\n  const data = {\n    from: 'Relevant <info@relevant.community>',\n    to: user.email,\n    subject: 'Reset Relevant Password',\n    html: `\n      Hi, @${user.handle}\n      <br/><br/>\n      You are receiving this because you have requested the reset of the password for your account.<br />\n      Please click on the following link, or paste this into your browser to complete the process:<br/><br/>\n      ${resetUrl}<br/><br/>\n      If you did not request a password reset, please ignore this email and your password will remain unchanged.`\n  };\n  return sendEmail(data);\n}\n\nexports.forgot = async (req, res, next) => {\n  let email;\n  try {\n    const urlParts = url.parse(req.url, true);\n    const queryString = urlParts.search || '';\n    const string = req.body.user;\n\n    email = /^.+@.+\\..+$/.test(string);\n    const query = email\n      ? { email: { $regex: `^${string}$`, $options: 'i' } }\n      : { handle: { $regex: `^${string}$`, $options: 'i' } };\n    let user = await User.findOne(\n      query,\n      'resetPasswordToken resetPasswordExpires email handle'\n    );\n    if (!user) {\n      const errorText = email\n        ? 'No user with this email exists'\n        : \"Couldn't find user with this username\";\n      throw new Error(errorText);\n    }\n    const rand = await crypto.randomBytes(32);\n    const token = rand.toString('hex');\n    user.resetPasswordToken = token;\n    user.resetPasswordExpires = Date.now() + 3600000;\n    user = await user.save();\n    await sendResetEmail(user, queryString);\n    return res.status(200).json({ email: user.email, username: user.handle });\n  } catch (err) {\n    return next(err);\n  }\n};\n\nexports.confirm = async (req, res, next) => {\n  try {\n    let user;\n    let middleware = false;\n    if (!req.params) req.params = {};\n    if (req.params.user) middleware = true;\n    const confirmCode = req.params.code || req.body.code;\n    const handle = req.params.user || req.body.user;\n    if (!handle || !confirmCode) throw new Error('Missing user id or confirmation token');\n    user = await User.findOne({ handle, confirmCode });\n    if (!user) throw new Error('Wrong confirmation code');\n    if (user.confirmed) throw new Error('Email is already confirmed.');\n    user.confirmed = true;\n    user = await user.addReward({ type: 'email' });\n    user = await user.save();\n    await addUserToEmailList(user);\n    req.confirmed = true;\n    return middleware ? next() : res.status(200).json(user);\n  } catch (err) {\n    return next();\n  }\n};\n\nexports.sendConfirmationCode = async (req, res, next) => {\n  try {\n    let user = await User.findOne(\n      { handle: req.user.handle },\n      'email confirmCode name handle'\n    );\n    user.confirmCode = uuid();\n    user = await user.save();\n    const status = await sendConfirmation(user);\n    return res.status(200).json(status);\n  } catch (err) {\n    return next(err);\n  }\n};\n\nexports.webOnboard = (req, res, next) => {\n  const { handle } = req.user;\n  const { step } = req.params;\n  const path = `webOnboard.${step}`;\n  User.findOneAndUpdate(\n    { handle },\n    { $set: { [path]: true } },\n    { projection: 'webOnboard', new: true }\n  )\n    .then(newUser => {\n      res.status(200).json(newUser);\n    })\n    .catch(next);\n};\n\nexports.onboarding = (req, res, next) => {\n  const { handle } = req.user;\n  const { step } = req.params;\n  User.findOneAndUpdate(\n    { handle },\n    { onboarding: step },\n    { projection: 'onboarding', new: true }\n  )\n    .then(newUser => {\n      res.status(200).json(newUser);\n    })\n    .catch(next);\n};\n\n/**\n * Reset password\n */\nexports.resetPassword = async (req, res, next) => {\n  try {\n    const { token, password } = req.body;\n    let { user } = req;\n    if (!token && !user) throw new Error('token missing');\n    if (!user) {\n      user = await User.findOne({ resetPasswordToken: token });\n      if (user && user.resetPasswordExpires > Date.now()) {\n        throw new Error('Password reset time has expired');\n      }\n    }\n    if (!user) throw new Error('No user found');\n    if (!user.onboarding) user.onboarding = 0;\n\n    user.password = password;\n    user = await user.save();\n    res.status(200).json({ success: true });\n  } catch (err) {\n    next(err);\n  }\n};\n\n/**\n * Change a users password\n */\nexports.changePassword = async (req, res, next) => {\n  try {\n    const userId = req.user._id;\n    const oldPass = String(req.body.oldPassword);\n    const newPass = String(req.body.newPassword);\n    const user = User.findById(userId);\n    if (user.authenticate(oldPass)) {\n      user.password = newPass;\n      await user.save();\n      return res.sendStatus(200);\n    }\n    throw new Error('incorrect password');\n  } catch (err) {\n    return next(err);\n  }\n};\n\nexports.search = (req, res, next) => {\n  let blocked = [];\n  const { user } = req;\n  if (user) {\n    blocked = [...user.blocked, ...user.blockedBy];\n  }\n\n  const { search, limit } = req.query;\n  const name = new RegExp(search, 'i');\n  const query = {\n    $and: [{ $or: [{ name }, { handle: name }] }, { handle: { $nin: blocked } }]\n  };\n  User.find(query, 'handle name image')\n    .sort({ handle: 1 })\n    .limit(parseInt(limit, 10))\n    .then(users => {\n      res.json(200, users);\n    })\n    .catch(next);\n};\n\n/**\n * Get list of users\n * restriction: 'admin'\n */\nexports.index = (req, res, next) => {\n  const { search } = req.query;\n  let query = {};\n  if (search) {\n    const name = new RegExp(req.query.name, 'i');\n    query = { name };\n  }\n\n  User.find(query, '-salt -hashedPassword')\n    .sort({ rank: -1 })\n    .then(users => {\n      res.status(200).json(users);\n    })\n    .catch(next);\n};\n\nexports.checkUser = async (req, res, next) => {\n  try {\n    const { name, email, omitSelf } = req.query;\n    const { user } = req;\n    let query = {};\n    let type;\n\n    if (name === 'everyone') {\n      return res.status(200).json({ type });\n    }\n    let formatted;\n    let omit;\n    if (user && omitSelf) {\n      omit = user.handle;\n    }\n\n    if (name) {\n      type = 'user';\n      formatted = '^' + name + '$';\n      query = {\n        ...query,\n        $and: [\n          { handle: { $regex: formatted, $options: 'i' } },\n          { handle: { $ne: omit } }\n        ]\n      };\n    } else if (email) {\n      formatted = '^' + email + '$';\n      type = 'email';\n      query = {\n        $and: [{ email: { $regex: formatted, $options: 'i' } }, { handle: { $ne: omit } }]\n      };\n    }\n\n    const userExists = await User.findOne(query, '_id handle');\n    if (userExists) return res.status(200).json(userExists);\n    return res.status(200).json(null);\n  } catch (err) {\n    return next(err);\n  }\n};\n\nexports.testData = async (req, res, next) => {\n  try {\n    const limit = parseInt(req.query.limit, 10) || 5;\n    const skip = parseInt(req.query.skip, 10) || 0;\n    const community = req.query.community || 'relevant';\n    const query = { community, pagerank: { $gt: 0 } };\n\n    const rel = await CommunityMember.find(\n      query,\n      'pagerank level community communityId pagerankRaw'\n    )\n      .limit(limit)\n      .skip(skip)\n      // .sort(sort)\n      .populate({\n        path: 'user',\n        select: 'handle name votePower image bio'\n      });\n\n    return res.status(200).json(rel);\n  } catch (err) {\n    return next(err);\n  }\n};\n\nexports.list = async (req, res, next) => {\n  try {\n    const { user } = req;\n    const limit = parseInt(req.query.limit, 10) || 5;\n    const skip = parseInt(req.query.skip, 10) || 0;\n\n    let blocked = [];\n    if (user) {\n      blocked = [...user.blocked, ...user.blockedBy];\n    }\n    const community = req.query.community || 'relevant';\n\n    const sort = { pagerank: -1 };\n    const query = { community, user: { $nin: blocked } };\n\n    const rel = await CommunityMember.find(query)\n      .limit(limit)\n      .skip(skip)\n      .sort(sort)\n      .populate({\n        path: 'user',\n        select: 'handle name image bio'\n      });\n\n    const users = rel.map(r => {\n      r = r.toObject();\n      if (!r.user) return null;\n      let u = { ...r.user }; // eslint-disable-line\n      u.relevance = {};\n      delete r.user;\n      u.relevance = r;\n      return u;\n    });\n\n    return res.status(200).json(users);\n  } catch (err) {\n    return next(err);\n  }\n};\n\n/**\n * Creates a new user\n */\nexports.create = async (req, res, next) => {\n  try {\n    const confirmCode = uuid();\n    let { user } = req.body;\n    const { invitecode } = req.body;\n\n    if (BANNED_USER_HANDLES.includes(user.name)) {\n      throw new Error('this username is taken');\n    }\n    if (!user.email) throw new Error('missing email');\n\n    const usingWeb3 = !!user.ethLogin;\n    const additionalFields = usingWeb3 ? await getEthFields(user) : {};\n\n    if (additionalFields.user) {\n      const token = signToken(additionalFields.user._id, 'user');\n      return res.status(200).json({ token, user: additionalFields.user });\n    }\n\n    const userObj = {\n      handle: user.name,\n      name: user.name,\n      phone: user.phone,\n      email: user.email,\n      password: user.password,\n      image: user.image,\n      provider: usingWeb3 ? 'web3' : 'local',\n      role: 'user',\n      relevance: 0,\n      confirmCode,\n      ...additionalFields\n    };\n\n    if (usingWeb3) delete userObj.password;\n\n    user = new User(userObj);\n    user = await user.save();\n\n    if (invitecode) user = await Invite.processInvite({ invitecode, user });\n    user = await user.initialCoins();\n\n    const token = signToken(user._id, 'user');\n    if (!user.confirmed) sendConfirmation(user, true);\n\n    user = await user.save();\n    user = user.toObject();\n    delete user.hashedPassword;\n    delete user.salt;\n    delete user.password;\n    return res.status(200).json({ token, user });\n  } catch (err) {\n    return next(err);\n  }\n};\n\nasync function getEthFields({ signature, msg, ...profile }) {\n  const ethLogin = verifyEthSignature({ signature, msg });\n  const user = await User.findOne({ ethLogin });\n  if (user) {\n    user.email = profile.email;\n    user.image = profile.image;\n    user.name = profile.name;\n    await user.save();\n    return { user };\n  }\n  return { ethLogin, ethAddress: [ethLogin] };\n}\n\n// async function processBoxFields(user) {\n//   const { signature, boxAddress, DID } = user;\n//   if (!signature || !boxAddress || !DID) throw new Error('Missing 3box parametrs');\n//   const claim = await idUtils.verifyClaim(signature, { auth: true });\n//   const { payload } = claim;\n//   const { exp, DID: claimDID, address } = payload;\n//   const claimExp = new Date(exp * 1000);\n//   if (claimExp < new Date()) throw new Error('Expired 3box signature');\n//   if (DID !== claimDID) throw new Error('Invalid 3box DID in signature');\n//   if (boxAddress !== address) throw new Error('Invalid Ethereum address in signature');\n//   const userExists = await User.findOne({ boxDID: DID });\n//   if (userExists) {\n//     userExists.email = user.email;\n//     userExists.image = user.image;\n//     userExists.name = user.name;\n//     await userExists.save();\n//     return { user: userExists };\n//   }\n//   return { boxDID: DID, boxAddress, confirmed: !!user.email };\n// }\n\n/**\n * Get a single user\n */\nexports.show = async function show(req, res, next) {\n  try {\n    let { user } = req;\n    let handle = req.params.id;\n\n    let me = null;\n    let memberships;\n    if (!handle && user) {\n      handle = user.handle;\n    }\n    if (user && user._id) {\n      memberships = await CommunityMember.find({ user: user._id });\n    }\n    me = user && user.handle === handle;\n    const community = req.query.community || 'relevant';\n\n    // don't show blocked user;\n    let blocked = [];\n    if (user) {\n      blocked = [...(user.blocked || []), ...(user.blockedBy || [])];\n      if (blocked.find(u => u === handle)) {\n        return res.status(200).json({});\n      }\n    }\n\n    const select = me ? '+email' : null;\n    user = await User.findOne({ handle }, select).populate({\n      path: 'relevance',\n      match: { community },\n      select: 'pagerank relevanceRecord community'\n    });\n\n    if (!user) throw new Error('no such user ', handle);\n    user = await user.getSubscriptions();\n\n    // topic relevance\n    const relevance = await CommunityMember.find({ user: user._id })\n      .sort('-relevance')\n      .limit(5);\n    const userObj = user.toObject();\n    userObj.topTags = relevance || [];\n\n    res.status(200).json({ ...userObj, memberships });\n\n    // update token balance based on ETH account\n    if (me) {\n      const addr = user.ethAddress[0];\n      const tokenBalance = addr ? await ethUtils.getBalance(user.ethAddress[0]) : 0;\n      if (user.tokenBalance !== tokenBalance) {\n        user.tokenBalance = tokenBalance;\n        user = await user.save();\n        await user.updateClient();\n      }\n    }\n    return null;\n  } catch (err) {\n    return next(err);\n  }\n};\n\n/**\n * Deletes a user\n * restriction: 'admin' or user\n */\nexports.destroy = async (req, res, next) => {\n  try {\n    const { id } = req.params;\n    if (!req.user || !req.user.role === 'admin' || !req.user._id.equals(id)) {\n      throw new Error('no right to delete');\n    }\n    const user = await User.findOne({ _id: id });\n    await removeFromEmailList(user);\n    await User.deleteOne({ handle: req.params.id });\n    return res.sendStatus(204);\n  } catch (err) {\n    return next(err);\n  }\n};\n\nexports.updateComunity = async (req, res, next) => {\n  try {\n    const { user } = req;\n    if (!user) throw new Error('missing user');\n    const { community } = req.body;\n    user.community = community;\n    await user.save();\n    return res.status(200).json({ succcess: true });\n  } catch (err) {\n    return next(err);\n  }\n};\n\nexports.updateHandle = async (req, res, next) => {\n  try {\n    let { user } = req;\n\n    if (user.role !== 'temp') throw new Error('Cannot change user handle');\n\n    const { handle, email } = req.body.user;\n    if (!handle) throw new Error('missing handle');\n\n    // make sure its not used\n    if (handle !== user.handle) {\n      const used = await User.findOne({ handle });\n      if (used) throw new Error('This handle is already taken');\n    }\n\n    if (email && email !== user.email) {\n      const usedEmail = await User.findOne({ _id: { $ne: user._id }, email });\n      if (usedEmail) throw new Error('This email is already in use');\n      user.email = email;\n\n      user.confirmCode = uuid();\n      user = await user.save();\n      await sendConfirmation(user, true);\n    }\n    user.handle = handle;\n    user.role = 'user';\n\n    await addUserToEmailList(user);\n\n    const newUser = {\n      name: user.name,\n      image: user.image,\n      handle: user.handle,\n      _id: user._id\n    };\n\n    await CommunityMember.updateMany(\n      { user: user._id },\n      { embeddedUser: newUser },\n      { multi: true }\n    );\n\n    user = await user.save();\n\n    return res.status(200).json(user);\n  } catch (err) {\n    return next(err);\n  }\n};\n\nexports.update = async (req, res, next) => {\n  try {\n    const { role } = req.user;\n    const authUser = JSON.stringify(req.user._id);\n    const reqUser = JSON.stringify(req.body._id);\n    let updateImage = false;\n    let updateName = false;\n    let user;\n\n    if (authUser !== reqUser && role !== 'admin') {\n      throw new Error('Not authorized to edit this user');\n    }\n    user = await User.findOne({ _id: req.body._id }, '-salt -hashedPassword -relevance');\n    if (!user) throw new Error('user not found');\n\n    if (user.name !== req.body.name) {\n      updateName = true;\n      user.name = req.body.name;\n    }\n    if (user.image !== req.body.image) {\n      updateImage = true;\n      user.image = req.body.image;\n    }\n\n    user.bio = typeof req.body.bio === 'string' ? req.body.bio : user.bio;\n    user.deviceTokens = req.body.deviceTokens;\n\n    if (role === 'admin') {\n      user.role = req.body.role;\n    }\n\n    user = await user.save();\n    user.updateClient();\n\n    if (updateName || updateImage) {\n      const newUser = {\n        name: user.name,\n        image: user.image,\n        handle: user.handle,\n        _id: user._id\n      };\n\n      // Do this on a separate thread?\n      await Post.updateMany(\n        { user: user._id },\n        { embeddedUser: newUser },\n        { multi: true }\n      );\n\n      await CommunityMember.updateMany(\n        { user: user._id },\n        { embeddedUser: newUser },\n        { multi: true }\n      );\n    }\n    return res.status(200).json(user);\n  } catch (err) {\n    return next(err);\n  }\n};\n\nexports.block = async (req, res, next) => {\n  try {\n    let { user } = req;\n    const { block } = req.body;\n\n    if (user._id === block) throw new Error(\"You can't block yourself!\");\n\n    const userPromise = User.findOneAndUpdate(\n      { _id: user._id },\n      { $addToSet: { blocked: block } },\n      { new: true }\n    );\n    const blockPromise = User.findOneAndUpdate(\n      { _id: block },\n      { $addToSet: { blockedBy: user._id } },\n      { new: true }\n    );\n\n    // clear any existing subscriptions\n    const sub1 = Subscription.deleteMany({ following: user._id, follower: block }).exec();\n    const sub2 = Subscription.deleteMany({ following: block, follower: user._id }).exec();\n    const feed1 = Feed.deleteMany({ userId: user._id, from: block }).exec();\n    const feed2 = Feed.deleteMany({ userId: block, from: user._id }).exec();\n\n    const results = await Promise.all([\n      userPromise,\n      blockPromise,\n      sub1,\n      sub2,\n      feed1,\n      feed2\n    ]);\n    user = results[0];\n    return res.status(200).json(user);\n  } catch (err) {\n    return next(err);\n  }\n};\n\nexports.unblock = async (req, res, next) => {\n  try {\n    let { user } = req;\n    let { block } = req.body;\n    user = await User.findOneAndUpdate(\n      { handle: user.handle },\n      { $pull: { blocked: block } },\n      { new: true }\n    );\n    block = await User.findOneAndUpdate(\n      { _id: block },\n      { $pull: { blockedBy: user._id } }\n    );\n    res.status(200).json(user);\n  } catch (err) {\n    next(res, err);\n  }\n};\n\nexports.blocked = async (req, res, next) => {\n  try {\n    let { user } = req;\n    user = await User.findOne({ _id: user._id }).populate('blocked');\n    res.status(200).json(user);\n  } catch (err) {\n    next(err);\n  }\n};\n\nexports.updateUserTokenBalance = async (req, res, next) => {\n  try {\n    const { user } = req;\n    if (!user.ethAddress || !user.ethAddress.length) {\n      throw new Error('missing connected Ethereum address');\n    }\n    const userBalance = await ethUtils.getBalance(user.ethAddress[0]);\n    user.tokenBalance = userBalance;\n    await user.save();\n    res.status(200).json(user);\n  } catch (err) {\n    next(err);\n  }\n};\n\nexports.updateUserNotifications = async (req, res, next) => {\n  try {\n    const { user, body } = req;\n    const { notificationSettings, subscription, deviceTokens } = body;\n    const newSettings = merge(user.notificationSettings.toObject(), notificationSettings);\n\n    if (user.notificationSettings.email.digest !== newSettings.email.digest) {\n      if (!newSettings.email.digest) addUserToEmailList(user, 'nodigest');\n      else removeFromEmailList(user, 'nodigest');\n    }\n    user.notificationSettings = newSettings;\n\n    if (subscription) {\n      const findIndex = user.desktopSubscriptions.findIndex(\n        s =>\n          s.endpoint === subscription.endpoint &&\n          s.keys &&\n          s.keys.auth === subscription.keys.auth &&\n          s.keys.p256dh === subscription.keys.p256dh\n      );\n      if (findIndex === -1) {\n        user.desktopSubscriptions = [...user.desktopSubscriptions, subscription];\n      }\n    }\n    if (deviceTokens) {\n      user.deviceTokens = deviceTokens;\n    }\n    await user.save();\n    res.status(200).json(user);\n  } catch (err) {\n    next(err);\n  }\n};\n\nexports.ethAddress = async (req, res, next) => {\n  try {\n    let { user } = req;\n    const { msg, sig, acc } = req.body;\n    const recovered = sigUtil.recoverTypedSignatureLegacy({\n      data: msg,\n      sig\n    });\n    if (recovered !== acc.toLowerCase()) throw new Error('address does not match');\n\n    const exists = await User.findOne({ ethAddress: acc }, 'handle');\n    if (exists) throw new Error('This address is already in use by @' + exists.handle);\n\n    user = await User.findOne({ handle: user.handle }, 'ethAddress');\n    user.ethAddress = [acc];\n    if (!user.ethLogin) {\n      user.ethLogin = acc;\n    }\n\n    const userBalance = await ethUtils.getBalance(user.ethAddress[0]);\n    user.tokenBalance = userBalance;\n    await user.save();\n    res.status(200).json(user);\n  } catch (err) {\n    next(err);\n  }\n};\n\nexports.cashOut = async (req, res, next) => {\n  try {\n    let { user } = req;\n    const {\n      body: { customAmount }\n    } = req;\n    if (!user) throw new Error('Missing user when trying to claim tokens.');\n    if (!customAmount) throw new Error('Missing token claim amount.');\n\n    if (!user.ethAddress[0]) throw new Error('No Ethereum address connected');\n    const address = user.ethAddress[0];\n\n    // if the nonce is the same as last time, resend last signature\n    const nonce = await ethUtils.getNonce(address);\n\n    // Prioritize last withdrawal attempt\n    if (user.cashOut && user.cashOut.nonce === nonce.toString()) {\n      return res.status(200).json({ user, earning: null });\n    }\n\n    const userCashoutLog = await Earnings.find({\n      user: user._id,\n      cashOutAttempt: true\n    });\n    const cashedOut = userCashoutLog.reduce((a, e) => a + e.cashOutAmt, 0);\n\n    if (user.cashedOut !== cashedOut) {\n      throw new Error(\n        'There is a mismatch in previous cashout amounts',\n        user.cashedOut,\n        cashedOut\n      );\n    }\n\n    const maxClaim = CASHOUT_MAX - cashedOut;\n\n    const canClaim = Math.min(maxClaim, user.balance - (user.airdropTokens || 0));\n    const amount = Number(customAmount);\n\n    if (amount > maxClaim)\n      throw new Error(`You can not claim more than ${maxClaim} coins at this time.`);\n\n    if (amount > canClaim) throw new Error('You can not claim this many coins.');\n    if (amount <= 0) throw new Error('You do not have enough coins to claim.');\n\n    // if (amount < 100) throw new Error('Balance is too small to withdraw');\n    const allocatedRewards = await ethUtils.getParam('allocatedRewards');\n\n    if (allocatedRewards < amount) {\n      throw new Error(\n        'There are not enough funds allocated in the contract at the moment'\n      );\n    }\n\n    const earning = await logCashOut(user, amount);\n\n    user.balance -= amount;\n    console.log('prev cashout', cashedOut, 'cashout', amount); // eslint-disable-line\n    user.cashedOut += amount;\n    user = await user.save();\n    console.log('new cashout', user.cashedOut); // eslint-disable-line\n\n    const { sig, amount: bnAmount } = await ethUtils.sign(address, amount);\n    user.nonce = nonce;\n    user.cashOut = { sig, amount: bnAmount, nonce, earningId: earning._id };\n    user = await user.save();\n    return res.status(200).json({ user, earning });\n  } catch (err) {\n    return next(err);\n  }\n};\n\n/**\n * Authentication callback\n */\nexports.authCallback = (req, res) => {\n  res.redirect('/');\n};\n"],"file":"user.controller.js"}