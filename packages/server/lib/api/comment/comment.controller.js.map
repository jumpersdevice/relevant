{"version":3,"sources":["../../../src/api/comment/comment.controller.js"],"names":["exports","index","req","user","community","post","query","Error","cObj","Community","findOne","slug","communityId","_id","parentPost","hidden","$ne","myVote","path","match","investor","comments","Post","find","populate","select","sort","pagerank","createdAt","data","map","c","toObject","create","res","next","communityMember","linkParent","text","body","repost","metaPost","parentComment","mentions","tags","type","words","mentionsFromBody","tagsFromBody","Set","commentObj","eligibleForRewards","postDate","Date","comment","User","banned","addUserInfo","addPostData","sendOutMentions","updateTime","updateRank","length","addTags","save","updateClient","postAuthor","commentAuthor","otherCommentors","comm","filter","u","push","voters","Invest","commentVoters","v","i","findIndex","equals","status","json","m","handle","forEach","commentor","sendNotifications","err","ownPost","ownComment","noteType","note","forUser","byUser","amount","source","personal","read","Notification","noteAction","payload","socketEvent","emit","action","alert","name","fromUser","toUser","update","newMentions","newComment","indexOf","delete","userId","id","params","remove","findOneAndUpdate","$inc","commentCount","new","exec"],"mappings":"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","sourcesContent":["import Community from 'server/api/community/community.model';\nimport { getMentions, getWords, getTags } from 'app/utils/text';\nimport { sendNotification as sendPushNotification } from 'server/notifications';\nimport socketEvent from 'server/socket/socketEvent';\nimport Post from 'server/api/post/post.model';\nimport User from 'server/api/user/user.model';\nimport Notification from 'server/api/notification/notification.model';\nimport Invest from 'server/api/invest/invest.model';\nimport { checkCommunityAuth } from 'server/api/community/community.auth';\n\n// COMMENTS ARE USING POST SCHEMA\nexports.index = async req => {\n  // TODO - pagination\n  // const limit = parseInt(req.query.limit, 10) || 10;\n  // const skip = parseInt(req.query.skip, 10) || 0;\n  const { user } = req;\n  const { community, post } = req.query;\n  if (!post) throw Error('missing parent post id');\n\n  const cObj = await Community.findOne({ slug: community }, '_id');\n  const communityId = cObj._id;\n\n  const query = { parentPost: post, hidden: { $ne: true }, communityId };\n\n  const myVote = user\n    ? [\n        {\n          path: 'myVote',\n          match: { investor: user._id, communityId }\n        }\n      ]\n    : [];\n\n  const comments = await Post.find(query)\n    .populate([\n      ...myVote,\n      {\n        path: 'embeddedUser.relevance',\n        select: 'pagerank',\n        match: { communityId }\n      },\n      {\n        path: 'data',\n        match: { communityId }\n      }\n    ])\n    .sort({ pagerank: -1, createdAt: 1 });\n\n  return { data: comments.map(c => c.toObject()) };\n};\n\nexports.create = async (req, res, next) => {\n  try {\n    let user = req.user._id;\n    const { communityMember } = req;\n\n    const { community, communityId } = communityMember;\n\n    await checkCommunityAuth({ user: req.user, communityId, communityMember });\n\n    const { linkParent, text: body, repost = false, metaPost } = req.body;\n    let { parentPost, parentComment, mentions = [], tags = [] } = req.body;\n\n    const type = !parentComment || parentComment === parentPost ? 'post' : 'comment';\n\n    const words = getWords(body);\n    const mentionsFromBody = getMentions(words);\n    const tagsFromBody = getTags(words);\n\n    tags = [...new Set([...tags, ...tagsFromBody])];\n    mentions = [...new Set([...mentions, ...mentionsFromBody])];\n\n    const commentObj = {\n      body,\n      mentions,\n      tags,\n      parentPost,\n      linkParent,\n      parentComment,\n      user,\n      type,\n      eligibleForRewards: true,\n      postDate: new Date(),\n      community,\n      communityId,\n      metaPost\n    };\n\n    let comment = new Post(commentObj);\n    user = await User.findOne({ _id: user });\n\n    if (user.banned) {\n      throw new Error(\n        'You are temporarily blocked from making comments, if you think this is an error, please reach out to info@relevant.community'\n      );\n    }\n\n    parentPost = await Post.findOne({ _id: parentPost });\n    parentComment = await Post.findOne({ _id: parentComment });\n\n    comment = await comment.addUserInfo(user);\n    comment = await comment.addPostData();\n\n    // this will also save the new comment\n    comment = await Post.sendOutMentions(mentions, comment, user, comment);\n\n    const updateTime = type === 'post' || false;\n    await parentPost.updateRank({ communityId, updateTime });\n\n    if (tags && tags.length) {\n      parentPost = await parentPost.addTags({ tags, communityId });\n    }\n\n    parentPost = await parentPost.save();\n    parentPost.updateClient();\n\n    const postAuthor = await User.findOne(\n      { _id: parentPost.user },\n      'name _id deviceTokens handle email notificationSettings'\n    );\n    const commentAuthor =\n      parentComment &&\n      (await User.findOne(\n        { _id: parentComment.user },\n        'name _id deviceTokens handle email notificationSettings'\n      ));\n\n    let otherCommentors = await Post.find({ parentPost: parentPost._id }).populate(\n      'user',\n      'name _id deviceTokens handle email notificationSettings'\n    );\n\n    otherCommentors = otherCommentors.map(comm => comm.user).filter(u => u);\n    if (postAuthor) otherCommentors.push(postAuthor);\n    if (commentAuthor) otherCommentors.push(commentAuthor);\n\n    let voters = await Invest.find({ post: parentPost._id }).populate(\n      'investor',\n      'name _id deviceTokens handle email notificationSettings'\n    );\n\n    let commentVoters =\n      parentComment &&\n      (await Invest.find({ post: parentComment._id }).populate(\n        'investor',\n        'name _id deviceTokens handle email notificationSettings'\n      ));\n\n    commentVoters = commentVoters ? commentVoters.map(v => v.investor) : [];\n    voters = voters.map(v => v.investor);\n    otherCommentors = [...otherCommentors, ...voters, ...commentVoters];\n    otherCommentors = otherCommentors.filter(u => u);\n\n    // filter out duplicates\n    otherCommentors = otherCommentors.filter((u, i) => {\n      const index = otherCommentors.findIndex(c => (c ? c._id.equals(u._id) : false));\n      return index === i;\n    });\n\n    await comment.save();\n    res.status(200).json(comment);\n\n    otherCommentors = otherCommentors.filter(u => !mentions.find(m => m === u.handle));\n    otherCommentors.forEach(commentor =>\n      sendNotifications({\n        commentor,\n        postAuthor,\n        commentAuthor,\n        repost,\n        parentPost,\n        user,\n        comment,\n        type\n      })\n    );\n  } catch (err) {\n    next(err);\n  }\n};\n\nasync function sendNotifications({\n  commentor,\n  postAuthor,\n  commentAuthor,\n  repost,\n  user,\n  comment,\n  type\n}) {\n  if (user._id.equals(commentor._id)) return;\n\n  const ownPost = postAuthor && commentor._id.equals(postAuthor._id);\n  const ownComment = commentAuthor && commentor._id.equals(commentAuthor._id);\n\n  const noteType = !ownPost && !ownComment ? 'commentAlso' : 'comment';\n\n  if (repost && ownPost) type = 'repost';\n\n  let note = {\n    post: comment._id,\n    forUser: commentor._id,\n    byUser: user._id,\n    amount: null,\n    type: noteType,\n    source: type,\n    personal: true,\n    read: false\n  };\n\n  note = new Notification(note);\n  note = await note.save();\n\n  const noteAction = {\n    _id: commentor._id,\n    type: 'ADD_ACTIVITY',\n    payload: note\n  };\n  socketEvent.emit('socketEvent', noteAction);\n\n  let action = ` replied to ${ownPost || ownComment ? 'your' : 'a'} ${type}`;\n  if (type === 'repost' && ownPost) action = ` reposted your ${type}`;\n\n  const alert = user.name + action;\n  const payload = {\n    fromUser: user,\n    toUser: commentor,\n    post: comment,\n    action,\n    noteType: ownPost || ownComment ? 'reply' : 'general'\n  };\n  sendPushNotification(commentor, alert, payload);\n}\n\nexports.update = async (req, res, next) => {\n  try {\n    const comment = req.body;\n    const { user } = req;\n    const { mentions } = comment;\n    let newMentions;\n\n    const newComment = await Post.findOne({ _id: comment._id });\n    if (!user._id.equals(newComment.user)) throw new Error(\"Can't edit other's comments\");\n\n    newComment.body = req.body.body;\n    newMentions = mentions.filter(m => newComment.mentions.indexOf(m) < 0);\n    newComment.mentions = mentions;\n    newMentions = newMentions || [];\n\n    if (newMentions.length) {\n      Post.sendOutMentions(mentions, newComment, newComment.user, newComment);\n    }\n\n    await newComment.save();\n\n    res.json(200, newComment);\n  } catch (err) {\n    next(err);\n  }\n};\n\nexports.delete = async (req, res, next) => {\n  try {\n    const userId = req.user._id;\n    const { id } = req.params;\n    const query = { _id: id, user: userId };\n    const comment = await Post.findOne(query);\n    if (!comment) throw new Error(\"Comment doesn't exist\");\n    if (comment.repost) {\n      await Post.findOne({ 'repost.comment': id }).remove();\n    }\n\n    const post = await Post.findOneAndUpdate(\n      { _id: comment.parentPost },\n      { $inc: { commentCount: -1 } },\n      { new: true }\n    ).exec();\n\n    await comment.remove();\n\n    if (post) post.updateClient();\n    return res.json(200, true);\n  } catch (err) {\n    return next(err);\n  }\n};\n"],"file":"comment.controller.js"}