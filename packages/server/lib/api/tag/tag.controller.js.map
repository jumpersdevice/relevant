{"version":3,"sources":["../../../src/api/tag/tag.controller.js"],"names":["exports","update","req","res","next","tag","newId","body","oldId","_id","updatedTag","sameIdTag","Tag","findOne","count","parents","Math","max","remove","findOneAndUpdate","$set","new","exec","newTag","toObject","save","Post","category","multi","$addToSet","$pull","err","status","json","create","index","sort","query","sortObj","find","tags","categories","active","undefined","then","catch","search","term","params","$regex","$options","foundTags"],"mappings":"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","sourcesContent":["import Post from '../post/post.model';\nimport Tag from './tag.model';\n\nexports.update = async (req, res, next) => {\n  let tag;\n  const { newId } = req.body;\n  const oldId = req.body._id;\n  let updatedTag = req.body;\n  delete updatedTag.newId;\n  try {\n    if (newId !== oldId) {\n      let sameIdTag = await Tag.findOne({ _id: newId });\n      if (sameIdTag) {\n        updatedTag.count = sameIdTag.count;\n        updatedTag.parents = sameIdTag.parents;\n        updatedTag = Math.max(sameIdTag.count, updatedTag.count);\n        sameIdTag = await sameIdTag.remove();\n      }\n    }\n\n    tag = await Tag.findOneAndUpdate(\n      { _id: oldId },\n      { $set: { ...updatedTag } },\n      { new: true }\n    ).exec();\n\n    if (newId !== oldId) {\n      let newTag = new Tag({ ...tag.toObject(), _id: newId });\n      // console.log('newTag ', newTag);\n      newTag = await newTag.save();\n      await tag.remove();\n      tag = newTag;\n    }\n\n    await Post.update(\n      { category: oldId },\n      { $set: { category: newId } },\n      { multi: true }\n    ).exec();\n\n    await Tag.update(\n      { parents: oldId },\n      { $addToSet: { 'parents.$': newId }, $pull: { 'parents.$': oldId } },\n      { multi: true }\n    ).exec();\n  } catch (err) {\n    return next(err);\n  }\n  return res.status(200).json(tag);\n};\n\nexports.create = (req, res, next) => {\n  const newTag = new Tag(req.body);\n  newTag.save((err, tag) => {\n    if (err) return next(err);\n    return res.status(200).json(tag);\n  });\n};\n\nexports.index = (req, res, next) => {\n  const { sort } = req.query;\n  let sortObj = null;\n\n  if (sort === 'count') sortObj = { count: -1 };\n\n  Tag.find()\n    .sort(sortObj)\n    .exec((err, tags) => {\n      if (err) return next(err);\n      return res.json(200, tags);\n    });\n};\n\nexports.categories = (req, res, next) => {\n  const { active } = req.query;\n  let query = { category: true };\n  if (active !== undefined) query = { category: true, active: true };\n\n  Tag.find(query)\n    .sort({ count: -1 })\n    .then(categories => res.status(200).json(categories))\n    .catch(next);\n};\n\nexports.search = (req, res, next) => {\n  const { term } = req.params;\n  Tag.find({\n    _id: {\n      $regex: term,\n      $options: 'i'\n    }\n  })\n    .then(foundTags => res.json(200, foundTags))\n    .catch(next);\n};\n"],"file":"tag.controller.js"}