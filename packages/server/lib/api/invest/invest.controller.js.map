{"version":3,"sources":["../../../src/api/invest/invest.controller.js"],"names":["exports","create","bet","req","res","next","user","stakedTokens","postId","_id","body","Error","communityId","community","communityMember","communityObj","Community","findOne","betEnabled","post","Post","populate","path","match","vote","Invest","investor","placeBet","status","json","err","postInvestments","params","limit","parseInt","query","skip","investments","find","amount","$gt","sort","createdAt","select","postvotes","votes","downvotes","$lt","show","blocked","blockedBy","userId","sortQuery","u","toString"],"mappings":"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","sourcesContent":["import Invest from 'server/api/invest/invest.model';\nimport Post from 'server/api/post/post.model';\nimport Community from 'server/api/community/community.model';\nimport { create } from './createVote';\n\nexports.create = create;\n\nexports.bet = async (req, res, next) => {\n  try {\n    const { user } = req;\n    const { stakedTokens, postId: _id } = req.body;\n    if (stakedTokens === 0) throw new Error(\"You don't have enough tokens to bet\");\n    const { communityId, community } = req.communityMember;\n    const communityObj = await Community.findOne({ _id: communityId });\n    if (communityObj.betEnabled === false) {\n      throw new Error(\"This community doesn't support betting\");\n    }\n    const post = await Post.findOne({ _id }).populate({\n      path: 'data',\n      match: { communityId }\n    });\n    let vote = await Invest.findOne({ post: _id, investor: user._id });\n    if (!vote) throw new Error('You must upvote the post first');\n    vote = await vote.placeBet({ post, community, communityId, stakedTokens, user });\n    return res.status(200).json(vote);\n  } catch (err) {\n    return next(err);\n  }\n};\n\nexports.postInvestments = async (req, res, next) => {\n  try {\n    const { postId } = req.params;\n    const limit = parseInt(req.query.limit, 10);\n    const skip = parseInt(req.query.skip, 10);\n    const { community } = req.query;\n\n    const investments = await Invest.find({ post: postId, amount: { $gt: 0 } })\n      .limit(limit)\n      .skip(skip)\n      .sort({ createdAt: -1 })\n      .populate({\n        path: 'investor',\n        select: 'name image handle',\n        populate: {\n          path: 'relevance',\n          match: { community }\n        }\n      });\n\n    return res.status(200).json(investments);\n  } catch (err) {\n    return next(err);\n  }\n};\n\nexports.postvotes = async (req, res, next) => {\n  try {\n    const { postId } = req.params;\n    const limit = parseInt(req.query.limit, 10);\n    const skip = parseInt(req.query.skip, 10);\n    const { community } = req.query;\n\n    const votes = await Invest.find({ post: postId, amount: { $gt: 0 } })\n      .limit(limit)\n      .skip(skip)\n      .sort({ createdAt: -1 })\n      .populate({\n        path: 'investor',\n        select: 'name image handle',\n        populate: {\n          path: 'relevance',\n          match: { community }\n        }\n      });\n\n    return res.status(200).json(votes);\n  } catch (err) {\n    return next(err);\n  }\n};\n\nexports.downvotes = async (req, res, next) => {\n  const limit = parseInt(req.query.limit, 10) || null;\n  const skip = parseInt(req.query.skip, 10) || null;\n  let downvotes;\n  try {\n    downvotes = await Invest.find({ amount: { $lt: 0 } })\n      .sort({ createdAt: -1 })\n      .skip(skip)\n      .limit(limit)\n      .populate('post');\n\n    return res.status(200).json(downvotes);\n  } catch (err) {\n    return next(err);\n  }\n};\n\nexports.show = async (req, res, next) => {\n  try {\n    const { communityId } = req.communityMember;\n    const { user } = req;\n\n    const blocked = user ? [...user.blocked, ...user.blockedBy] : [];\n\n    const limit = parseInt(req.query.limit, 10);\n    const skip = parseInt(req.query.skip, 10);\n    const userId = req.params.userId || null;\n    const sortQuery = { createdAt: -1 };\n    const query = { investor: userId, amount: { $gt: 0 } };\n\n    if (blocked.find(u => u.toString() === userId.toString())) {\n      return res.status(200).json({});\n    }\n\n    const votes = await Invest.find(query)\n      .populate({\n        path: 'post',\n        populate: [\n          {\n            path: 'embeddedUser.relevance',\n            match: { communityId }\n          },\n          {\n            path: 'data',\n            select: 'pagerank'\n          },\n          {\n            path: 'metaPost'\n          }\n        ]\n      })\n      .limit(limit)\n      .skip(skip)\n      .sort(sortQuery);\n    return res.status(200).json(votes);\n  } catch (err) {\n    return next(err);\n  }\n};\n"],"file":"invest.controller.js"}