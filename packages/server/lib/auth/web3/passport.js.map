{"version":3,"sources":["../../../src/auth/web3/passport.js"],"names":["passport","use","Strategy","req","callback","user","authorizeUser","Error","err","sigAddress","verifyEthSignature","body","ethLogin","save","User","findOne","signature","msg","utils","verifyMessage","JSON","stringify","address","exp","claimExp","Date"],"mappings":";;;;;;;;;;AAAA;;AACA;;AACA;;AACA;;AAEAA,kBAASC,GAAT,CACE,MADF,EAEE,IAAIC,wBAAJ,CAAa,OAAOC,GAAP,EAAYC,QAAZ,KAAyB;AACpC,MAAI;AACF,UAAMC,IAAI,GAAG,MAAMC,aAAa,CAACH,GAAD,CAAhC;AACA,QAAI,CAACE,IAAL,EAAW,MAAM,IAAIE,KAAJ,CAAU,gBAAV,CAAN;AACX,WAAOH,QAAQ,CAAC,IAAD,EAAOC,IAAP,CAAf;AACD,GAJD,CAIE,OAAOG,GAAP,EAAY;AACZ,WAAOJ,QAAQ,CAACI,GAAD,CAAf;AACD;AACF,CARD,CAFF;;AAaO,eAAeF,aAAf,CAA6BH,GAA7B,EAAkC;AACvC,QAAMM,UAAU,GAAGC,kBAAkB,CAACP,GAAG,CAACQ,IAAL,CAArC,CADuC,CAEvC;;AACA,MAAIR,GAAG,CAACE,IAAR,EAAc;AACZF,IAAAA,GAAG,CAACE,IAAJ,CAASO,QAAT,GAAoBH,UAApB;AACA,UAAMN,GAAG,CAACE,IAAJ,CAASQ,IAAT,EAAN;AACA,WAAOV,GAAG,CAACE,IAAX;AACD;;AACD,SAAOS,cAAKC,OAAL,CAAa;AAAEH,IAAAA,QAAQ,EAAEH;AAAZ,GAAb,CAAP;AACD;;AAEM,SAASC,kBAAT,CAA4B;AAAEM,EAAAA,SAAF;AAAaC,EAAAA;AAAb,CAA5B,EAAgD;AACrD,MAAI,CAACD,SAAD,IAAc,CAACC,GAAnB,EAAwB,MAAMV,KAAK,CAAC,8BAAD,CAAX;;AACxB,QAAME,UAAU,GAAGS,cAAMC,aAAN,CAAoBC,IAAI,CAACC,SAAL,CAAeJ,GAAf,CAApB,EAAyCD,SAAzC,CAAnB;;AAEA,MAAIP,UAAU,KAAKQ,GAAG,CAACK,OAAvB,EAAgC,MAAM,IAAIf,KAAJ,CAAU,yBAAV,CAAN;AAEhC,QAAM;AAAEgB,IAAAA;AAAF,MAAUN,GAAhB;AACA,QAAMO,QAAQ,GAAG,IAAIC,IAAJ,CAASF,GAAG,GAAG,IAAf,CAAjB;AACA,MAAIC,QAAQ,GAAG,IAAIC,IAAJ,EAAf,EAA2B,MAAM,IAAIlB,KAAJ,CAAU,2BAAV,CAAN;AAC3B,SAAOE,UAAP;AACD","sourcesContent":["import { utils } from 'ethers';\nimport { Strategy } from 'passport-custom';\nimport passport from 'passport';\nimport User from 'server/api/user/user.model';\n\npassport.use(\n  'web3',\n  new Strategy(async (req, callback) => {\n    try {\n      const user = await authorizeUser(req);\n      if (!user) throw new Error('User not found');\n      return callback(null, user);\n    } catch (err) {\n      return callback(err);\n    }\n  })\n);\n\nexport async function authorizeUser(req) {\n  const sigAddress = verifyEthSignature(req.body);\n  // user is already logged in\n  if (req.user) {\n    req.user.ethLogin = sigAddress;\n    await req.user.save();\n    return req.user;\n  }\n  return User.findOne({ ethLogin: sigAddress });\n}\n\nexport function verifyEthSignature({ signature, msg }) {\n  if (!signature || !msg) throw Error('Missing signature parameters');\n  const sigAddress = utils.verifyMessage(JSON.stringify(msg), signature);\n\n  if (sigAddress !== msg.address) throw new Error(\"Signature doesn't match\");\n\n  const { exp } = msg;\n  const claimExp = new Date(exp * 1000);\n  if (claimExp < new Date()) throw new Error('This signature is expired');\n  return sigAddress;\n}\n"],"file":"passport.js"}