{"version":3,"sources":["../../src/utils/img.js"],"names":["MAX_IMAGE_DIMENSION","MAX_FILE_SIZE","loadFile","file","Promise","resolve","reader","FileReader","onload","e","target","result","readAsArrayBuffer","getScale","width","height","viewportWidth","viewportHeight","fillViewport","fitHorizontal","fitVertical","landscape","applyRotation","canvas","ctx","deg","radians","Math","PI","translate","rotate","base64ToUint8Array","string","start","finish","length","binary","atob","buffer","Uint8Array","i","charCodeAt","getOrientation","uri","base64String","split","arr","tags","ExifReader","load","Orientation","value","err","orientationToTransform","rotation","mirror","applyOrientationCorrection","orientation","flipAspect","renderToCanvas","img","options","document","createElement","getContext","initialScale","scale","round","correctOrientation","jpeg","src","match","hasDataURI","save","drawImage","restore","downsample","resized","buf","dataURL","quality","toDataURL","loadImage","reject","onerror","Image","readAsDataURL"],"mappings":"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","sourcesContent":["import ExifReader from 'exifreader';\nimport dataUriToBuffer from 'data-uri-to-buffer';\n\n/* Image resize / EXIF processing functions */\n\nexport const MAX_IMAGE_DIMENSION = 1024;\nexport const MAX_FILE_SIZE = 1024 * 400;\n\nexport function loadFile(file) {\n  return new Promise(resolve => {\n    const reader = new FileReader();\n    reader.onload = e => resolve(e.target.result);\n    reader.readAsArrayBuffer(file);\n  });\n}\n\nfunction getScale(width, height, viewportWidth, viewportHeight, fillViewport) {\n  function fitHorizontal() {\n    return viewportWidth / width;\n  }\n  function fitVertical() {\n    return viewportHeight / height;\n  }\n  fillViewport = !!fillViewport;\n  const landscape = width / height > viewportWidth / viewportHeight;\n  if (landscape) {\n    if (fillViewport) {\n      return fitVertical();\n    }\n    if (width > viewportWidth) {\n      return fitHorizontal();\n    }\n  } else {\n    if (fillViewport) {\n      return fitHorizontal();\n    }\n    if (height > viewportHeight) {\n      return fitVertical();\n    }\n  }\n  return 1;\n}\n\nfunction applyRotation(canvas, ctx, deg) {\n  const radians = deg * (Math.PI / 180);\n  if (deg === 90) {\n    ctx.translate(canvas.width, 0);\n  } else if (deg === 180) {\n    ctx.translate(canvas.width, canvas.height);\n  } else if (deg === 270) {\n    ctx.translate(0, canvas.height);\n  }\n  ctx.rotate(radians);\n}\n\nfunction base64ToUint8Array(string, start, finish) {\n  start = start || 0;\n  finish = finish || string.length;\n  const binary = atob(string);\n  const buffer = new Uint8Array(binary.length);\n  for (let i = start; i < finish; i++) {\n    buffer[i] = binary.charCodeAt(i);\n  }\n  return buffer;\n}\n\nfunction getOrientation(uri) {\n  // Split off the base64 URL header\n  const base64String = uri.split(',')[1];\n  // Read off first 128KB, which is all we need to\n  // get the EXIF data\n  const arr = base64ToUint8Array(base64String, 0, 2 ** 17);\n  try {\n    const tags = ExifReader.load(arr.buffer);\n    return tags.Orientation.value;\n  } catch (err) {\n    return 1;\n  }\n}\n\n/**\n * Mapping from EXIF orientation values to data\n * regarding the rotation and mirroring necessary to\n * render the canvas correctly\n * Derived from:\n * http://www.daveperrett.com/articles/2012/07/28/exif-orientation-handling-is-a-ghetto/\n */\nconst orientationToTransform = {\n  1: { rotation: 0, mirror: false },\n  2: { rotation: 0, mirror: true },\n  3: { rotation: 180, mirror: false },\n  4: { rotation: 180, mirror: true },\n  5: { rotation: 90, mirror: true },\n  6: { rotation: 90, mirror: false },\n  7: { rotation: 270, mirror: true },\n  8: { rotation: 270, mirror: false }\n};\n\nfunction applyOrientationCorrection(canvas, ctx, uri) {\n  const orientation = getOrientation(uri);\n  // Only apply transform if there is some non-normal orientation\n  if (orientation && orientation !== 1) {\n    const { rotation } = orientationToTransform[orientation];\n    const flipAspect = rotation === 90 || rotation === 270;\n    if (flipAspect) {\n      // Fancy schmancy swap algo\n      canvas.width = canvas.height + canvas.width;\n      canvas.height = canvas.width - canvas.height;\n      canvas.width -= canvas.height;\n    }\n    if (rotation > 0) {\n      applyRotation(canvas, ctx, rotation);\n    }\n  }\n}\n\nexport function renderToCanvas(img, options) {\n  if (!img) return null;\n  options = options || {};\n\n  // Canvas max size for any side\n  const canvas = document.createElement('canvas');\n  const ctx = canvas.getContext('2d');\n  const initialScale = options.scale || 1;\n  // Scale to needed to constrain canvas to max size\n  let scale = getScale(\n    img.width * initialScale,\n    img.height * initialScale,\n    MAX_IMAGE_DIMENSION,\n    MAX_IMAGE_DIMENSION,\n    true\n  );\n  // Still need to apply the user defined scale\n  scale *= initialScale;\n  canvas.width = Math.round(img.width * scale);\n  canvas.height = Math.round(img.height * scale);\n  const { correctOrientation } = options;\n  const jpeg = !!img.src.match(/data:image\\/jpeg|\\.jpeg$|\\.jpg$/i);\n  const hasDataURI = !!img.src.match(/^data:/);\n\n  ctx.save();\n\n  // Can only correct orientation on JPEGs represented as dataURIs\n  // for the time being\n  if (correctOrientation && jpeg && hasDataURI) {\n    applyOrientationCorrection(canvas, ctx, img.src);\n  }\n  // Resize image if too large\n  if (scale !== 1) {\n    ctx.scale(scale, scale);\n  }\n\n  ctx.drawImage(img, 0, 0);\n  ctx.restore();\n\n  return canvas;\n}\n\nexport function downsample(img) {\n  const resized = renderToCanvas(img, { correctOrientation: true });\n  let buf;\n  let dataURL;\n  let quality = 0.8;\n  do {\n    dataURL = resized.toDataURL('image/jpeg', quality);\n    buf = dataUriToBuffer(dataURL);\n    quality -= 0.05;\n  } while (buf.length > MAX_FILE_SIZE && quality > 0.1);\n  return dataURL;\n}\n\nexport function loadImage(file) {\n  return new Promise((resolve, reject) => {\n    if (file) {\n      const reader = new FileReader();\n      reader.onload = e => {\n        reader.onload = null;\n        reader.onerror = null;\n        const dataURL = e.target.result;\n        const buf = dataUriToBuffer(dataURL);\n        if (buf.length <= MAX_FILE_SIZE) {\n          resolve(dataURL);\n        } else {\n          const img = new Image();\n          img.onload = () => {\n            img.onload = null;\n            img.onerror = null;\n            resolve(downsample(img));\n          };\n          img.onerror = () => {\n            img.onload = null;\n            img.onerror = null;\n            reject();\n          };\n          img.src = dataURL;\n        }\n      };\n      reader.onerror = () => {\n        reader.onload = null;\n        reader.onerror = null;\n        reject();\n      };\n      reader.readAsDataURL(file);\n    } else reject();\n  });\n}\n"],"file":"img.js"}