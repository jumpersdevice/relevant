{"version":3,"sources":["../../../src/modules/comment/commentBody.js"],"names":["MAX_LINES","LONG_EXCERPT","SHORT_EXCERPT","CommentBody","propTypes","noLink","PropTypes","bool","avatarText","func","comment","object","inMainFeed","preview","omitTitle","noPostLink","dispatch","currentCommunity","state","auth","community","commentCommunity","data","postUrl","body","isHeading","titleText","isPreview","fullText","replace","trim","textTrim","text","trimText","readMore","length","inputUrl","url","postLink","parentPost","postLinkObj","_id","zIndex","e","preventDefault","stopPropagation","history","push","limit","lines","split","slice","join","handleCodeblock","excerpt","substr","lastIndexOf","hasCodeblock","match","lastIndex"],"mappings":"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","sourcesContent":["import React from 'react';\nimport { useSelector, useDispatch } from 'react-redux';\nimport { Touchable, View } from 'modules/styled/uni';\nimport PropTypes from 'prop-types';\nimport { getTitle } from 'utils/text';\nimport Markdown from 'modules/comment/renderMarkdown';\nimport history from 'modules/navigation/history';\nimport { goToPost } from 'modules/navigation/navigation.actions';\nimport { getPostUrl } from 'app/utils/post';\nimport linkifyText from './linkify';\n\nconst MAX_LINES = 4;\nconst LONG_EXCERPT = 240;\nconst SHORT_EXCERPT = 140;\n\nCommentBody.propTypes = {\n  noLink: PropTypes.bool, // inner links inside post body\n  avatarText: PropTypes.func,\n  comment: PropTypes.object,\n  inMainFeed: PropTypes.bool,\n  preview: PropTypes.bool,\n  omitTitle: PropTypes.bool,\n  noPostLink: PropTypes.bool // outer link to post\n};\n\nexport default function CommentBody({\n  avatarText,\n  inMainFeed,\n  comment,\n  noLink,\n  preview,\n  omitTitle,\n  noPostLink\n}) {\n  const dispatch = useDispatch();\n  const currentCommunity = useSelector(state => state.auth.community);\n  const commentCommunity =\n    comment && comment.data ? comment.data.community : comment.community;\n  const community = commentCommunity || currentCommunity;\n  const postUrl = getPostUrl(community, comment);\n\n  if (!comment || !comment.body) return null;\n\n  const { isHeading, titleText } = omitTitle ? getTitle(comment.body) : {};\n  const isPreview = inMainFeed || preview;\n\n  const fullText = isHeading\n    ? comment.body.replace(`# ${titleText}`, '').trim()\n    : comment.body.replace(`${titleText}`, '').trim();\n\n  const textTrim = preview ? SHORT_EXCERPT : LONG_EXCERPT;\n  let text = isPreview ? trimText(fullText, textTrim) : fullText;\n  const readMore = text.length < fullText.length;\n  text += readMore ? ' _...Read More_' : '';\n  const inputUrl = comment.inputUrl || comment.url;\n  text = linkifyText(text, community, inputUrl);\n\n  const body = <Markdown noLink={noLink} className={'markdown-body'} markdown={text} />;\n\n  const postLink = comment.parentPost || comment;\n  const postLinkObj = postLink._id ? postLink : { _id: postLink };\n\n  // link to full post\n  if (!noPostLink && (isPreview || noLink)) {\n    return (\n      <View shrink={1} pl={avatarText ? 5 : 0}>\n        <Touchable\n          style={{ zIndex: 0 }}\n          to={postUrl}\n          onPress={e => {\n            if (noLink) {\n              e.preventDefault();\n              e.stopPropagation();\n            }\n            return dispatch(goToPost({ ...postLinkObj, comment, community }));\n          }}\n          onClick={e => {\n            if (noLink) {\n              e.preventDefault();\n              e.stopPropagation();\n            }\n            return history.push(postUrl);\n          }}\n        >\n          {body}\n        </Touchable>\n      </View>\n    );\n  }\n\n  return (\n    <View shrink={1} pl={avatarText ? 5 : 0}>\n      {body}\n    </View>\n  );\n}\n\nfunction trimText(text, limit) {\n  if (!text || !text.length) return text;\n  const lines = text.split(/\\n/);\n  text = lines.slice(0, MAX_LINES).join('\\n');\n  if (text.length <= limit) return handleCodeblock(text);\n  const excerpt = text.substr(0, text.lastIndexOf(' ', limit));\n  return handleCodeblock(excerpt);\n}\n\nfunction handleCodeblock(excerpt) {\n  const hasCodeblock = excerpt.match(/```/g);\n  if (!hasCodeblock || !hasCodeblock.length || hasCodeblock.length % 2 === 0)\n    return excerpt;\n  const lastIndex = excerpt.substr(excerpt.length - 3, excerpt.length) === '```';\n  if (lastIndex) return excerpt.substr(0, excerpt.length - 3);\n  return excerpt + '\\n```\\n';\n}\n"],"file":"commentBody.js"}