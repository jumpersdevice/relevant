{"version":3,"sources":["../../../../src/modules/text/web/richText.component.js"],"names":["process","env","BROWSER","require","RichText","props","body","userSearchIndex","text","handleKeyDown","bind","handleChange","handleSetMention","parseBody","prevProps","prevState","lengthDelta","state","data","onChange","userSearch","replace","words","textUtils","getWords","shouldParseUrl","prevLength","length","url","find","word","post","URL_REGEX","test","toLowerCase","lastWord","match","mention","actions","searchUser","setUserSearch","tags","getTags","mentions","getMentions","e","setState","target","value","user","handle","slice","userCount","keyCode","preventDefault","userIndex","Math","max","className","placeholder","onBlur","onFocus","Component","PropTypes","object","func","array","string","mapStateToProps","search","mapDispatchToProps","dispatch","userActions"],"mappings":"y6BAAA,qDACA,6DACA,4BACA,uCACA,qCACA,6FACA,4EACA,oF,omDAEA,GAAIA,OAAO,CAACC,GAAR,CAAYC,OAAZ,GAAwB,IAA5B,CAAkC,CAChCC,OAAO,kBAAP,CACD,C,GAEKC,CAAAA,Q,oGAkBJ,kBAAYC,KAAZ,CAAmB,uDACjB,uBAAMA,KAAN,EADiB,gFANX,CACNC,IAAI,CAAE,EADA,CAENC,eAAe,CAAE,CAAC,CAFZ,CAGNC,IAAI,CAAE,EAHA,CAMW,EAEjB,MAAKC,aAAL,CAAqB,MAAKA,aAAL,CAAmBC,IAAnB,4CAArB,CACA,MAAKC,YAAL,CAAoB,MAAKA,YAAL,CAAkBD,IAAlB,4CAApB,CACA,MAAKE,gBAAL,CAAwB,MAAKA,gBAAL,CAAsBF,IAAtB,4CAAxB,CACA,MAAKG,SAAL,CAAiB,MAAKA,SAAL,CAAeH,IAAf,4CAAjB,CALiB,aAMlB,C,gGAUkBI,S,CAAWC,S,CAAW,CACvC,KAAKC,WAAL,CAAmB,CAAnB,CACA,GAAID,SAAS,CAACP,IAAV,GAAmB,KAAKS,KAAL,CAAWT,IAAlC,CAAwC,MAAO,KAAP,CAFD,GAG/BA,CAAAA,IAH+B,CAGtB,KAAKS,KAHiB,CAG/BT,IAH+B,CAIvC,GAAMU,CAAAA,IAAI,CAAG,KAAKL,SAAL,CAAeL,IAAf,CAAqBO,SAArB,CAAb,CACA,MAAO,MAAKV,KAAL,CAAWc,QAAX,CAAoBX,IAApB,CAA0BU,IAA1B,CAAP,CACD,C,6CAE+B,IAAtBV,CAAAA,IAAsB,2DAAf,EAAe,IAAXO,CAAAA,SAAW,8CACtBK,CAAAA,UADsB,CACP,KAAKf,KADE,CACtBe,UADsB,CAE9BZ,IAAI,CAAGA,IAAI,CAACa,OAAL,CAAa,UAAb,CAAyB,GAAzB,CAAP,CACA,GAAMC,CAAAA,KAAK,CAAGC,YAAUC,QAAV,CAAmBhB,IAAnB,CAAd,CAEA,GAAIiB,CAAAA,cAAc,CAAG,KAArB,CAEA,GAAIV,SAAJ,CAAe,CACb,GAAMW,CAAAA,UAAU,CAAGX,SAAS,CAACP,IAAV,CAAemB,MAAf,EAAyB,CAA5C,CACA,GAAInB,IAAI,CAACmB,MAAL,CAAcD,UAAd,CAA2B,CAA/B,CAAkCD,cAAc,CAAG,IAAjB,CAClC,GAAIH,KAAK,CAACA,KAAK,CAACK,MAAN,CAAe,CAAhB,CAAL,EAA2B,EAA/B,CAAmCF,cAAc,CAAG,IAAjB,CACnC,GAAIjB,IAAI,CAACA,IAAI,CAACmB,MAAL,CAAc,CAAf,CAAJ,EAAyB,IAA7B,CAAmCF,cAAc,CAAG,IAAjB,CACpC,CAED,GAAMG,CAAAA,GAAG,CAAGH,cAAc,CACtBH,KAAK,CAACO,IAAN,CAAW,SAAAC,IAAI,QAAIC,aAAKC,SAAL,CAAeC,IAAf,CAAoBH,IAAI,CAACI,WAAL,EAApB,CAAJ,EAAf,CADsB,CAEtB,IAFJ,CAIA,GAAMC,CAAAA,QAAQ,CAAGb,KAAK,CAACA,KAAK,CAACK,MAAN,CAAe,CAAhB,CAAtB,CACA,GAAIQ,QAAQ,CAACC,KAAT,CAAe,QAAf,GAA4BD,QAAQ,CAACR,MAAT,CAAkB,CAAlD,CAAqD,CACnD,KAAKU,OAAL,CAAeF,QAAf,CACA,KAAK9B,KAAL,CAAWiC,OAAX,CAAmBC,UAAnB,CAA8BJ,QAAQ,CAACd,OAAT,CAAiB,GAAjB,CAAsB,EAAtB,CAA9B,EACD,CAHD,IAGO,IAAID,UAAU,CAACO,MAAf,CAAuB,CAC5B,KAAKtB,KAAL,CAAWiC,OAAX,CAAmBE,aAAnB,CAAiC,EAAjC,EACD,CAED,GAAMC,CAAAA,IAAI,CAAGlB,YAAUmB,OAAV,CAAkBpB,KAAlB,CAAb,CACA,GAAMqB,CAAAA,QAAQ,CAAGpB,YAAUqB,WAAV,CAAsBtB,KAAtB,CAAjB,CAEA,MAAO,CACLM,GAAG,CAAHA,GADK,CAELa,IAAI,CAAJA,IAFK,CAGLE,QAAQ,CAARA,QAHK,CAILlB,cAAc,CAAdA,cAJK,CAAP,CAMD,C,kDAEYoB,C,CAAG,CACd,KAAKC,QAAL,CAAc,CAAEtC,IAAI,CAAEqC,CAAC,CAACE,MAAF,CAASC,KAAjB,CAAd,EACD,C,0DAEgBC,I,CAAM,CACrB,GAAI,CAACA,IAAL,CAAW,OAGX,KAAKjC,WAAL,CAAmBiC,IAAI,CAACC,MAAL,CAAYvB,MAAZ,CAAqB,KAAKU,OAAL,CAAaV,MAAlC,CAA2C,CAA9D,CACA,GAAMrB,CAAAA,IAAI,CAAG,KAAKW,KAAL,CAAWT,IAAX,CAAgB2C,KAAhB,CAAsB,CAAtB,CAAyB,CAAC,KAAKd,OAAL,CAAaV,MAAvC,EAAiD,GAAjD,CAAuDsB,IAAI,CAACC,MAA5D,CAAqE,GAAlF,CAEA,KAAKJ,QAAL,CAAc,CAAEtC,IAAI,CAAEF,IAAR,CAAcC,eAAe,CAAE,CAAC,CAAhC,CAAd,EACA,GAAMW,CAAAA,IAAI,CAAG,KAAKL,SAAL,CAAeP,IAAf,CAAb,CACA,KAAKD,KAAL,CAAWc,QAAX,CAAoBb,IAApB,CAA0BY,IAA1B,EACA,KAAKb,KAAL,CAAWiC,OAAX,CAAmBE,aAAnB,CAAiC,EAAjC,EACD,C,oDAEaK,C,CAAG,CACf,GAAMO,CAAAA,SAAS,CAAG,KAAK/C,KAAL,CAAWe,UAAX,CAAsBO,MAAxC,CACA,OAAQkB,CAAC,CAACQ,OAAV,EACE,IAAK,GAAL,CACA,IAAK,GAAL,CACE,GAAI,KAAKhD,KAAL,CAAWe,UAAX,CAAsBO,MAA1B,CAAkC,CAChCkB,CAAC,CAACS,cAAF,GACA,KAAKR,QAAL,CAAc,CACZvC,eAAe,CAAE,CAAC,KAAKU,KAAL,CAAWV,eAAX,CAA6B,CAA7B,CAAiC6C,SAAlC,EAA+CA,SADpD,CAAd,EAGD,CACD,MACF,IAAK,GAAL,CACA,IAAK,GAAL,CACE,GAAI,KAAK/C,KAAL,CAAWe,UAAX,CAAsBO,MAA1B,CAAkC,CAChCkB,CAAC,CAACS,cAAF,GACA,KAAKR,QAAL,CAAc,CACZvC,eAAe,CAAE,CAAC,KAAKU,KAAL,CAAWV,eAAX,CAA6B,CAA9B,EAAmC6C,SADxC,CAAd,EAGD,CACD,MACF,IAAK,GAAL,CACE,GAAI,KAAK/C,KAAL,CAAWe,UAAX,CAAsBO,MAA1B,CAAkC,CAChCkB,CAAC,CAACS,cAAF,GACA,GAAMC,CAAAA,SAAS,CAAGC,IAAI,CAACC,GAAL,CAAS,KAAKxC,KAAL,CAAWV,eAApB,CAAqC,CAArC,CAAlB,CACA,GAAM0C,CAAAA,IAAI,CAAG,KAAK5C,KAAL,CAAWe,UAAX,CAAsBmC,SAAtB,CAAb,CACA,KAAK3C,gBAAL,CAAsBqC,IAAtB,EACD,CACD,MACF,QACE,MA5BJ,CA8BA,MAAO,KAAP,CACD,C,uCAEQ,CACP,MACE,qGACE,6BAAC,wBAAD,EACE,SAAS,CAAE,UAAY,KAAK5C,KAAL,CAAWqD,SADpC,CAEE,IAAI,CAAE,KAAKzC,KAAL,CAAWX,IAFnB,CAGE,WAAW,CAAE,KAAKD,KAAL,CAAWsD,WAH1B,CAIE,QAAQ,CAAE,KAAKhD,YAJjB,CAKE,SAAS,CAAE,KAAKF,aALlB,CAME,WAAW,CAAE,KAAKO,WANpB,CAOE,MAAM,CAAE,KAAKX,KAAL,CAAWuD,MAPrB,CAQE,OAAO,CAAE,KAAKvD,KAAL,CAAWwD,OARtB,iEADF,CAWE,6BAAC,mBAAD,EACE,KAAK,CAAE,KAAKxD,KAAL,CAAWe,UADpB,CAEE,QAAQ,CAAE,KAAKR,gBAFjB,CAGE,eAAe,CAAE,KAAKK,KAAL,CAAWV,eAH9B,iEAXF,CADF,CAmBD,C,4EA7H+BF,K,CAAOY,K,CAAO,CAC5C,GAAIZ,KAAK,CAACC,IAAN,GAAeW,KAAK,CAACX,IAAzB,CAA+B,MAAO,KAAP,CAC/B,MAAO,CACLA,IAAI,CAAED,KAAK,CAACC,IADP,CAELE,IAAI,CAAEH,KAAK,CAACC,IAFP,CAAP,CAID,C,sBAhCoBwD,gB,+BAAjB1D,Q,aACe,CACjBkC,OAAO,CAAEyB,mBAAUC,MADF,CAEjB7C,QAAQ,CAAE4C,mBAAUE,IAFH,CAGjB7C,UAAU,CAAE2C,mBAAUG,KAHL,CAIjBR,SAAS,CAAEK,mBAAUI,MAJJ,CAKjBR,WAAW,CAAEI,mBAAUI,MALN,CAMjBP,MAAM,CAAEG,mBAAUE,IAND,CAOjBJ,OAAO,CAAEE,mBAAUE,IAPF,CAQjB3D,IAAI,CAAEyD,mBAAUI,MARC,C,EAyJrB,QAASC,CAAAA,eAAT,CAAyBnD,KAAzB,CAAgC,CAC9B,MAAO,CACLG,UAAU,CAAEH,KAAK,CAACgC,IAAN,CAAWoB,MADlB,CAAP,CAGD,CAED,QAASC,CAAAA,kBAAT,CAA4BC,QAA5B,CAAsC,CACpC,MAAO,CACLjC,OAAO,CAAE,+CAEFkC,WAFE,EAIPD,QAJO,CADJ,CAAP,CAQD,C,aAEc,wBAAQH,eAAR,CAAyBE,kBAAzB,EAA6ClE,QAA7C,C","sourcesContent":["import React, { Component } from 'react';\nimport PropTypes from 'prop-types';\nimport { bindActionCreators } from 'redux';\nimport { connect } from 'react-redux';\nimport { text as textUtils, post } from 'app/utils';\nimport UserSearch from 'modules/createPost/web/userSearch.component';\nimport * as userActions from 'modules/user/user.actions';\nimport ContentEditable from './contentEditable.component';\n\nif (process.env.BROWSER === true) {\n  require('./richText.css');\n}\n\nclass RichText extends Component {\n  static propTypes = {\n    actions: PropTypes.object,\n    onChange: PropTypes.func,\n    userSearch: PropTypes.array,\n    className: PropTypes.string,\n    placeholder: PropTypes.string,\n    onBlur: PropTypes.func,\n    onFocus: PropTypes.func,\n    body: PropTypes.string\n  };\n\n  state = {\n    body: '',\n    userSearchIndex: -1,\n    text: ''\n  };\n\n  constructor(props) {\n    super(props);\n    this.handleKeyDown = this.handleKeyDown.bind(this);\n    this.handleChange = this.handleChange.bind(this);\n    this.handleSetMention = this.handleSetMention.bind(this);\n    this.parseBody = this.parseBody.bind(this);\n  }\n\n  static getDerivedStateFromProps(props, state) {\n    if (props.body === state.body) return null;\n    return {\n      body: props.body,\n      text: props.body\n    };\n  }\n\n  componentDidUpdate(prevProps, prevState) {\n    this.lengthDelta = 0;\n    if (prevState.text === this.state.text) return null;\n    const { text } = this.state;\n    const data = this.parseBody(text, prevState);\n    return this.props.onChange(text, data);\n  }\n\n  parseBody(text = '', prevState) {\n    const { userSearch } = this.props;\n    text = text.replace(/&nbsp;/gi, ' ');\n    const words = textUtils.getWords(text);\n\n    let shouldParseUrl = false;\n\n    if (prevState) {\n      const prevLength = prevState.text.length || 0;\n      if (text.length - prevLength > 1) shouldParseUrl = true;\n      if (words[words.length - 1] == '') shouldParseUrl = true; // eslint-disable-line\n      if (text[text.length - 1] == '\\n') shouldParseUrl = true; // eslint-disable-line\n    }\n\n    const url = shouldParseUrl\n      ? words.find(word => post.URL_REGEX.test(word.toLowerCase()))\n      : null;\n\n    const lastWord = words[words.length - 1];\n    if (lastWord.match(/^@\\S+/g) && lastWord.length > 1) {\n      this.mention = lastWord;\n      this.props.actions.searchUser(lastWord.replace('@', ''));\n    } else if (userSearch.length) {\n      this.props.actions.setUserSearch([]);\n    }\n\n    const tags = textUtils.getTags(words);\n    const mentions = textUtils.getMentions(words);\n\n    return {\n      url,\n      tags,\n      mentions,\n      shouldParseUrl\n    };\n  }\n\n  handleChange(e) {\n    this.setState({ text: e.target.value });\n  }\n\n  handleSetMention(user) {\n    if (!user) return;\n\n    // replace the partial @username with @username plus a nbsp\n    this.lengthDelta = user.handle.length - this.mention.length + 2;\n    const body = this.state.text.slice(0, -this.mention.length) + '@' + user.handle + ' ';\n\n    this.setState({ text: body, userSearchIndex: -1 });\n    const data = this.parseBody(body);\n    this.props.onChange(body, data);\n    this.props.actions.setUserSearch([]);\n  }\n\n  handleKeyDown(e) {\n    const userCount = this.props.userSearch.length;\n    switch (e.keyCode) {\n      case 37: // left\n      case 38: // up\n        if (this.props.userSearch.length) {\n          e.preventDefault();\n          this.setState({\n            userSearchIndex: (this.state.userSearchIndex - 1 + userCount) % userCount\n          });\n        }\n        break;\n      case 39: // right\n      case 40: // down\n        if (this.props.userSearch.length) {\n          e.preventDefault();\n          this.setState({\n            userSearchIndex: (this.state.userSearchIndex + 1) % userCount\n          });\n        }\n        break;\n      case 13: // enter\n        if (this.props.userSearch.length) {\n          e.preventDefault();\n          const userIndex = Math.max(this.state.userSearchIndex, 0);\n          const user = this.props.userSearch[userIndex];\n          this.handleSetMention(user);\n        }\n        break;\n      default:\n        break;\n    }\n    return true;\n  }\n\n  render() {\n    return (\n      <div>\n        <ContentEditable\n          className={'editor ' + this.props.className}\n          body={this.state.body}\n          placeholder={this.props.placeholder}\n          onChange={this.handleChange}\n          onKeyDown={this.handleKeyDown}\n          lengthDelta={this.lengthDelta}\n          onBlur={this.props.onBlur}\n          onFocus={this.props.onFocus}\n        />\n        <UserSearch\n          users={this.props.userSearch}\n          onChange={this.handleSetMention}\n          userSearchIndex={this.state.userSearchIndex}\n        />\n      </div>\n    );\n  }\n}\n\nfunction mapStateToProps(state) {\n  return {\n    userSearch: state.user.search\n  };\n}\n\nfunction mapDispatchToProps(dispatch) {\n  return {\n    actions: bindActionCreators(\n      {\n        ...userActions\n      },\n      dispatch\n    )\n  };\n}\n\nexport default connect(mapStateToProps, mapDispatchToProps)(RichText);\n"],"file":"richText.component.js"}