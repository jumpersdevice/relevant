{"version":3,"sources":["../../../../src/modules/text/web/contentEditable.component.js"],"names":["HTML_REGEX","RegExp","stripContentEditableHTML","text","replace","renderBody","lines","split","map","line","word","join","onPaste","e","preventDefault","clipboardData","getData","document","execCommand","getCurrentCursorPosition","parentId","el","getElementById","caretOffset","window","getSelection","range","getRangeAt","selected","toString","length","preCaretRange","cloneRange","selectNodeContents","setEnd","endContainer","endOffset","createRange","node","chars","selectNode","setStart","count","nodeType","Node","TEXT_NODE","textContent","lp","childNodes","setCurrentCursorPosition","selection","collapse","removeAllRanges","addRange","ContentEditable","emitChange","bind","handleKeyDown","focus","lastProps","body","props","lengthWithoutNewlines","newPosition","position","hitEnter","lengthDelta","onKeyDown","keyCode","html","innerHTML","onChange","lastHtml","value","target","lastHTML","className","push","placeholder","onBlur","disabled","__html","React","Component","PropTypes","string","number","func","object"],"mappings":"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","sourcesContent":["import React from 'react';\nimport PropTypes from 'prop-types';\n\nconst HTML_REGEX = new RegExp(/<[^>]*>/, 'gm');\n\nfunction stripContentEditableHTML(text) {\n  return (text || '')\n    .replace(/<div><br>/g, '\\n')\n    .replace(/<\\/div>/g, '\\n')\n    .replace(/<br>/g, '\\n')\n    .replace(HTML_REGEX, '');\n}\n\nfunction renderBody(lines) {\n  return lines\n    .split('\\n')\n    .map(line =>\n      line\n        .split(' ')\n        .map(word => {\n          if (word[0] === '#' || word[0] === '@') {\n            return '<b>' + word + '</b>';\n          }\n          return word;\n        })\n        .join(' ')\n    )\n    .join('\\n');\n}\n\nfunction onPaste(e) {\n  // cancel paste\n  e.preventDefault();\n\n  // get text representation of clipboard\n  const text = e.clipboardData\n    .getData('text/plain')\n    .replace(/&/g, '&amp')\n    .replace(/</g, '&lt')\n    .replace(/>/g, '&gt');\n\n  // insert text manually\n  document.execCommand('insertHTML', false, text);\n}\n\nfunction getCurrentCursorPosition(parentId) {\n  const el = document.getElementById(parentId);\n  let caretOffset = 0;\n  if (typeof window.getSelection !== 'undefined') {\n    const range = window.getSelection().getRangeAt(0);\n    const selected = range.toString().length;\n    const preCaretRange = range.cloneRange();\n    preCaretRange.selectNodeContents(el);\n    preCaretRange.setEnd(range.endContainer, range.endOffset);\n    caretOffset = preCaretRange.toString().length - selected;\n  }\n  return caretOffset;\n}\n\nfunction createRange(node, chars, range) {\n  if (!range) {\n    range = document.createRange();\n    range.selectNode(node);\n    range.setStart(node, 0);\n  }\n\n  if (chars.count === 0) {\n    range.setEnd(node, chars.count);\n  } else if (node && chars.count > 0) {\n    if (node.nodeType === Node.TEXT_NODE) {\n      if (node.textContent.length < chars.count) {\n        chars.count -= node.textContent.length;\n      } else {\n        range.setEnd(node, chars.count);\n        chars.count = 0;\n      }\n    } else {\n      for (let lp = 0; lp < node.childNodes.length; lp++) {\n        range = createRange(node.childNodes[lp], chars, range);\n\n        if (chars.count === 0) {\n          break;\n        }\n      }\n    }\n  }\n\n  return range;\n}\n\nfunction setCurrentCursorPosition(node, chars) {\n  if (chars >= 0) {\n    const selection = window.getSelection();\n    const range = createRange(node, { count: chars });\n    if (range) {\n      range.collapse(false);\n      selection.removeAllRanges();\n      selection.addRange(range);\n    }\n  }\n}\n\nexport default class ContentEditable extends React.Component {\n  static propTypes = {\n    body: PropTypes.string,\n    lengthDelta: PropTypes.number,\n    onKeyDown: PropTypes.func,\n    onChange: PropTypes.func,\n    className: PropTypes.string,\n    placeholder: PropTypes.string,\n    onBlur: PropTypes.func,\n    disabled: PropTypes.object\n  };\n\n  constructor() {\n    super();\n    this.emitChange = this.emitChange.bind(this);\n    this.handleKeyDown = this.handleKeyDown.bind(this);\n  }\n\n  componentDidMount() {\n    this.el.focus();\n    document.execCommand('defaultParagraphSeparator', false, 'br');\n  }\n\n  componentDidUpdate(lastProps) {\n    // if (this.el && this.props.html !== this.el.innerHTML) {\n    //   // Perhaps React (whose VDOM gets outdated because we often prevent\n    //   // rerendering) did not update the DOM. So we update it manually now.\n    //   this.el.innerHTML = this.lastHTML;\n    // }\n    if (lastProps.body === this.props.body) return;\n\n    const lengthWithoutNewlines =\n      this.props.body.replace(/\\n/, '').replace(/&[^;]+;/g, ' ').length + 1;\n\n    const newPosition = this.position + (this.hitEnter ? 1 : 0);\n\n    if (this.props.lengthDelta) {\n      setCurrentCursorPosition(this.el, (this.position += this.props.lengthDelta));\n    } else if (newPosition <= lengthWithoutNewlines) {\n      setCurrentCursorPosition(this.el, newPosition);\n      this.hitEnter = false;\n    } else {\n      setCurrentCursorPosition(this.el, lengthWithoutNewlines - 1);\n    }\n    this.el.focus();\n  }\n\n  handleKeyDown(e) {\n    if (this.props.onKeyDown && this.props.onKeyDown(e) === false) {\n      return false;\n    }\n    this.hitEnter = e.keyCode === 13;\n    return true;\n  }\n\n  emitChange(e) {\n    if (!this.el) return;\n    const html = this.el.innerHTML;\n    if (this.props.onChange && html !== this.lastHtml) {\n      const value = stripContentEditableHTML(html);\n\n      e.target = { value };\n      this.props.onChange(e);\n    }\n    this.lastHtml = html;\n    this.position = getCurrentCursorPosition('editor');\n  }\n\n  render() {\n    this.lastHTML = renderBody(this.props.body);\n    const className = [this.props.className];\n    if (this.props.body.length) className.push('active');\n    return (\n      <div\n        id=\"editor\"\n        className={this.props.className}\n        placeholder={this.props.placeholder}\n        role=\"textbox\"\n        ref={el => (this.el = el)}\n        onInput={this.emitChange}\n        onKeyDown={this.handleKeyDown}\n        onBlur={this.props.onBlur || this.emitChange}\n        onPaste={onPaste}\n        contentEditable={!this.props.disabled}\n        dangerouslySetInnerHTML={{ __html: this.lastHTML }}\n      />\n    );\n  }\n}\n"],"file":"contentEditable.component.js"}