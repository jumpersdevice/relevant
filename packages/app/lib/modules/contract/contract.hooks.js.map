{"version":3,"sources":["../../../src/modules/contract/contract.hooks.js"],"names":["Alert","alert","_web3","useWeb3Actions","dispatch","init","web3Instance","_web3Actions","network","accounts","useRelevantActions","tokenActions","actions","tokenAddress","getEvent","event","events","get","at","subscribeToEvent","subscribe","call","method","args","methods","send","options","useWeb3","useMetamask","web3","isInitialized","status","networkId","metamask","autoRefreshOnNetworkChange","enable","err","getAccounts","_accounts","getSuccess","getNetworkId","getId","on","off","useBalance","userBalance","haveBalance","length","relCoins","phase","value","useEventSubscription","useTokenContract","getState","methodCache","select","cacheMethod","cacheSend","useRelevantToken","useTxState","tx","callback","txState","payload"],"mappings":"6iBAAA,4BACA,uCACA,oCACA,8CACA,4BACA,6CACA,kCACA,8CACA,6C,yyBAEA,GAAMA,CAAAA,KAAK,CAAGC,aAAMD,KAAN,EAAd,CACA,GAAME,CAAAA,KAAK,CAAG,sBAAd,CAEO,GAAMC,CAAAA,cAAc,CAAG,QAAjBA,CAAAA,cAAiB,EAAM,CAClC,GAAMC,CAAAA,QAAQ,CAAG,6BAAjB,CACA,MAAO,CACLC,IAAI,CAAE,uBAAY,SAAAC,YAAY,QAAIF,CAAAA,QAAQ,CAACG,sBAAaF,IAAb,CAAkBA,IAAlB,CAAuBC,YAAvB,CAAD,CAAZ,EAAxB,CAA4E,CAChFF,QADgF,CAA5E,CADD,CAILI,OAAO,CAAE,+CAAwBD,sBAAaC,OAArC,EAAgDJ,QAAhD,CAJJ,CAKLK,QAAQ,CAAE,+CAAwBF,sBAAaE,QAArC,EAAiDL,QAAjD,CALL,CAAP,CAOD,CATM,C,sCAWA,GAAMM,CAAAA,kBAAkB,CAAG,QAArBA,CAAAA,kBAAqB,EAAM,kBACU,4BADV,CACrBC,YADqB,cAC9BC,OAD8B,CACPC,YADO,cACPA,YADO,CAEtC,GAAMT,CAAAA,QAAQ,CAAG,6BAAjB,CACA,GAAMQ,CAAAA,OAAO,CAAG,CACdE,QAAQ,CAAE,uBACR,SAAAC,KAAK,CAAI,CACPX,QAAQ,CAACO,YAAY,CAACK,MAAb,CAAoBD,KAApB,EAA2BE,GAA3B,CAA+B,CAAEC,EAAE,CAAEL,YAAN,CAA/B,CAAD,CAAR,CACD,CAHO,CAIR,CAACT,QAAD,CAAWO,YAAX,CAAyBE,YAAzB,CAJQ,CADI,CAOdM,gBAAgB,CAAE,uBAChB,SAAAJ,KAAK,CAAI,CACPX,QAAQ,CAACO,YAAY,CAACK,MAAb,CAAoBD,KAApB,EAA2BE,GAA3B,CAA+B,CAAEC,EAAE,CAAEL,YAAN,CAA/B,CAAD,CAAR,CACA,MAAOT,CAAAA,QAAQ,CAACO,YAAY,CAACK,MAAb,CAAoBD,KAApB,EAA2BK,SAA3B,CAAqC,CAAEF,EAAE,CAAEL,YAAN,CAArC,CAAD,CAAf,CACD,CAJe,CAKhB,CAACT,QAAD,CAAWO,YAAX,CAAyBE,YAAzB,CALgB,CAPJ,CAcdQ,IAAI,CAAE,uBACJ,SAACC,MAAD,CAASC,IAAT,CAAkB,CAChB,GAAIA,IAAJ,CACE,MAAOnB,CAAAA,QAAQ,CAACO,YAAY,CAACa,OAAb,CAAqBF,MAArB,EAA6B,CAAEJ,EAAE,CAAEL,YAAN,CAA7B,EAAmDQ,IAAnD,CAAwDE,IAAxD,CAAD,CAAf,CACF,MAAOnB,CAAAA,QAAQ,CAACO,YAAY,CAACa,OAAb,CAAqBF,MAArB,EAA6B,CAAEJ,EAAE,CAAEL,YAAN,CAA7B,EAAmDQ,IAAnD,EAAD,CAAf,CACD,CALG,CAMJ,CAACjB,QAAD,CAAWO,YAAX,CAAyBE,YAAzB,CANI,CAdQ,CAsBdY,IAAI,CAAE,uBACJ,SAACH,MAAD,CAASI,OAAT,CAA8B,+BAATH,IAAS,qDAATA,IAAS,0BAC5B,GAAIA,IAAJ,CAAU,2BACR,MAAOnB,CAAAA,QAAQ,CACb,uBAAAO,YAAY,CAACa,OAAb,CAAqBF,MAArB,iBACEJ,EAAE,CAAEL,YADN,EAEKa,OAFL,IAGGD,IAHH,6BAGWF,IAHX,CADa,CAAf,CAMD,CACD,MAAOnB,CAAAA,QAAQ,CACbO,YAAY,CAACa,OAAb,CAAqBF,MAArB,iBACEJ,EAAE,CAAEL,YADN,EAEKa,OAFL,GAGGD,IAHH,EADa,CAAf,CAMD,CAhBG,CAiBJ,CAACrB,QAAD,CAAWO,YAAX,CAAyBE,YAAzB,CAjBI,CAtBQ,CAAhB,CA0CA,MAAOF,CAAAA,YAAY,CAAGC,OAAH,CAAa,EAAhC,CACD,CA9CM,C,8CAgDA,GAAMe,CAAAA,OAAO,CAAG,QAAVA,CAAAA,OAAU,EAAM,CAC3B,6BACAC,WAAW,GACX,GAAMC,CAAAA,IAAI,CAAG,4BAAb,CAH2B,oBAIV1B,cAAc,EAJJ,CAInBE,IAJmB,iBAInBA,IAJmB,CAK3B,qBAAU,UAAM,CAGd,GAAI,CAACwB,IAAI,CAACC,aAAV,CAAyBzB,IAAI,CAACH,KAAD,CAAJ,CAC1B,CAJD,CAIG,CAAC2B,IAAI,CAACE,MAAN,CAAcF,IAAI,CAACC,aAAnB,CAAkCzB,IAAlC,CAJH,EAKA,MAAO,CAACwB,IAAI,CAACpB,QAAN,CAAgBoB,IAAI,CAACC,aAArB,CAAoCD,IAAI,CAACG,SAAzC,CAAP,CACD,CAXM,C,wBAgBA,GAAMJ,CAAAA,WAAW,CAAG,QAAdA,CAAAA,WAAc,EAAM,CAC/B,GAAMxB,CAAAA,QAAQ,CAAG,6BAAjB,CACA,GAAM6B,CAAAA,QAAQ,CAAG,sBAAjB,CACA,GAAIA,QAAJ,CAAcA,QAAQ,CAACC,0BAAT,CAAsC,KAAtC,CAEd,qBAAU,UAAM,CACd,GAAI,CAACD,QAAL,CAAe,MAAO,WAAM,CAAE,CAAf,CACf,GAAI,CACFA,QAAQ,CAACE,MAAT,GACD,CAAC,MAAOC,GAAP,CAAY,CACZ,MAAO,WAAM,CAAE,CAAf,CACD,CAED,GAAMC,CAAAA,WAAW,CAAG,QAAdA,CAAAA,WAAc,CAAAC,SAAS,QAC3BlC,CAAAA,QAAQ,CAACG,sBAAaE,QAAb,CAAsB8B,UAAtB,CAAiCD,SAAjC,CAAD,CADmB,EAA7B,CAEA,GAAME,CAAAA,YAAY,CAAG,QAAfA,CAAAA,YAAe,SAAMpC,CAAAA,QAAQ,CAACG,sBAAaC,OAAb,CAAqBiC,KAArB,EAAD,CAAd,EAArB,CAEAR,QAAQ,CAACS,EAAT,CAAY,iBAAZ,CAA+BL,WAA/B,EACAJ,QAAQ,CAACS,EAAT,CAAY,gBAAZ,CAA8BF,YAA9B,EACA,MAAO,WAAM,CACXP,QAAQ,CAACU,GAAT,CAAa,iBAAb,CAAgCN,WAAhC,EACAJ,QAAQ,CAACU,GAAT,CAAa,gBAAb,CAA+BH,YAA/B,EACD,CAHD,CAID,CAlBD,CAkBG,CAACpC,QAAD,CAAW6B,QAAX,CAlBH,EAmBA,MAAOA,CAAAA,QAAP,CACD,CAzBM,C,gCA2BA,GAAMW,CAAAA,UAAU,CAAG,QAAbA,CAAAA,UAAa,EAAM,mBACT,4BADS,CACtBnC,QADsB,eACtBA,QADsB,uBAEN,gCAFM,CAEtBoC,WAFsB,mBAEtBA,WAFsB,yBAGKnC,kBAAkB,EAHvB,CAGtBW,IAHsB,qBAGtBA,IAHsB,CAGhBF,gBAHgB,qBAGhBA,gBAHgB,CAI9B,GAAM2B,CAAAA,WAAW,CAAG,CAAC,CAACD,WAAtB,CAEA,qBAAU,UAAM,CACd1B,gBAAgB,EAAIA,gBAAgB,CAAC,UAAD,CAApC,CACA,GAAIV,QAAQ,EAAIA,QAAQ,CAACsC,MAArB,EAA+B,CAACD,WAApC,CAAiD,CAC/CzB,IAAI,EAAIA,IAAI,CAAC,WAAD,CAAcZ,QAAQ,CAAC,CAAD,CAAtB,CAAZ,CACD,CACF,CALD,CAKG,CAACA,QAAD,CAAWqC,WAAX,CAAwBzB,IAAxB,CAA8BF,gBAA9B,CALH,EAOA,GAAM6B,CAAAA,QAAQ,CACZH,WAAW,EAAIA,WAAW,CAACI,KAAZ,GAAsB,SAArC,CACI,kBAASJ,WAAW,CAACK,KAArB,CAA4B,EAA5B,CADJ,CAEI,IAHN,CAKA,MAAOF,CAAAA,QAAP,CACD,CAnBM,C,8BAqBA,GAAMG,CAAAA,oBAAoB,CAAG,QAAvBA,CAAAA,oBAAuB,EAAM,0BACXzC,kBAAkB,EADP,CAChCS,gBADgC,sBAChCA,gBADgC,CAExC,qBAAU,UAAM,CACdA,gBAAgB,CAAC,UAAD,CAAhB,CACD,CAFD,CAEG,CAACA,gBAAD,CAFH,EAGD,CALM,C,kDAUA,GAAMiC,CAAAA,gBAAgB,CAAG,QAAnBA,CAAAA,gBAAmB,EAAM,CACpC,6BADoC,uBAEf,gCAFe,CAE5BC,QAF4B,oBAE5BA,QAF4B,CAGpC,GAAMxB,CAAAA,IAAI,CAAG,4BAAb,CAHoC,yBAIbnB,kBAAkB,EAJL,CAI5BW,IAJ4B,sBAI5BA,IAJ4B,CAItBI,IAJsB,sBAItBA,IAJsB,CAKpCE,OAAO,GACPiB,UAAU,GAEV,MAAO,CACLf,IAAI,CAACpB,QADA,CAEL,CAAE6C,WAAW,CAAE,CAAEC,MAAM,CAAEF,QAAV,CAAf,CAFK,CAGL,CAAEG,WAAW,CAAEnC,IAAf,CAAqBoC,SAAS,CAAEhC,IAAhC,CAHK,CAAP,CAKD,CAbM,C,0CAgBA,GAAMiC,CAAAA,gBAAgB,CAAG,QAAnBA,CAAAA,gBAAmB,EAAM,CACpC,6BADoC,uBAEf,gCAFe,CAE5BL,QAF4B,oBAE5BA,QAF4B,CAGpC,GAAMxB,CAAAA,IAAI,CAAG,4BAAb,CAHoC,yBAIbnB,kBAAkB,EAJL,CAI5BW,IAJ4B,sBAI5BA,IAJ4B,CAItBI,IAJsB,sBAItBA,IAJsB,CAKpCE,OAAO,GACPiB,UAAU,GAEV,MAAO,CAAEnC,QAAQ,CAAEoB,IAAI,CAACpB,QAAjB,CAA2B4C,QAAQ,CAARA,QAA3B,CAAqChC,IAAI,CAAJA,IAArC,CAA2CI,IAAI,CAAJA,IAA3C,CAAP,CACD,CATM,C,0CAWA,GAAMkC,CAAAA,UAAU,CAAG,QAAbA,CAAAA,UAAa,MAA8B,IAA3BC,CAAAA,EAA2B,MAA3BA,EAA2B,CAAvBtC,MAAuB,MAAvBA,MAAuB,CAAfuC,QAAe,MAAfA,QAAe,wBACjC,gCADiC,CAC9CR,QAD8C,oBAC9CA,QAD8C,CAEtD,GAAI,CAACO,EAAD,EAAO,CAACP,QAAZ,CAAsB,MAAO,KAAP,CAEtB,GAAMS,CAAAA,OAAO,CAAGT,QAAQ,MAAR,SAAS/B,MAAT,yCAAoBsC,EAAE,CAACG,OAAH,CAAWxC,IAA/B,GAAhB,CAEA,GAAIuC,OAAO,EAAIA,OAAO,CAACb,KAAR,GAAkB,SAAjC,CAA4C,CAC1CjD,KAAK,CAACC,KAAN,CAAY,wBAAZ,CAAsC,SAAtC,EACA4D,QAAQ,GACR,MAAO,SAAP,CACD,CAED,GAAIC,OAAO,EAAIA,OAAO,CAACb,KAAR,GAAkB,OAAjC,CAA0C,CACxCjD,KAAK,CAACC,KAAN,CAAY6D,OAAO,CAACZ,KAAR,CAAcjC,GAAd,CAAkB,SAAlB,CAAZ,EACA4C,QAAQ,GACR,MAAO,OAAP,CACD,CAED,MAAO,SAAP,CACD,CAnBM,C","sourcesContent":["import { useEffect, useCallback } from 'react';\nimport { useDispatch } from 'react-redux';\nimport { formatBN } from 'utils/eth';\nimport { getProvider, getMetamask } from 'utils/web3.provider';\nimport { bindActionCreators } from 'redux';\nimport { actions as _web3Actions } from 'redux-saga-web3';\nimport { alert } from 'app/utils';\nimport { useWeb3State, useRelevantState } from './contract.selectors';\nimport { useContract } from './contract.context';\n\nconst Alert = alert.Alert();\nconst _web3 = getProvider();\n\nexport const useWeb3Actions = () => {\n  const dispatch = useDispatch();\n  return {\n    init: useCallback(web3Instance => dispatch(_web3Actions.init.init(web3Instance)), [\n      dispatch\n    ]),\n    network: bindActionCreators({ ..._web3Actions.network }, dispatch),\n    accounts: bindActionCreators({ ..._web3Actions.accounts }, dispatch)\n  };\n};\n\nexport const useRelevantActions = () => {\n  const { actions: tokenActions, tokenAddress } = useContract();\n  const dispatch = useDispatch();\n  const actions = {\n    getEvent: useCallback(\n      event => {\n        dispatch(tokenActions.events[event].get({ at: tokenAddress }));\n      },\n      [dispatch, tokenActions, tokenAddress]\n    ),\n    subscribeToEvent: useCallback(\n      event => {\n        dispatch(tokenActions.events[event].get({ at: tokenAddress }));\n        return dispatch(tokenActions.events[event].subscribe({ at: tokenAddress }));\n      },\n      [dispatch, tokenActions, tokenAddress]\n    ),\n    call: useCallback(\n      (method, args) => {\n        if (args)\n          return dispatch(tokenActions.methods[method]({ at: tokenAddress }).call(args));\n        return dispatch(tokenActions.methods[method]({ at: tokenAddress }).call());\n      },\n      [dispatch, tokenActions, tokenAddress]\n    ),\n    send: useCallback(\n      (method, options, ...args) => {\n        if (args) {\n          return dispatch(\n            tokenActions.methods[method]({\n              at: tokenAddress,\n              ...options\n            }).send(...args)\n          );\n        }\n        return dispatch(\n          tokenActions.methods[method]({\n            at: tokenAddress,\n            ...options\n          }).send()\n        );\n      },\n      [dispatch, tokenActions, tokenAddress]\n    )\n  };\n  return tokenActions ? actions : {};\n};\n\nexport const useWeb3 = () => {\n  useContract();\n  useMetamask();\n  const web3 = useWeb3State();\n  const { init } = useWeb3Actions();\n  useEffect(() => {\n    // TODO this init function opens a connect popup which prevents\n    // the display of a custom popup (like connect/signature)\n    if (!web3.isInitialized) init(_web3);\n  }, [web3.status, web3.isInitialized, init]);\n  return [web3.accounts, web3.isInitialized, web3.networkId];\n};\n\n// Perhaps this should not be an effect?\n// This is just global metamask setup that should be done once.\n// But we need to consider the case where we start out with no metamask and then enable metamask.\nexport const useMetamask = () => {\n  const dispatch = useDispatch();\n  const metamask = getMetamask();\n  if (metamask) metamask.autoRefreshOnNetworkChange = false;\n\n  useEffect(() => {\n    if (!metamask) return () => {};\n    try {\n      metamask.enable();\n    } catch (err) {\n      return () => {};\n    }\n\n    const getAccounts = _accounts =>\n      dispatch(_web3Actions.accounts.getSuccess(_accounts));\n    const getNetworkId = () => dispatch(_web3Actions.network.getId());\n\n    metamask.on('accountsChanged', getAccounts);\n    metamask.on('networkChanged', getNetworkId);\n    return () => {\n      metamask.off('accountsChanged', getAccounts);\n      metamask.off('networkChanged', getNetworkId);\n    };\n  }, [dispatch, metamask]);\n  return metamask;\n};\n\nexport const useBalance = () => {\n  const { accounts } = useWeb3State();\n  const { userBalance } = useRelevantState();\n  const { call, subscribeToEvent } = useRelevantActions();\n  const haveBalance = !!userBalance;\n\n  useEffect(() => {\n    subscribeToEvent && subscribeToEvent('Transfer');\n    if (accounts && accounts.length && !haveBalance) {\n      call && call('balanceOf', accounts[0]);\n    }\n  }, [accounts, haveBalance, call, subscribeToEvent]);\n\n  const relCoins =\n    userBalance && userBalance.phase === 'SUCCESS'\n      ? formatBN(userBalance.value, 18)\n      : null;\n\n  return relCoins;\n};\n\nexport const useEventSubscription = () => {\n  const { subscribeToEvent } = useRelevantActions();\n  useEffect(() => {\n    subscribeToEvent('Released');\n  }, [subscribeToEvent]);\n};\n\n// DEPRECATED backwards compatability\n\n// Rerturns [Accounts, Relevant State, Relevant Actions]\nexport const useTokenContract = () => {\n  useContract();\n  const { getState } = useRelevantState();\n  const web3 = useWeb3State();\n  const { call, send } = useRelevantActions();\n  useWeb3();\n  useBalance();\n  // useEventSubscription(ethActions);\n  return [\n    web3.accounts,\n    { methodCache: { select: getState } },\n    { cacheMethod: call, cacheSend: send }\n  ];\n};\n\n// Rerturns [Accounts, Relevant State, Relevant Actions]\nexport const useRelevantToken = () => {\n  useContract();\n  const { getState } = useRelevantState();\n  const web3 = useWeb3State();\n  const { call, send } = useRelevantActions();\n  useWeb3();\n  useBalance();\n  // useEventSubscription(ethActions);\n  return { accounts: web3.accounts, getState, call, send };\n};\n\nexport const useTxState = ({ tx, method, callback }) => {\n  const { getState } = useRelevantState();\n  if (!tx || !getState) return null;\n\n  const txState = getState(method, ...tx.payload.args);\n\n  if (txState && txState.phase === 'RECEIPT') {\n    Alert.alert('Transaction Completed!', 'success');\n    callback();\n    return 'success';\n  }\n\n  if (txState && txState.phase === 'ERROR') {\n    Alert.alert(txState.value.get('message'));\n    callback();\n    return 'error';\n  }\n\n  return 'pending';\n};\n"],"file":"contract.hooks.js"}