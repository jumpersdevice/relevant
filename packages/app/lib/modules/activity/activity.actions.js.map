{"version":3,"sources":["../../../src/modules/activity/activity.actions.js"],"names":["PushNotification","process","env","WEB","require","apiServer","API_SERVER","reqOptions","tk","credentials","headers","Accept","Authorization","setActivity","data","type","index","types","SET_ACTIVITY","payload","resetActivity","clearCount","setCount","SET_COUNT","getActivity","skip","dispatch","api","request","method","endpoint","path","auth","query","res","errorActions","setError","message","markRead","storage","getToken","then","fetch","catch","createNotification","obj","body","JSON","stringify","getNotificationCount","unread","showBannerPrompt","promptType","promptProps","SHOW_BANNER_PROMPT","hideBannerPrompt","notification","HIDE_BANNER_PROMPT","enableDesktopNotifications","subscription","desktop","all","toJSON","console","log","showBetPrompt","isDismissed","SHOW_BET_PROMPT_AFTER_DAYS","showPushNotificationPrompt","BROWSER","handleDesktopPrompt","handleMobilePrompt","Notification","permission","SHOW_DESKTOP_PROMPT_AFTER_DAYS","Promise","resolve","reject","checkPermissions","resp","permissions","alert","SHOW_MOBILE_PROMPT_AFTER_DAYS","isMobile"],"mappings":"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","sourcesContent":["import * as types from 'core/actionTypes';\nimport * as errorActions from 'modules/ui/error.actions';\nimport { api, storage } from 'app/utils';\nimport { initPushNotifications } from 'app/utils/notifications';\nimport { updateNotificationSettings } from 'modules/auth/auth.actions';\nimport {\n  SHOW_DESKTOP_PROMPT_AFTER_DAYS,\n  SHOW_MOBILE_PROMPT_AFTER_DAYS,\n  SHOW_BET_PROMPT_AFTER_DAYS\n} from './notificationTimes';\n\nlet PushNotification;\nif (process.env.WEB !== 'true') {\n  PushNotification = require('react-native-push-notification');\n}\n\nconst apiServer = `${process.env.API_SERVER}/api/notification`;\n\nconst reqOptions = tk => ({\n  credentials: 'include',\n  headers: {\n    Accept: 'application/json',\n    'Content-Type': 'application/json',\n    Authorization: `Bearer ${tk}`\n  }\n});\n\nexport function setActivity(data, type, index) {\n  return {\n    type: types.SET_ACTIVITY,\n    payload: {\n      data,\n      type,\n      index\n    }\n  };\n}\n\nexport function resetActivity(data) {\n  return {\n    type: 'RESET_ACTIVITY',\n    payload: data\n  };\n}\n\nexport function clearCount() {\n  return {\n    type: 'CLEAR_COUNT'\n  };\n}\n\nexport function setCount(data) {\n  return {\n    type: types.SET_COUNT,\n    payload: data\n  };\n}\n\nexport function getActivity(skip) {\n  return async dispatch => {\n    try {\n      const type = 'personal';\n      const res = await dispatch(\n        api.request({\n          method: 'GET',\n          endpoint: 'notification',\n          path: '/',\n          auth: true,\n          query: { skip }\n        })\n      );\n      dispatch(setActivity(res, type, skip));\n      dispatch(errorActions.setError('activity', false));\n    } catch (err) {\n      errorActions.setError('activity', true, err.message);\n    }\n  };\n}\n\nexport function markRead() {\n  return dispatch =>\n    storage\n      .getToken()\n      .then(tk =>\n        fetch(`${apiServer}/markread`, {\n          ...reqOptions(tk),\n          method: 'PUT'\n        })\n      )\n      .then(() => {\n        dispatch(clearCount());\n      })\n      .catch(null);\n}\n\nexport function createNotification(obj) {\n  return () =>\n    storage\n      .getToken()\n      .then(tk =>\n        fetch(`${apiServer}`, {\n          ...reqOptions(tk),\n          method: 'POST',\n          body: JSON.stringify(obj)\n        })\n      )\n      .catch(null);\n}\n\nexport function getNotificationCount() {\n  return async dispatch => {\n    try {\n      const res = await dispatch(\n        api.request({\n          method: 'GET',\n          endpoint: 'notification',\n          path: '/unread',\n          auth: true\n        })\n      );\n      dispatch(setCount(res.unread));\n    } catch (err) {} // eslint-disable-line\n  };\n}\n\nexport function showBannerPrompt(promptType, promptProps) {\n  return {\n    type: types.SHOW_BANNER_PROMPT,\n    payload: {\n      promptType,\n      promptProps\n    }\n  };\n}\n\nexport function hideBannerPrompt(notification) {\n  return {\n    type: types.HIDE_BANNER_PROMPT,\n    payload: notification\n  };\n}\n\nexport function enableDesktopNotifications() {\n  return async dispatch => {\n    try {\n      const subscription = await initPushNotifications();\n      dispatch(\n        updateNotificationSettings({ desktop: { all: true } }, subscription.toJSON())\n      );\n      dispatch(hideBannerPrompt());\n    } catch (err) {\n      console.log(err); // eslint-disable-line\n    }\n  };\n}\n\nexport const showBetPrompt = async dispatch => {\n  const isDismissed = await storage.isDismissed(\n    'betDismissed',\n    SHOW_BET_PROMPT_AFTER_DAYS\n  );\n  if (!isDismissed) return dispatch(showBannerPrompt('bet'));\n  return false;\n};\n\nexport const showPushNotificationPrompt = (promptProps = {}) => async dispatch => {\n  if (process.env.BROWSER === true) {\n    return handleDesktopPrompt({ dispatch, promptProps });\n  }\n  return handleMobilePrompt({ dispatch, promptProps });\n};\n\nasync function handleDesktopPrompt({ dispatch, promptProps }) {\n  if (\n    Notification &&\n    (Notification.permission === 'granted' || Notification.permission === 'denied')\n  ) {\n    return false;\n  }\n  const isDismissed = await storage.isDismissed(\n    'pushDismissed',\n    SHOW_DESKTOP_PROMPT_AFTER_DAYS\n  );\n  if (isDismissed) return false;\n\n  return dispatch(showBannerPrompt('push', promptProps));\n}\n\nasync function handleMobilePrompt({ dispatch, promptProps }) {\n  if (!PushNotification) return false;\n\n  const permissions = await new Promise((resolve, reject) => {\n    PushNotification.checkPermissions(resp => {\n      if (!resp) return reject();\n      return resolve(resp);\n    });\n  });\n\n  if (permissions.alert) return false;\n\n  const isDismissed = await storage.isDismissed(\n    'pushDismissed',\n    SHOW_MOBILE_PROMPT_AFTER_DAYS\n  );\n  if (isDismissed) return false;\n\n  return dispatch(showBannerPrompt('push', { ...promptProps, isMobile: true }));\n}\n"],"file":"activity.actions.js"}