{"version":3,"sources":["../src/queue.js"],"names":["relevantEnv","process","env","RELEVANT_ENV","q","concurrency","on","next","job","console","log","toString","replace","updateUserStats","repuatations","CommunityMember","find","forEach","rel","push","cb","date","Date","hour","getHours","day","setUTCHours","endTime","query","user","communityId","set","pagerank","update","$set","$inc","aggregateRelevance","totalSamples","Stats","findOneAndUpdate","new","upsert","setDefaultsOnInsert","Promise","resolve","reject","start","err","updateRepChange","rep","userRep","updateRelevanceRecord","save","community","Community","findOne","slug","_id","debug","updateRewards","ethRewards","rewards","now","getUTCHours","NODE_ENV","exit","module","exports"],"mappings":"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","sourcesContent":["import CommunityMember from 'server/api/community/community.member.model';\nimport queue from 'queue';\nimport computePageRank from 'server/pagerank/pagerankCompute';\nimport Stats from './api/statistics/statistics.model';\nimport Community from './api/community/community.model';\nimport ethRewards from './utils/ethRewards';\n\n/* eslint no-console: 0 */\nconst relevantEnv = process.env.RELEVANT_ENV;\n\nconst q = queue({ concurrency: 5 });\n\nq.on('timeout', (next, job) => {\n  console.log('job timed out:', job.toString().replace(/\\n/g, ''));\n  next();\n});\n\nasync function updateUserStats() {\n  const repuatations = await CommunityMember.find({});\n  repuatations.forEach(rel => {\n    q.push(async cb => {\n      const date = new Date();\n      const hour = date.getHours();\n      const day = date.setUTCHours(0, 0, 0, 0);\n      const endTime = day + 24 * 60 * 60 * 1000;\n      const query = {\n        user: rel.user,\n        date: day,\n        endTime,\n        communityId: rel.communityId\n      };\n      const set = {};\n      set['hours.' + hour] = rel.pagerank || 0;\n      const update = {\n        $set: set,\n        $inc: { aggregateRelevance: rel.pagerank, totalSamples: 1 }\n      };\n      await Stats.findOneAndUpdate(query, update, {\n        new: true,\n        upsert: true,\n        setDefaultsOnInsert: true\n      });\n      cb();\n    });\n  });\n\n  return new Promise((resolve, reject) => {\n    q.start(err => (err ? reject(err) : resolve()));\n  });\n}\n\nasync function updateRepChange() {\n  const rep = await CommunityMember.find();\n\n  rep.forEach(userRep =>\n    q.push(async cb => {\n      try {\n        if (userRep.user) {\n          // updates % stats\n          await userRep.updateRelevanceRecord();\n          await userRep.save();\n        }\n      } catch (err) {\n        console.log('error updating topic relevance income ', err);\n      }\n      cb();\n    })\n  );\n\n  return new Promise((resolve, reject) => {\n    q.start(err => (err ? reject(err) : resolve()));\n  });\n}\n\n// eslint-disable-next-line\nasync function pagerank(community) {\n  const communityId = (await Community.findOne({ slug: community }))._id;\n  await computePageRank({ communityId, community, debug: true });\n}\n\nasync function updateRewards() {\n  try {\n    await ethRewards.rewards();\n    console.log('done updating rewards');\n  } catch (err) {\n    console.log(err);\n  }\n\n  try {\n    await updateUserStats();\n    console.log('done updating stats');\n\n    const now = new Date();\n    if (now.getUTCHours() === 14) {\n      await updateRepChange();\n      console.log('done updating rep stats: ');\n    }\n  } catch (err) {\n    console.log(err);\n  }\n\n  if (relevantEnv === 'staging' || process.env.NODE_ENV === 'native') {\n    return;\n  }\n  process.exit();\n}\n\nif (process.env.NODE_ENV === 'production') {\n  updateRewards();\n}\n\nmodule.exports = {\n  updateUserStats,\n  updateRepChange\n};\n"],"file":"queue.js"}