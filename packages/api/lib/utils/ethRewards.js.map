{"version":3,"sources":["../../src/utils/ethRewards.js"],"names":["queue","require","IS_TEST","process","env","NODE_ENV","q","concurrency","debug","computingRewards","exports","rewards","Error","rewardPool","allocateRewards","oldRewards","getOldRewards","rewardFund","console","log","err","communities","Community","find","inactive","$ne","stakedTokens","Earnings","totalBalance","reduce","a","c","forEach","community","push","cb","computeCommunityRewards","updatedPosts","postPayouts","postRewards","payouts","distributedRewards","distributeUserRewards","res","slug","payoutData","Promise","resolve","reject","results","on","start","totalDistributedRewards","Object","values","result","value","now","Date","updateMany","payoutTime","$lte","status","multi","treasury","Treasury","findOne","unAllocatedRewards","save","updateRewardAllocation","cancelPendingTx","Eth","mintRewardTokens","getParam","noConvert","communityId","_id","reward","communityRewardShare","communityBalance","rewardShare","posts","PostData","eligibleForReward","paidOut","pendingPayouts","$gt","decay","getTime","lastRewardFundUpdate","SHARE_DECAY","currentShares","Math","min","topPostShares","postCount","post","pagerank","MINIMUM_RANK","computePostPayout","pendingPosts","updatePendingEarnings","map","p","title","payout","payoutShare","rank","communityRewardFund","average","all","_community","updatedUsers","votes","Invest","totalShares","v","shares","curationReward","updatedVotes","vote","amount","user","User","investor","curationWeight","curationPayout","floor","max","earning","updateRewardsRecord","earned","prevBalance","balance","endBalance","legacyAirdrop","referralTokens","airdropTokens","unlockTokens","lockedTokens","findOneAndUpdate","$inc","new","name","sendNotification","type","postData","props","s","action","numbers","abbreviateNumber","text","alertText","Notification","createNotification","forUser","coin","coinType","postObj","Post","data","payload","toUser","noteType","estimatedPostPayout","TOKEN_DECIMALS","aggregate","$match","$group","$sum"],"mappings":"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","sourcesContent":["/* eslint no-console: 0 */\nimport { sendNotification as sendPushNotification } from 'server/notifications';\nimport Notification from 'server/api/notification/notification.model';\nimport Post from 'server/api/post/post.model';\nimport { sendAdminAlert } from 'server/utils/mail';\nimport Treasury from 'server/api/treasury/treasury.model';\nimport computePageRank from 'server/pagerank/pagerankCompute';\nimport * as numbers from 'app/utils/numbers';\nimport User from '../api/user/user.model';\nimport Invest from '../api/invest/invest.model';\nimport Earnings from '../api/earnings/earnings.model';\nimport Community from '../api/community/community.model';\nimport * as Eth from './ethereum';\nimport { SHARE_DECAY, MINIMUM_RANK, TOKEN_DECIMALS } from '../config/globalConstants';\nimport PostData from '../api/post/postData.model';\nimport { runAudit } from './tokenAudit';\n\nconst queue = require('queue');\n\nconst IS_TEST = process.env.NODE_ENV === 'test';\n\nconst q = queue({ concurrency: 1 });\n// const debug = process.env.NODE_ENV === 'test';\nconst debug = false;\n\nlet computingRewards = false;\n\nexports.rewards = async () => {\n  // safeguard\n  if (computingRewards) throw new Error('computing rewards is already in progress!');\n  computingRewards = true;\n\n  let rewardPool;\n  try {\n    rewardPool = await allocateRewards();\n    const oldRewards = await getOldRewards();\n    rewardPool -= oldRewards[0].rewardFund;\n    console.log('rewardPool', rewardPool); // eslint-disable;\n    if (rewardPool < 0) throw new Error(`not enough funds in reward pool ${rewardPool}`);\n  } catch (err) {\n    console.log(err);\n    await sendAdminAlert(err);\n    throw err;\n  }\n\n  try {\n    const communities = await Community.find({ inactive: { $ne: true } });\n\n    const stakedTokens = await Earnings.stakedTokens();\n    console.log('stakedTokens', stakedTokens);\n\n    const totalBalance = stakedTokens.reduce((a, c) => c.stakedTokens + a, 0);\n    if (totalBalance === 0) return (computingRewards = false);\n\n    communities.forEach(community =>\n      q.push(async cb => {\n        community = await computeCommunityRewards(community, rewardPool, stakedTokens);\n        const { updatedPosts, postPayouts } = await postRewards(community);\n        const { payouts, distributedRewards } = await distributeUserRewards(\n          updatedPosts,\n          community\n        );\n\n        const res = {\n          community: community.slug,\n          payouts,\n          distributedRewards,\n          postPayouts\n        };\n\n        return cb(null, res);\n      })\n    );\n\n    const payoutData = await new Promise((resolve, reject) => {\n      const results = {};\n      q.on('success', res => (results[res.community] = res));\n      q.start(err => (err ? reject(err) : resolve(results)));\n    });\n\n    const totalDistributedRewards = Object.values(payoutData).reduce(\n      (result, value) => result + value.distributedRewards,\n      0\n    );\n\n    // TODO do we need these checks?\n    // const remainingRewards = await Eth.getParam('rewardPool', { noConvert: true });\n    // const distPool = await Eth.getParam('distributedRewards', { noConvert: true });\n    // console.log('distributedRewards Pool', distPool);\n    // console.log('Finished distributing rewards, remaining reward fund: ', remainingRewards);\n    const now = new Date();\n    await Earnings.updateMany(\n      { payoutTime: { $lte: now }, status: 'pending' },\n      { status: 'expired' },\n      { multi: true }\n    );\n\n    computingRewards = false;\n    await runAudit();\n\n    const treasury = await Treasury.findOne({ community: 'global' });\n    treasury.unAllocatedRewards += totalDistributedRewards;\n    await treasury.save();\n\n    if (treasury.unAllocatedRewards) await updateRewardAllocation();\n\n    return { payoutData, totalDistributedRewards };\n  } catch (err) {\n    console.log('rewards error', err);\n    computingRewards = false;\n    await sendAdminAlert(err);\n    // return null;\n    throw err;\n  }\n};\n\nasync function updateRewardAllocation() {\n  let treasury = await Treasury.findOne({ community: 'global' });\n  if (!treasury) {\n    treasury = new Treasury({ community: 'global' });\n    treasury = await treasury.save();\n  }\n  const { unAllocatedRewards } = treasury || {};\n  if (unAllocatedRewards) {\n    console.log('unAllocated Rewards', allocateRewards);\n    const cancelPendingTx = true;\n    await Eth.allocateRewards(unAllocatedRewards, cancelPendingTx);\n    treasury.unAllocatedRewards = 0;\n    await treasury.save();\n  }\n}\n\nasync function allocateRewards() {\n  await updateRewardAllocation();\n  const cancelPendingTx = true;\n  await Eth.mintRewardTokens(cancelPendingTx);\n  const rewardPool = await Eth.getParam('rewardFund', { noConvert: true });\n  return rewardPool;\n}\n\nasync function computeCommunityRewards(community, rewardPool, stakedTokens) {\n  await computePageRank({ communityId: community._id, community: community.slug, debug });\n  const reward = await communityRewardShare({ community, stakedTokens, rewardPool });\n\n  community.rewardFund += reward;\n  community = await community.save();\n  return community;\n}\n\nfunction communityRewardShare({ community, stakedTokens, rewardPool }) {\n  const totalBalance = stakedTokens.reduce((a, c) => c.stakedTokens + a, 0);\n  let communityBalance = stakedTokens.find(c => c._id === community.slug);\n  if (!communityBalance || !communityBalance.stakedTokens) return 0;\n  communityBalance = communityBalance.stakedTokens;\n\n  // compute portion of reward pool allocated to community\n  const rewardShare = communityBalance / totalBalance;\n  const rewards = rewardPool * rewardShare;\n\n  console.log('\\x1b[32m', 'Reward share of', community.slug, rewardShare);\n  console.log('\\x1b[32m', 'Rewards for', community.slug, rewards);\n  console.log('\\x1b[0m');\n\n  return rewards;\n}\n\nasync function postRewards(community) {\n  const now = new Date();\n\n  // use postData as post\n  const posts = await PostData.find({\n    eligibleForReward: true,\n    paidOut: false,\n    payoutTime: { $lte: now },\n    communityId: community._id\n  });\n\n  const pendingPayouts = await PostData.find({\n    eligibleForReward: true,\n    paidOut: false,\n    payoutTime: { $gt: now },\n    communityId: community._id\n  });\n\n  // decay current reward shares\n  const decay = IS_TEST\n    ? 0\n    : (now.getTime() - community.lastRewardFundUpdate.getTime()) / SHARE_DECAY;\n\n  community.currentShares *= 1 - Math.min(1, decay);\n  community.topPostShares *= 1 - Math.min(1, decay);\n  community.postCount *= 1 - Math.min(1, decay);\n\n  // add post relevance to treasury\n  posts.forEach(post => {\n    // cut off low-ranking posts\n    if (post.pagerank > MINIMUM_RANK) {\n      community.currentShares += post.pagerank;\n      community.postCount += 1;\n      if (post.pagerank >= community.currentShares / (community.postCount || 1)) {\n        community.topPostShares += post.pagerank;\n      }\n    }\n    post.paidOut = true;\n  });\n\n  community.lastRewardFundUpdate = now;\n  community = await community.save();\n\n  const updatedPosts = await computePostPayout({ posts, community });\n  // estimates post payout\n  const pendingPosts = await computePostPayout({ posts: pendingPayouts, community });\n  await updatePendingEarnings(pendingPosts);\n\n  const postPayouts = updatedPosts.map(p => ({\n    title: p.post,\n    payout: p.payout,\n    payoutShare: p.payoutShare,\n    rank: p.pagerank\n  }));\n  console.log('\\x1b[32m', 'distributed rewards to posts', postPayouts);\n  console.log('\\x1b[0m');\n\n  return { updatedPosts, postPayouts };\n}\n\n// ANALYSIS — attack scenario community with low-quality posts to bring down the average?\nasync function computePostPayout({ posts, community }) {\n  // let posts = await Post.find({ paidOut: false, payoutTime: { $lt: now } });\n  const communityRewardFund = community.rewardFund;\n  let updatedPosts = posts.map(async post => {\n    const average = community.currentShares / (community.postCount || 1);\n\n    // only reward above-average posts\n    console.log('rank vs average', post.pagerank, average);\n    if (post.pagerank < average) {\n      post.payout = 0;\n      return post.save();\n    }\n    // linear reward curve\n\n    // cap rewards share at 1/20th of the fund - especially for the first rewards?\n    post.payoutShare = Math.min(0.05, post.pagerank / (community.topPostShares || 1));\n    const payout = communityRewardFund * post.payoutShare;\n    community.rewardFund -= payout;\n    post.payout = payout;\n    return post.save();\n  });\n  updatedPosts = await Promise.all(updatedPosts);\n  await community.save();\n  return updatedPosts;\n}\n\nasync function distributeUserRewards(posts, _community) {\n  const { slug: community, _id: communityId } = _community;\n  const payouts = {};\n  let distributedRewards = 0;\n\n  const updatedUsers = posts.map(async post => {\n    const votes = await Invest.find({ post: post.post, communityId: post.communityId });\n\n    // compute total vote shares\n    const totalShares = votes.reduce((a, v) => a + v.shares, 0);\n\n    if (totalShares !== post.shares) {\n      console.log('post:', post.post);\n      console.log(\n        'ERROR: shares mismatch, investShares:',\n        totalShares,\n        'postShares:',\n        post.shares\n      );\n    }\n\n    if (totalShares === 0) return null;\n\n    const curationReward = post.payout;\n\n    //  ---------- Curation rewards ------------\n\n    const updatedVotes = votes.map(async vote => {\n      // don't count downvotes\n      if (vote.amount < 0) return null;\n\n      let user = await User.findOne(\n        { _id: vote.investor },\n        'name balance deviceTokens badge lockedTokens legacyAirdrop referralTokens airdropTokens'\n      );\n\n      const curationWeight = vote.shares / totalShares;\n      const curationPayout = Math.floor(curationWeight * curationReward);\n\n      distributedRewards += curationPayout;\n\n      payouts[user._id] = payouts[user._id]\n        ? payouts[user._id] + curationPayout\n        : curationPayout;\n\n      // TODO diff decimal?\n      const reward = Math.max(curationPayout, 0) / 10 ** 18;\n\n      const earning = await Earnings.updateRewardsRecord({\n        user: user._id,\n        post: post.post,\n        earned: reward,\n        status: curationPayout ? 'paidout' : 'expired',\n        prevBalance: user.balance,\n        endBalance: user.balance + reward,\n        legacyAirdrop: user.legacyAirdrop,\n        referralTokens: user.referralTokens,\n        airdropTokens: user.airdropTokens,\n        community,\n        communityId\n      });\n\n      const unlockTokens = Math.min(user.lockedTokens, earning.stakedTokens);\n\n      user = await User.findOneAndUpdate(\n        { _id: user._id },\n        { $inc: { balance: reward, lockedTokens: -unlockTokens } },\n        { new: true }\n      );\n\n      if (curationPayout === 0) return null;\n\n      console.log('Awarded', user.name, reward, 'tokens for', post.post);\n      return sendNotification({\n        user,\n        reward,\n        post: post.post,\n        type: 'vote',\n        community,\n        communityId,\n        postData: post\n      });\n    });\n    return Promise.all(updatedVotes);\n  });\n\n  await Promise.all(updatedUsers);\n\n  // transfer amounts to distributed rewards\n  console.log('total distributed rewards for', community, distributedRewards);\n  console.log('\\x1b[32m', payouts);\n  console.log('\\x1b[0m');\n  return { payouts, distributedRewards };\n}\n\nasync function sendNotification(props) {\n  const { user, reward, post, community, communityId, type, postData } = props;\n  const s = reward === 1 ? '' : 's';\n  const action = type === 'vote' ? 'upvoting ' : '';\n\n  const amount = numbers.abbreviateNumber(reward);\n  const text = `You earned ${amount} coin${s} from ${action}this post`;\n  const alertText = `You earned ${amount} coin${s} from ${action}a post`;\n\n  await Notification.createNotification({\n    post,\n    forUser: user._id,\n    type: 'reward',\n    coin: reward,\n    text,\n    coinType: 'eth',\n    community,\n    communityId\n  });\n\n  const postObj = await Post.findOne({ _id: post });\n  postObj.data = postData;\n\n  const payload = {\n    toUser: user,\n    post: postObj,\n    action: alertText,\n    noteType: 'reward'\n  };\n\n  sendPushNotification(user, alertText, payload);\n  return user;\n}\n\nasync function updatePendingEarnings(posts) {\n  posts = await posts.map(post =>\n    Earnings.updateMany(\n      { post: post.post },\n      { estimatedPostPayout: post.payout / TOKEN_DECIMALS },\n      { multi: true }\n    )\n  );\n  return Promise.all(posts);\n}\n\nasync function getOldRewards() {\n  return Community.aggregate([\n    { $match: {} },\n    {\n      $group: {\n        _id: 0,\n        rewardFund: { $sum: '$rewardFund' }\n      }\n    }\n  ]);\n}\n"],"file":"ethRewards.js"}