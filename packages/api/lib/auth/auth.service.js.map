{"version":3,"sources":["../../src/auth/auth.service.js"],"names":["secret","process","env","SESSION_SECRET","validateJwt","ignoreExpiration","isRevoked","verify","token","user","jwt","revoked","AuthToken","checkRevoked","req","payload","done","console","log","validateTokenLenient","res","next","cookies","headers","authorization","query","Object","prototype","hasOwnProperty","call","access_token","err","universalCookies","remove","validateTokenStrict","getUser","select","User","findById","_id","blocked","use","currentUser","authMiddleware","isAuthenticated","communityMember","role","globalAdmin","Error","community","member","CommunityMember","findOne","com","Community","slug","private","communityId","join","save","superAdmin","hasRole","roleRequired","config","userRoles","indexOf","sendStatus","signToken","id","sign","expiresIn","setTokenNative","json","message","set","setTokenCookieDesktop","redirect","setTokenCookie","exports"],"mappings":";;;;;;AAAA;;AACA;;AACA;;AACA;;AACA;;AACA;;AACA;;AACA;;AACA;;AAEA,IAAMA,MAAM,GAAGC,OAAO,CAACC,GAAR,CAAYC,cAA3B;AAEA,IAAMC,WAAW,GAAG,yBAAW;AAC7BJ,EAAAA,MAD6B;AAE7BK,EAAAA,gBAAgB,EAAE,IAFW;AAG7BC,EAAAA;AAH6B,CAAX,CAApB;;SAMeC,M;;;;;4CAAf,WAAsBC,KAAtB,EAA6B;AAC3B,QAAMC,IAAI,GAAGC,sBAAIH,MAAJ,CAAWC,KAAX,EAAkBR,MAAlB,EAA0B;AAAEK,MAAAA,gBAAgB,EAAE;AAApB,KAA1B,CAAb;;AACA,QAAMM,OAAO,SAASC,eAAUC,YAAV,CAAuBJ,IAAvB,CAAtB;AACA,QAAIE,OAAJ,EAAa,OAAO,IAAP;AACb,WAAOF,IAAP;AACD,G;;;;SAEcH,S;;EAOf;;;;+CAPA,WAAyBQ,GAAzB,EAA8BC,OAA9B,EAAuCC,IAAvC,EAA6C;AAC3C,QAAML,OAAO,SAASC,eAAUC,YAAV,CAAuBE,OAAvB,CAAtB;AACA,QAAIJ,OAAJ,EAAaM,OAAO,CAACC,GAAR,CAAY,kBAAZ,EAAgCH,OAAhC,EAF8B,CAEY;;AACvD,QAAIJ,OAAJ,EAAa,OAAOK,IAAI,CAAC,IAAD,EAAO,IAAP,CAAX;AACb,WAAOA,IAAI,EAAX;AACD,G;;;;AAGD,SAASG,oBAAT,CAA8BL,GAA9B,EAAmCM,GAAnC,EAAwCC,IAAxC,EAA8C;AAC5C,MAAM;AAAEb,IAAAA;AAAF,MAAYM,GAAG,CAACQ,OAAtB;;AACA,MAAId,KAAJ,EAAW;AACTM,IAAAA,GAAG,CAACS,OAAJ,CAAYC,aAAZ,GAA4B,YAAYhB,KAAxC;AACD,GAFD,MAEO,IACLM,GAAG,CAACW,KAAJ,IACAC,MAAM,CAACC,SAAP,CAAiBC,cAAjB,CAAgCC,IAAhC,CAAqCf,GAAG,CAACW,KAAzC,EAAgD,cAAhD,CAFK,EAGL;AACAX,IAAAA,GAAG,CAACS,OAAJ,CAAYC,aAAZ,GAA4B,YAAYV,GAAG,CAACW,KAAJ,CAAUK,YAAlD;AACD;;AACD,SAAO1B,WAAW,CAACU,GAAD,EAAMM,GAAN,EAAWW,GAAG,IAAI;AAClC,QAAIvB,KAAK,IAAIuB,GAAb,EAAkB;AAChBd,MAAAA,OAAO,CAACC,GAAR,CAAY,gBAAZ,EAA8Ba,GAA9B,EADgB,CACoB;;AACpCjB,MAAAA,GAAG,CAACkB,gBAAJ,CAAqBC,MAArB,CAA4B,OAA5B;AACD;;AACDZ,IAAAA,IAAI;AACL,GANiB,CAAlB;AAOD,C,CAED;;;AACA,SAASa,mBAAT,CAA6BpB,GAA7B,EAAkCM,GAAlC,EAAuCC,IAAvC,EAA6C;AAC3C,MAAM;AAAEb,IAAAA;AAAF,MAAYM,GAAG,CAACQ,OAAtB;;AACA,MAAId,KAAJ,EAAW;AACTM,IAAAA,GAAG,CAACS,OAAJ,CAAYC,aAAZ,GAA4B,YAAYhB,KAAxC;AACD,GAFD,MAEO,IACLM,GAAG,CAACW,KAAJ,IACAC,MAAM,CAACC,SAAP,CAAiBC,cAAjB,CAAgCC,IAAhC,CAAqCf,GAAG,CAACW,KAAzC,EAAgD,cAAhD,CAFK,EAGL;AACAX,IAAAA,GAAG,CAACS,OAAJ,CAAYC,aAAZ,GAA4B,YAAYV,GAAG,CAACW,KAAJ,CAAUK,YAAlD;AACD;;AACD,SAAO1B,WAAW,CAACU,GAAD,EAAMM,GAAN,EAAWC,IAAX,CAAlB;AACD;;AAED,SAASc,OAAT,CAAiBC,MAAjB,EAAyB;AACvB;AAAA,+CAAO,WAAOtB,GAAP,EAAYM,GAAZ,EAAiBC,IAAjB,EAA0B;AAC/B,UAAI;AACF,YAAI,CAACP,GAAG,CAACL,IAAT,EAAe,OAAOY,IAAI,EAAX;AACf,YAAMZ,IAAI,SAAS4B,cAAKC,QAAL,CAAcxB,GAAG,CAACL,IAAJ,CAAS8B,GAAvB,EAA4BH,MAA5B,CAAnB;;AACA,YAAI,CAAC3B,IAAL,EAAW;AACT;AACAQ,UAAAA,OAAO,CAACC,GAAR,CAAY,gCAAZ,EAA8CJ,GAAG,CAACL,IAAlD;AACAK,UAAAA,GAAG,CAACkB,gBAAJ,CAAqBC,MAArB,CAA4B,OAA5B;AACD;;AAEDnB,QAAAA,GAAG,CAACL,IAAJ,GAAWA,IAAX;AACA,eAAOY,IAAI,EAAX;AACD,OAXD,CAWE,OAAOU,GAAP,EAAY;AACZjB,QAAAA,GAAG,CAACL,IAAJ,GAAW,IAAX;AACAK,QAAAA,GAAG,CAACkB,gBAAJ,CAAqBC,MAArB,CAA4B,OAA5B;AACA,eAAOZ,IAAI,EAAX;AACD;AACF,KAjBD;;AAAA;AAAA;AAAA;AAAA;AAkBD;;AAED,SAASmB,OAAT,GAAmB;AACjB,SAAO,qCACJC,GADI,CACAtB,oBADA,EAEJsB,GAFI,CAEAN,OAAO,CAAC,qBAAD,CAFP,CAAP;AAGD;;AAED,SAASO,WAAT,GAAuB;AACrB,SAAO,qCACJD,GADI,CACAtB,oBADA,EAEJsB,GAFI,CAEAN,OAAO,EAFP,CAAP;AAGD;;AAED,SAASQ,cAAT,GAA0B;AACxB,SAAOT,mBAAP;AACD;AAED;;;;;;AAIA,SAASU,eAAT,GAA2B;AACzB,SAAO,qCACJH,GADI,CACAP,mBADA,EAEJO,GAFI,CAEAN,OAAO,CAAC,QAAD,CAFP,CAAP;AAGD;;AAED,SAASU,eAAT,CAAyBC,IAAzB,EAA+B;AAC7B;AAAA,gDAAO,WAAOhC,GAAP,EAAYM,GAAZ,EAAiBC,IAAjB,EAA0B;AAC/B,UAAI;AAAA;;AACF,YAAM;AAAEZ,UAAAA;AAAF,YAAWK,GAAjB;AACA,YAAMiC,WAAW,GAAGtC,IAAI,CAACqC,IAAL,KAAc,OAAlC;;AACA,YAAI,CAACrC,IAAD,IAAS,CAACA,IAAI,CAAC8B,GAAnB,EAAwB;AACtB,gBAAM,IAAIS,KAAJ,CAAU,0BAAV,CAAN;AACD;;AACD,YAAMC,SAAS,GAAGnC,GAAH,aAAGA,GAAH,qCAAGA,GAAG,CAAEW,KAAR,+CAAG,WAAYwB,SAA9B;AACA,YAAI,CAACA,SAAL,EAAgB5B,IAAI;AACpB,YAAI6B,MAAM,SAASC,yBAAgBC,OAAhB,CAAwB;AAAE3C,UAAAA,IAAI,EAAEA,IAAI,CAAC8B,GAAb;AAAkBU,UAAAA;AAAlB,SAAxB,CAAnB,CARE,CAUF;;AACA,YAAI,CAACC,MAAL,EAAa;AACX;AACA,cAAMG,GAAG,SAASC,oBAAUF,OAAV,CAAkB;AAAEG,YAAAA,IAAI,EAAEN;AAAR,WAAlB,CAAlB,CAFW,CAGX;;AACA,cAAI,CAACI,GAAD,IAASA,GAAG,CAACG,OAAJ,IAAe,CAACT,WAA7B,EACE,MAAM,IAAIC,KAAJ,CAAU,yBAAV,CAAN;AAEF,gBAAM,mCAAmB;AAAEvC,YAAAA,IAAI,EAAEK,GAAG,CAACL,IAAZ;AAAkBgD,YAAAA,WAAW,EAAEJ,GAAG,CAACd;AAAnC,WAAnB,CAAN;AAEAW,UAAAA,MAAM,SAASG,GAAG,CAACK,IAAJ,CAASjD,IAAT,CAAf;;AACA,cAAI,CAACyC,MAAM,CAACD,SAAZ,EAAuB;AACrBC,YAAAA,MAAM,CAACD,SAAP,GAAmBI,GAAG,CAACE,IAAvB;AACAL,YAAAA,MAAM,SAASA,MAAM,CAACS,IAAP,EAAf;AACD,WAbU,CAcX;;AACD;;AAED,YAAIb,IAAI,KAAK,YAAT,IAAyB,CAACC,WAA1B,IAAyC,CAACG,MAAM,CAACU,UAArD,EAAiE;AAC/D,gBAAM,IAAIZ,KAAJ,CAAU,mDAAV,CAAN;AACD;;AAED,YAAI,CAACE,MAAD,IAAW,CAACH,WAAhB,EACE,MAAM,IAAIC,KAAJ,CAAU,wCAAV,CAAN,CAjCA,CAkCF;;AACAlC,QAAAA,GAAG,CAAC+B,eAAJ,GAAsBK,MAAtB;AACA,eAAO7B,IAAI,EAAX;AACD,OArCD,CAqCE,OAAOU,GAAP,EAAY;AACZ,eAAOV,IAAI,CAACU,GAAD,CAAX;AACD;AACF,KAzCD;;AAAA;AAAA;AAAA;AAAA;AA0CD;AAED;;;;;AAGA,SAAS8B,OAAT,CAAiBC,YAAjB,EAA+B;AAC7B,MAAI,CAACA,YAAL,EAAmB,MAAM,IAAId,KAAJ,CAAU,+BAAV,CAAN;AACnB,SAAO,qCACJP,GADI,CACAG,eAAe,EADf,EAEJH,GAFI,CAEA,CAAC3B,GAAD,EAAMM,GAAN,EAAWC,IAAX,KAAoB;AACvB,QACE0C,gBAAOC,SAAP,CAAiBC,OAAjB,CAAyBnD,GAAG,CAACL,IAAJ,CAASqC,IAAlC,KAA2CiB,gBAAOC,SAAP,CAAiBC,OAAjB,CAAyBH,YAAzB,CAD7C,EAEE;AACAzC,MAAAA,IAAI;AACL,KAJD,MAIO;AACLD,MAAAA,GAAG,CAAC8C,UAAJ,CAAe,GAAf;AACD;AACF,GAVI,CAAP;AAWD;AAED;;;;;AAGA,SAASC,SAAT,CAAmBC,EAAnB,EAAuBtB,IAAvB,EAA6B;AAC3B,SAAOpC,sBAAI2D,IAAJ,CAAS;AAAE9B,IAAAA,GAAG,EAAE6B,EAAP;AAAWtB,IAAAA;AAAX,GAAT,EAA4B7C,OAAO,CAACC,GAAR,CAAYC,cAAxC,EAAwD;AAAEmE,IAAAA,SAAS,EAAE;AAAb,GAAxD,CAAP;AACD;;AAED,SAASC,cAAT,CAAwBzD,GAAxB,EAA6BM,GAA7B,EAAkC;AAChC,MAAI,CAACN,GAAG,CAACL,IAAT,EAAe;AACb,WAAOW,GAAG,CAACoD,IAAJ,CAAS,GAAT,EAAc;AAAEC,MAAAA,OAAO,EAAE;AAAX,KAAd,CAAP;AACD;;AAED,MAAMjE,KAAK,GAAG2D,SAAS,CAACrD,GAAG,CAACL,IAAJ,CAAS8B,GAAV,EAAezB,GAAG,CAACL,IAAJ,CAASqC,IAAxB,CAAvB;AACAhC,EAAAA,GAAG,CAACkB,gBAAJ,CAAqB0C,GAArB,CAAyB,OAAzB,EAAkClE,KAAlC;AAEA,SAAOY,GAAG,CAACoD,IAAJ,CAAS;AAAEhE,IAAAA,KAAF;AAASC,IAAAA,IAAI,EAAEK,GAAG,CAACL;AAAnB,GAAT,CAAP;AACD;;AAED,SAASkE,qBAAT,CAA+B7D,GAA/B,EAAoCM,GAApC,EAAyC;AACvC,MAAI,CAACN,GAAG,CAACL,IAAT,EAAe;AACb,WAAOW,GAAG,CAACoD,IAAJ,CAAS,GAAT,EAAc;AAAEC,MAAAA,OAAO,EAAE;AAAX,KAAd,CAAP;AACD;;AAED,MAAMjE,KAAK,GAAG2D,SAAS,CAACrD,GAAG,CAACL,IAAJ,CAAS8B,GAAV,EAAezB,GAAG,CAACL,IAAJ,CAASqC,IAAxB,CAAvB;AACAhC,EAAAA,GAAG,CAACkB,gBAAJ,CAAqB0C,GAArB,CAAyB,OAAzB,EAAkClE,KAAlC;AAEA,MAAMoE,QAAQ,GAAG9D,GAAG,CAACW,KAAJ,CAAUmD,QAAV,IAAsB,eAAvC;AACA,SAAOxD,GAAG,CAACwD,QAAJ,CAAaA,QAAb,CAAP;AACD;AAED;;;;;AAGA,SAASC,cAAT,CAAwB/D,GAAxB,EAA6BM,GAA7B,EAAkC;AAChC,MAAI,CAACN,GAAG,CAACL,IAAT,EAAe;AACb,WAAOW,GAAG,CAACoD,IAAJ,CAAS,GAAT,EAAc;AAAEC,MAAAA,OAAO,EAAE;AAAX,KAAd,CAAP;AACD;;AAED,MAAMjE,KAAK,GAAG2D,SAAS,CAACrD,GAAG,CAACL,IAAJ,CAAS8B,GAAV,EAAezB,GAAG,CAACL,IAAJ,CAASqC,IAAxB,CAAvB;AACAhC,EAAAA,GAAG,CAACkB,gBAAJ,CAAqB0C,GAArB,CAAyB,OAAzB,EAAkClE,KAAlC;AAEA,SAAOY,GAAG,CAACwD,QAAJ,CAAa,SAAb,CAAP;AACD;;AAEDE,OAAO,CAAClC,eAAR,GAA0BA,eAA1B;AACAkC,OAAO,CAACjB,OAAR,GAAkBA,OAAlB;AACAiB,OAAO,CAACX,SAAR,GAAoBA,SAApB;AACAW,OAAO,CAACD,cAAR,GAAyBA,cAAzB;AACAC,OAAO,CAACnC,cAAR,GAAyBA,cAAzB;AACAmC,OAAO,CAACpC,WAAR,GAAsBA,WAAtB;AACAoC,OAAO,CAACtC,OAAR,GAAkBA,OAAlB;AACAsC,OAAO,CAACH,qBAAR,GAAgCA,qBAAhC;AACAG,OAAO,CAACjC,eAAR,GAA0BA,eAA1B;AACAiC,OAAO,CAACP,cAAR,GAAyBA,cAAzB;AACAO,OAAO,CAAC3D,oBAAR,GAA+BA,oBAA/B;AACA2D,OAAO,CAACvE,MAAR,GAAiBA,MAAjB","sourcesContent":["import jwt from 'jsonwebtoken';\nimport expressJwt from 'express-jwt';\nimport compose from 'composable-middleware';\nimport AuthToken from 'server/api/token/token.model';\nimport { checkCommunityAuth } from 'server/api/community/community.auth';\nimport config from '../config/config';\nimport User from '../api/user/user.model';\nimport CommunityMember from '../api/community/community.member.model';\nimport Community from '../api/community/community.model';\n\nconst secret = process.env.SESSION_SECRET;\n\nconst validateJwt = expressJwt({\n  secret,\n  ignoreExpiration: true,\n  isRevoked\n});\n\nasync function verify(token) {\n  const user = jwt.verify(token, secret, { ignoreExpiration: true });\n  const revoked = await AuthToken.checkRevoked(user);\n  if (revoked) return null;\n  return user;\n}\n\nasync function isRevoked(req, payload, done) {\n  const revoked = await AuthToken.checkRevoked(payload);\n  if (revoked) console.log('token is revoked', payload); // eslint-disable-line\n  if (revoked) return done(null, true);\n  return done();\n}\n\n// doesn't throw error if user is not authenticated\nfunction validateTokenLenient(req, res, next) {\n  const { token } = req.cookies;\n  if (token) {\n    req.headers.authorization = 'Bearer ' + token;\n  } else if (\n    req.query &&\n    Object.prototype.hasOwnProperty.call(req.query, 'access_token')\n  ) {\n    req.headers.authorization = 'Bearer ' + req.query.access_token;\n  }\n  return validateJwt(req, res, err => {\n    if (token && err) {\n      console.log('REMOVING TOKEN', err); // eslint-disable-line\n      req.universalCookies.remove('token');\n    }\n    next();\n  });\n}\n\n// throws error if user is not authenticated\nfunction validateTokenStrict(req, res, next) {\n  const { token } = req.cookies;\n  if (token) {\n    req.headers.authorization = 'Bearer ' + token;\n  } else if (\n    req.query &&\n    Object.prototype.hasOwnProperty.call(req.query, 'access_token')\n  ) {\n    req.headers.authorization = 'Bearer ' + req.query.access_token;\n  }\n  return validateJwt(req, res, next);\n}\n\nfunction getUser(select) {\n  return async (req, res, next) => {\n    try {\n      if (!req.user) return next();\n      const user = await User.findById(req.user._id, select);\n      if (!user) {\n        // eslint-disable-next-line\n        console.log(\"User doesn't exist - bad token\", req.user);\n        req.universalCookies.remove('token');\n      }\n\n      req.user = user;\n      return next();\n    } catch (err) {\n      req.user = null;\n      req.universalCookies.remove('token');\n      return next();\n    }\n  };\n}\n\nfunction blocked() {\n  return compose()\n    .use(validateTokenLenient)\n    .use(getUser('+blocked +blockedBy'));\n}\n\nfunction currentUser() {\n  return compose()\n    .use(validateTokenLenient)\n    .use(getUser());\n}\n\nfunction authMiddleware() {\n  return validateTokenStrict;\n}\n\n/**\n * Attaches the user object to the request if authenticated\n * Otherwise returns 403\n */\nfunction isAuthenticated() {\n  return compose()\n    .use(validateTokenStrict)\n    .use(getUser('+email'));\n}\n\nfunction communityMember(role) {\n  return async (req, res, next) => {\n    try {\n      const { user } = req;\n      const globalAdmin = user.role === 'admin';\n      if (!user || !user._id) {\n        throw new Error('missing user credentials');\n      }\n      const community = req?.query?.community;\n      if (!community) next();\n      let member = await CommunityMember.findOne({ user: user._id, community });\n\n      // add member to default community\n      if (!member) {\n        // TODO join community that one is signing up with\n        const com = await Community.findOne({ slug: community });\n        // TODO private communities\n        if (!com || (com.private && !globalAdmin))\n          throw new Error(\"Community doesn't exist\");\n\n        await checkCommunityAuth({ user: req.user, communityId: com._id });\n\n        member = await com.join(user);\n        if (!member.community) {\n          member.community = com.slug;\n          member = await member.save();\n        }\n        // }\n      }\n\n      if (role === 'superAdmin' && !globalAdmin && !member.superAdmin) {\n        throw new Error(\"You don't have the priveleges required to do this\");\n      }\n\n      if (!member && !globalAdmin)\n        throw new Error('you are not a member of this community');\n      // TODO grab user reputation & figure out permission level\n      req.communityMember = member;\n      return next();\n    } catch (err) {\n      return next(err);\n    }\n  };\n}\n\n/**\n * Checks if the user role meets the minimum requirements of the route\n */\nfunction hasRole(roleRequired) {\n  if (!roleRequired) throw new Error('Required role needs to be set');\n  return compose()\n    .use(isAuthenticated())\n    .use((req, res, next) => {\n      if (\n        config.userRoles.indexOf(req.user.role) >= config.userRoles.indexOf(roleRequired)\n      ) {\n        next();\n      } else {\n        res.sendStatus(403);\n      }\n    });\n}\n\n/**\n * Returns a jwt token signed by the app secret\n */\nfunction signToken(id, role) {\n  return jwt.sign({ _id: id, role }, process.env.SESSION_SECRET, { expiresIn: '7 days' });\n}\n\nfunction setTokenNative(req, res) {\n  if (!req.user) {\n    return res.json(404, { message: 'Something went wrong, please try again.' });\n  }\n\n  const token = signToken(req.user._id, req.user.role);\n  req.universalCookies.set('token', token);\n\n  return res.json({ token, user: req.user });\n}\n\nfunction setTokenCookieDesktop(req, res) {\n  if (!req.user) {\n    return res.json(404, { message: 'Something went wrong, please try again.' });\n  }\n\n  const token = signToken(req.user._id, req.user.role);\n  req.universalCookies.set('token', token);\n\n  const redirect = req.query.redirect || '/relevant/new';\n  return res.redirect(redirect);\n}\n\n/**\n * Set token cookie directly for oAuth strategies\n */\nfunction setTokenCookie(req, res) {\n  if (!req.user) {\n    return res.json(404, { message: 'Something went wrong, please try again.' });\n  }\n\n  const token = signToken(req.user._id, req.user.role);\n  req.universalCookies.set('token', token);\n\n  return res.redirect('/signup');\n}\n\nexports.isAuthenticated = isAuthenticated;\nexports.hasRole = hasRole;\nexports.signToken = signToken;\nexports.setTokenCookie = setTokenCookie;\nexports.authMiddleware = authMiddleware;\nexports.currentUser = currentUser;\nexports.blocked = blocked;\nexports.setTokenCookieDesktop = setTokenCookieDesktop;\nexports.communityMember = communityMember;\nexports.setTokenNative = setTokenNative;\nexports.validateTokenLenient = validateTokenLenient;\nexports.verify = verify;\n"],"file":"auth.service.js"}