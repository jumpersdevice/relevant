{"version":3,"sources":["../src/server.js"],"names":["bodyParser","require","mongoose","cookieParser","session","favicon","MongoStore","cookiesMiddleware","path","expressStaticGzip","app","Express","Promise","global","validateTokenLenient","verify","corsOptions","ENABLE_CORS","origin","optionsSuccessStatus","process","env","use","limiter","windowMs","max","console","log","NODE_ENV","EventEmitter","prototype","_maxListeners","isDevelopment","relevantEnv","RELEVANT_ENV","urlencoded","extended","json","join","__dirname","db","secret","SESSION_SECRET","resave","saveUninitialized","cookie","maxAge","store","mongooseConnection","connection","autoRemove","autoRemoveInterval","touchAfter","clear_interval","passport","initialize","requireHTTPS","req","res","next","headers","redirect","get","url","NO_SSL","resolve","replace","index","port","PORT","WEB_CONCURRENCY","server","ApolloServer","schema","playground","context","user","applyMiddleware","cors","socketServer","default","listen","error","info","now","Date","time","getTime","pingTimeout","SubscriptionServer","create","onOperation","message","params","token","payload","err","execute","subscribe","keepAlive","init","exports"],"mappings":"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","sourcesContent":["/* eslint-disable no-console, no-use-before-define */\nimport 'dotenv/config';\nimport 'sqreen';\nimport Express from 'express';\nimport morgan from 'morgan';\nimport passport from 'passport';\nimport { ApolloServer } from 'apollo-server-express';\nimport schema from 'server/graphql/schema';\nimport rateLimit from 'express-rate-limit';\nimport cors from 'cors';\n\nimport { SubscriptionServer } from 'subscriptions-transport-ws';\nimport { execute, subscribe } from 'graphql';\n\nconst bodyParser = require('body-parser');\nconst mongoose = require('mongoose');\nconst cookieParser = require('cookie-parser');\nconst session = require('express-session');\nconst favicon = require('serve-favicon');\nconst MongoStore = require('connect-mongo')(session);\nconst cookiesMiddleware = require('universal-cookie-express');\nconst path = require('path');\nconst expressStaticGzip = require('express-static-gzip');\n\nconst app = new Express();\nmongoose.Promise = global.Promise;\n\nconst { validateTokenLenient, verify } = require('server/auth/auth.service');\n\nconst corsOptions = ENABLE_CORS\n  ? {\n      origin: 'https://example.com',\n      optionsSuccessStatus: 200 // some legacy browsers (IE11, various SmartTVs) choke on 204\n    }\n  : null;\n\nconst { ENABLE_CORS } = process.env;\n\napp.use(cors(corsOptions));\n\nconst limiter = rateLimit({\n  windowMs: 1 * 60 * 1000, // 1 minute\n  max: 1000 // limit each IP to 1000 requests per windowMs\n});\n\nconsole.log('NODE_ENV', process.env.NODE_ENV);\n\nrequire('events').EventEmitter.prototype._maxListeners = 100;\n\n// -------------Dev server watch and hot reload---------------\nconst isDevelopment =\n  process.env.NODE_ENV !== 'production' &&\n  process.env.NODE_ENV !== 'test' &&\n  process.env.NODE_ENV !== 'native';\n\nconst relevantEnv = process.env.RELEVANT_ENV;\n\napp.use(limiter);\napp.use(bodyParser.urlencoded({ extended: false }));\napp.use(bodyParser.json());\napp.use(cookieParser());\napp.use(favicon(path.join(__dirname, '../favicon.ico')));\n\n// Connect to db\nconst { db } = require('./config/db.connect');\n\n// Persist sessions with MongoStore\n// We need to enable sessions for passport twitter because its an oauth 1.0 strategy\napp.use(\n  session({\n    secret: process.env.SESSION_SECRET,\n    resave: false,\n    saveUninitialized: false,\n    cookie: { maxAge: 14 * 24 * 60 * 60 * 1000 },\n    store: new MongoStore({\n      mongooseConnection: mongoose.connection,\n      autoRemove: 'interval',\n      autoRemoveInterval: 10, // In minutes. Default\n      touchAfter: 24 * 3600, // time period in seconds\n      clear_interval: 3600\n    })\n  })\n);\n\napp.use(passport.initialize());\napp.use(passport.session());\n\nfunction requireHTTPS(req, res, next) {\n  if (\n    req.headers['x-forwarded-proto'] !== 'https' &&\n    process.env.NODE_ENV === 'production'\n  ) {\n    return res.redirect('https://' + req.get('host') + req.url);\n  }\n  return next();\n}\n\nif (process.env.NO_SSL !== 'true') {\n  app.use(requireHTTPS);\n}\n\n// public folder\napp.use(\n  '/',\n  expressStaticGzip(\n    require.resolve('@r3l/app/public/service-worker').replace('/service-worker.js', ''),\n    { index: false }\n  )\n);\napp.use(cookiesMiddleware());\napp.use(morgan('short'));\n\nconst port = process.env.PORT || 3000;\n\nconsole.log('WEB CONCURRENCY ', process.env.WEB_CONCURRENCY);\n\nlet server = new ApolloServer({\n  schema,\n  playground: process.env.NODE_ENV !== 'production',\n  context: ({ req, connection }) =>\n    connection ? connection.context : { user: req.user || {} }\n});\n\napp.use('/graphql', validateTokenLenient);\nserver.applyMiddleware({ app, cors: false });\n\nconst socketServer = require('./socket').default;\n\nserver = app.listen({ port }, error => {\n  if (error) {\n    console.error(error);\n  } else {\n    console.info(\n      `==> 🌎  Listening on port ${port}. Open up http://localhost:${port}/ in your browser.`\n    );\n    const now = new Date();\n    require('./routes')(app);\n    const time = new Date().getTime() - now.getTime();\n    console.log('done loading routes', time / 1000, 's');\n  }\n});\nsocketServer(server, { pingTimeout: 30000 });\n\nSubscriptionServer.create(\n  {\n    onOperation: async (message, params) => {\n      const { token } = message.payload;\n      let user;\n      try {\n        user = await verify(token);\n      } catch (err) {\n        // console.log(err);\n      }\n      return {\n        ...params,\n        context: {\n          ...params.context,\n          user\n        }\n      };\n    },\n    execute,\n    subscribe,\n    schema,\n    keepAlive: 10000\n  },\n  {\n    server,\n    path: '/graphql'\n  }\n);\n\nsocketServer(server, { pingTimeout: 30000 });\n\n// in production this is a worker\nif (relevantEnv === 'staging' || isDevelopment || process.env.NODE_ENV === 'native') {\n  require('./queue');\n}\n\nrequire('./utils/tokenAudit');\nrequire('./utils/ethereum').init();\n// require('./utils/dbMigrate-v1.1.1');\n\nexports.app = app;\nexports.server = server;\nexports.db = db;\n"],"file":"server.js"}