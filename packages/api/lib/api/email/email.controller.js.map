{"version":3,"sources":["../../../src/api/email/email.controller.js"],"names":["inlineCss","require","emailStyle","generateList","type","query","users","now","Date","status","createdAt","$lt","Invite","find","$exists","waitlist","List","User","console","log","length","list","mailgun","lists","forEach","user","vars","code","remove","findOne","$or","email","twitterEmail","members","delete","u","subscribed","address","name","handle","trim","create","err","update","error","exports","validate","req","res","next","body","validateWebhook","timestamp","token","signature","send","message","index","html","url","Error","data","campaign","from","to","subject","json","save","Email","draft","sendStatus","load"],"mappings":"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","sourcesContent":["import List from 'server/api/emailList/list.model';\nimport { mailgun, sendEmail } from 'server/utils/mail';\nimport Email from './email.model';\nimport Invite from '../invites/invite.model';\nimport User from '../user/user.model';\n\nconst inlineCss = require('inline-css');\nconst { emailStyle } = require('../../utils/emailStyle');\n\n// const unsub = [\n//   'jasonfeifer@gmail.com',\n//   'nikitanaggarwal@gmail.com',\n//   'samseurynck@gmail.com',\n//   'adrianzorz@gmail.com',\n//   'disinfeqt@gmail.com',\n//   'mattf96@gmail.com'\n// ];\n\n// async function removeUnsubscribed() {\n//   await Invite.find({ email: { $in: unsub } }).remove();\n// }\n\n/* eslint no-console: 0 */\n\n// eslint-disable-next-line\nasync function generateList(type) {\n  try {\n    let query;\n    let users;\n    if (type === 'notregistered') {\n      const now = new Date();\n      // now.setDate(now.getDate() - 5);\n      query = { status: 'email sent', createdAt: { $lt: now } };\n      users = await Invite.find(query);\n\n      // const now = new Date();\n      // now.setDate(now.getDate() - 5);\n      query = { status: { $exists: false } };\n      const waitlist = await List.find(query);\n      users = [...users, ...waitlist];\n    } else if (type === 'currentUsers') {\n      const now = new Date();\n      // now.setDate(now.getDate() - 5);\n      query = { createdAt: { $lt: now } };\n      users = await User.find(query, 'email code twitterEmail twitter handle name');\n    } else if (type === 'waitlist') {\n      // const now = new Date();\n      // now.setDate(now.getDate() - 5);\n      query = { status: { $exists: false } };\n      users = await List.find(query);\n    } else if (type === 'nodigest') {\n      // const now = new Date();\n      // now.setDate(now.getDate() - 5);\n      query = { 'notificationSettings.email.digest': false };\n      users = await User.find(query, 'email code twitterEmail twitter handle name');\n      console.log('nodigest', users.length);\n    }\n\n    const list = mailgun.lists(type + '@mail.relevant.community');\n\n    users.forEach(async user => {\n      let vars = {};\n      if (type === 'notregistered') {\n        vars = { code: user.code };\n      }\n\n      // if (!user.email && !user.twitterEmail) console.log(user.toObject());\n\n      if (type === 'notregistered' || type === 'waitlist') {\n        let remove = await User.findOne({\n          $or: [{ email: user.email }, { twitterEmail: user.email }]\n        });\n        if (type === 'waitlist') {\n          remove =\n            (await Invite.findOne({ email: user.email, status: 'email sent' })) || remove;\n        }\n\n        if (remove) {\n          console.log('remove', user.email);\n          list.members(user.email).delete();\n          return;\n        }\n      }\n      // return;\n\n      const u = {\n        subscribed: true,\n        address: user.email || user.twitterEmail,\n        name:\n          type === 'notregistered' || type === 'waitlist' ? user.name : '@' + user.handle,\n        vars\n      };\n      if (u.address) {\n        u.address = u.address.trim();\n      }\n\n      console.log('handle', user.handle, u.name, u.address);\n      if (!u.address) return;\n      list.members().create(u, err => {\n        if (err) {\n          try {\n            list.members(u.address).update(u, console.log);\n          } catch (error) {\n            console.log('err updating', u);\n          }\n        }\n        // console.log\n      });\n    });\n  } catch (err) {\n    console.log(err);\n    // throw err;\n  }\n}\n\n// generateList('nodigest');\n// generateList('currentUsers');\n// generateList('notregistered');\n// generateList('waitlist');\n\n// mailgun.lists().create({\n//   address: 'test1@mail.relevant.community',\n//   name: 'test1',\n//   description: 'Users that have invites but have not registered',\n// });\n// let list = mailgun.lists('test@mail.relevant.community');\n// let slava = {\n//   subscribed: true,\n//   address: 'byslava@gmail.com',\n//   name: 'Slava',\n//   vars: { code: 'xyDFz' },\n// };\n// list.members().create(slava, err => {\n//   if (err) throw err;\n// });\n// let analisa = {\n//   subscribed: 'true',\n//   address: 'analisa@4real.io',\n//   name: 'Analisa',\n//   vars: { code: 'fsdflkj' },\n// };\n// list.members('byslava@gmail.com').update(slava, function (err, data) {\n//   // `data` is the member details\n//   console.log(data);\n//   console.log(err);\n// });\n// list.members('analisa@4real.io').update(analisa, function (err, data) {\n//   // `data` is the member details\n//   console.log(data);\n//   console.log(err);\n// });\n\n// list.members().list(function (err, members) {\n//   // `members` is the list of members\n//   console.log(members);\n// });\n\n// list.members('byslava@gmail.com').delete(function (err, body) {\n//   console.log(body);\n// });\n//\n\n// need this?\nexports.validate = function validate(req, res, next) {\n  const { body } = req;\n  if (!mailgun.validateWebhook(body.timestamp, body.token, body.signature)) {\n    res.send({ error: { message: 'Invalid signature. Are you even Mailgun?' } });\n    return;\n  }\n  next();\n};\n\nexports.index = async (req, res, next) => {\n  try {\n    const { email } = req.body;\n    let html = emailStyle + req.body.html;\n\n    html = await inlineCss(html, { url: 'https://relevant.community' });\n\n    if (!email) throw new Error('no email');\n    if (!html) throw new Error('no html');\n\n    const data = {\n      'o:tag': [req.body.campaign],\n      from: 'Relevant <info@relevant.community>',\n      to: req.body.email,\n      subject: req.body.subject,\n      html\n    };\n    const status = await sendEmail(data);\n    return res.status(200).json(status);\n  } catch (err) {\n    return next(err);\n  }\n};\n\nexports.save = async (req, res, next) => {\n  try {\n    await Email.find({}).remove();\n    const draft = new Email(req.body);\n    await draft.save();\n    return res.sendStatus(200);\n  } catch (err) {\n    return next(err);\n  }\n};\n\nexports.load = async (req, res, next) => {\n  try {\n    const email = await Email.findOne({});\n    return res.status(200).json(email);\n  } catch (err) {\n    return next(err);\n  }\n};\n"],"file":"email.controller.js"}