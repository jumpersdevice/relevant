{"version":3,"sources":["../../../src/api/invites/invite.model.js"],"names":["Schema","mongoose","InviteSchema","invitedBy","type","Types","ObjectId","ref","invitee","registeredAs","email","String","name","redeemed","Boolean","default","number","Number","status","invitedByString","code","index","url","community","communityId","timestamps","statics","checkInvite","invite","Error","findOne","_id","processInvite","invitecode","user","isNotNew","model","$ne","balance","referralRewards","Invite","publicInvite","handle","publicReward","inviter","addReward","save","populate","path","match","communityInstance","role","join","relevance","pagerank","confirmed","vote","investor","author","amount","Math","min","ownPost","updatedUser","module","exports"],"mappings":"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","sourcesContent":["import mongoose from 'mongoose';\nimport computeApproxPageRank from 'server/pagerank/computeApproxPageRank';\n\nconst { Schema } = mongoose;\n\nconst InviteSchema = new Schema(\n  {\n    invitedBy: { type: Schema.Types.ObjectId, ref: 'User' },\n    invitee: { type: Schema.Types.ObjectId, ref: 'User' },\n    registeredAs: { type: Schema.Types.ObjectId, ref: 'User' },\n    email: { type: String },\n    name: { type: String },\n    redeemed: { type: Boolean, default: false },\n    number: { type: Number, default: 1 },\n    status: { type: String },\n    invitedByString: { type: String },\n    code: { type: String, index: true },\n    url: String,\n    type: String, // referral / admin\n    community: String,\n    communityId: { type: Schema.Types.ObjectId, ref: 'Community' }\n  },\n  {\n    timestamps: true\n  }\n);\n\nInviteSchema.statics.checkInvite = async function checkInvite(invite) {\n  if (!invite) throw new Error('No invitation code found');\n  invite = await this.findOne({ _id: invite._id, redeemed: false });\n  if (!invite) throw new Error('No invitation code found');\n  return invite;\n};\n\nInviteSchema.statics.processInvite = async function processInvite({\n  invitecode,\n  user,\n  isNotNew\n}) {\n  const invite = await this.model('Invite').findOne({\n    code: invitecode,\n    redeemed: { $ne: true }\n  });\n  if (isNotNew && user.balance > 0 && invite !== 'admin') return user;\n  if (invite) return referralRewards({ invite, user, Invite: this });\n\n  const publicInvite = await this.model('User').findOne({ handle: invitecode });\n  if (publicInvite) return publicReward({ inviter: publicInvite, user, Invite: this });\n  return user;\n};\n\nasync function publicReward({ user, inviter }) {\n  await inviter.addReward({ type: 'publicLink', user });\n  return user.addReward({ type: 'publicInvite', user: inviter });\n}\n\nasync function referralRewards({ invite, user, Invite }) {\n  // InviteSchema.methods.referral = async function referral(user) {\n  const { communityId, community } = invite;\n  invite.status = 'registered';\n  invite.number -= 1;\n  if (invite.number === 0) invite.redeemed = true;\n  invite.registeredAs = user._id;\n  await invite.save();\n\n  let inviter = await Invite.model('User')\n    .findOne({ _id: invite.invitedBy })\n    .populate({\n      path: 'relevance',\n      match: { communityId }\n    });\n\n  const communityInstance = await Invite.model('Community').findOne({\n    _id: communityId\n  });\n  const role = invite.type === 'admin' ? 'admin' : null;\n  await communityInstance.join(user._id, role);\n\n  if (role === 'admin') {\n    const relevance = await Invite.model('CommunityMember').findOne({\n      user: user._id,\n      communityId\n    });\n    relevance.pagerank = 70;\n    await relevance.save();\n    user.relevance = relevance;\n    return user;\n  }\n\n  user = await user.addReward({ type: 'referredBy', user: inviter });\n  inviter = await inviter.addReward({ type: 'referral', user });\n\n  // console.log('updated relevance', updatedUser);\n  if (user.email === invite.email) user.confirmed = true;\n\n  const vote = new (Invite.model('Invest'))({\n    investor: inviter._id,\n    author: user._id,\n    amount: Math.min(1, (100 - inviter.relevance.pagerank + 50) / 100),\n    ownPost: false,\n    communityId,\n    community\n  });\n  await vote.save();\n\n  const { author: updatedUser } = await computeApproxPageRank({\n    communityId,\n    author: user,\n    vote,\n    user: inviter\n  });\n\n  return updatedUser;\n}\n\nmodule.exports = mongoose.model('Invite', InviteSchema);\n"],"file":"invite.model.js"}